# 大华多窗口播放组件集成测试

## 🎯 已完成的集成工作

### 1. SDK文件部署
- ✅ 已将大华SDK复制到 `public/dahua-sdk/` 目录
- ✅ 包含所有必要的文件：PlayerControl.js, libDecodeSDK.js, libDecodeSDK.wasm 等

### 2. 前端组件修改
- ✅ 替换了HTML5 video标签为大华SDK所需的Canvas和Video元素
- ✅ 添加了大华SDK的初始化逻辑
- ✅ 集成了播放器实例管理
- ✅ 修复了通道名称显示问题（从"通道1"改为真实名称或"通道X"）

### 3. 播放逻辑集成
- ✅ 添加了 `initDahuaSDK()` 函数来初始化SDK
- ✅ 添加了 `startPlayChannel()` 函数来播放通道
- ✅ 修改了拖拽逻辑，自动使用大华播放器播放NVR通道
- ✅ 添加了播放状态管理（loading, isPlaying等）

## 🔍 测试步骤

### 1. 启动前端应用
```bash
cd f:\work\ch_ibms\yudao-ui-admin-vue3
npm run dev
```

### 2. 访问多屏预览页面
- 打开浏览器访问：`http://localhost:3000`
- 导航到：智慧安防 > 视频监控 > 多屏预览

### 3. 检查SDK加载
打开浏览器开发者工具，查看控制台是否有以下日志：
```
[大华SDK] 开始初始化...
[大华SDK] ✅ 初始化成功
```

### 4. 测试通道名称显示
- 点击左侧 "NVR" 标签页
- 点击某个NVR设备展开通道列表
- 检查是否显示真实通道名称而不是"通道1、通道2"

### 5. 测试视频播放
- 将NVR通道拖拽到右侧视频窗口
- 检查是否显示加载状态
- 检查Canvas元素是否正确渲染

## 🐛 可能遇到的问题

### 1. SDK加载失败
**现象**：控制台显示"SDK加载失败"
**解决**：
- 检查 `public/dahua-sdk/` 目录是否存在
- 检查文件路径是否正确
- 确认所有SDK文件都已复制

### 2. 通道名称仍显示"通道1"
**现象**：左侧通道列表仍显示默认名称
**解决**：
- 检查后端API是否返回真实通道名称
- 查看控制台日志中的通道数据
- 确认后端修复已生效

### 3. 播放器初始化失败
**现象**：拖拽通道后无反应
**解决**：
- 检查 `window.PlayerControl` 是否存在
- 查看控制台错误信息
- 确认Canvas和Video元素ID正确

### 4. 网络连接问题
**现象**：播放失败或黑屏
**解决**：
- 检查NVR设备网络连通性
- 确认NVR配置（IP、用户名、密码）正确
- 测试RTSP流地址是否可访问

## 📊 预期效果

### 成功集成后应该看到：

1. **SDK初始化成功**
   ```
   [大华SDK] 开始初始化...
   [大华SDK] ✅ 初始化成功
   ```

2. **真实通道名称**
   - 左侧NVR通道列表显示真实名称
   - 例如："前门摄像头"、"后门摄像头" 而不是 "通道1"、"通道2"

3. **播放功能**
   - 拖拽通道到视频窗口时显示加载状态
   - Canvas元素正确渲染视频内容
   - 播放控制按钮正常工作

4. **状态管理**
   - 播放中的窗口有不同的边框颜色
   - 加载状态正确显示
   - 错误信息正确提示

## 🔧 调试技巧

### 1. 查看网络请求
在开发者工具的Network标签中检查：
- `/iot/video/nvr/{id}/channels` API调用
- 返回的通道数据格式
- SDK文件加载情况

### 2. 查看控制台日志
关注以下关键日志：
- `[大华SDK]` - SDK相关日志
- `[NVR刷新]` - 通道刷新日志
- `[播放器]` - 播放器相关日志
- `[通道X]` - 具体通道信息

### 3. 检查DOM元素
确认以下元素正确创建：
- `#h5_canvas_0`, `#h5_canvas_1` 等Canvas元素
- `#h5_video_0`, `#h5_video_1` 等Video元素
- `#h5_loading_0`, `#h5_loading_1` 等Loading元素

## 📝 下一步优化

如果基础功能正常，可以考虑以下优化：

1. **性能优化**
   - 优先使用子码流
   - 限制同时播放数量
   - 添加播放质量控制

2. **用户体验**
   - 添加播放进度显示
   - 支持全屏播放
   - 添加音量控制

3. **错误处理**
   - 完善错误提示信息
   - 添加重连机制
   - 支持播放失败降级

4. **功能扩展**
   - 支持录像回放
   - 集成云台控制
   - 添加截图功能

## 🎉 验收标准

集成成功的标准：
- [ ] SDK正确加载并初始化
- [ ] 通道列表显示真实名称
- [ ] 拖拽通道能触发播放
- [ ] Canvas元素正确创建
- [ ] 播放状态正确管理
- [ ] 错误信息正确显示

完成以上检查项即表示大华多窗口播放组件集成成功！

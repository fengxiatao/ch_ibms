# å½•åƒå›æ”¾åŠŸèƒ½å®æ–½æŒ‡å—

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ–¹æ¡ˆé‡‡ç”¨**æ··åˆæ¶æ„**ï¼Œç»“åˆå¤§åSDKå’ŒZLMediaKitçš„ä¼˜åŠ¿ï¼š
- **å½•åƒæŸ¥è¯¢**ï¼šä½¿ç”¨å¤§åSDKçš„ `CLIENT_QueryRecordFile` ç²¾ç¡®æŸ¥è¯¢å½•åƒæ–‡ä»¶åˆ—è¡¨
- **åœ¨çº¿æ’­æ”¾**ï¼šä½¿ç”¨ZLMediaKitå®ç°Webç«¯æµç•…æ’­æ”¾
- **å…¼å®¹å›é€€**ï¼šå½“SDKæŸ¥è¯¢å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°ZLMediaKitæ£€æŸ¥

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å¤§åSDKæœåŠ¡ç«¯æ¥å£ï¼ˆJavaï¼‰

å·²åœ¨å¤§åSDKé¡¹ç›®ä¸­æ·»åŠ ï¼š

#### `DHNetController.java` - æ–°å¢æ¥å£
```java
@RequestMapping(value = "/queryRecordFiles", method = RequestMethod.POST)
public Map<String, Object> queryRecordFiles(@RequestBody JSONObject jsonObject)
```

**æ¥å£å‚æ•°**ï¼š
```json
{
  "userName": "admin",
  "password": "admin123",
  "ip": "192.168.1.100",
  "port": 80,
  "channelId": 0,
  "startTime": "2026-01-22 00:00:00",
  "endTime": "2026-01-22 23:59:59"
}
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "channelId": 0,
      "fileName": "record_001.dav",
      "fileSize": 1024000,
      "startTime": "2026-01-22 10:00:00",
      "endTime": "2026-01-22 10:30:00",
      "recordType": 0,
      "diskNo": 0
    }
  ],
  "total": 10
}
```

#### `DHNetService.java` - æ¥å£å®šä¹‰
```java
List<Map<String, Object>> queryRecordFiles(
    String m_strIp, int m_nPort, 
    String m_strUser, String m_strPassword, 
    int nChannelID, String startTime, String endTime
);
```

#### `DHNetServiceImpl.java` - å®ç°é€»è¾‘
- ä½¿ç”¨ `CLIENT_QueryRecordFile` è°ƒç”¨å¤§åSDK
- æ”¯æŒæŸ¥è¯¢æœ€å¤š2000æ¡å½•åƒè®°å½•
- è‡ªåŠ¨è½¬æ¢æ—¶é—´æ ¼å¼
- è¿”å›æ ‡å‡†åŒ–çš„å½•åƒæ–‡ä»¶ä¿¡æ¯

### 2. å‰ç«¯APIæ¥å£ï¼ˆTypeScriptï¼‰

å·²åœ¨ `yudao-ui-admin-vue3/src/api/iot/video/index.ts` ä¸­æ·»åŠ ï¼š

```typescript
// æŸ¥è¯¢å¤§åå½•åƒæ–‡ä»¶
export const queryDahuaRecordingFiles = (params: QueryDahuaRecordingReqVO) => {
  return request.post<DahuaRecordingFileVO[]>({
    url: '/iot/camera/recording/query-dahua-files',
    data: params
  })
}
```

### 3. å‰ç«¯è°ƒç”¨é€»è¾‘ï¼ˆVueï¼‰

å·²ä¿®æ”¹ `VideoPlayback/index.vue` ä¸­çš„ `checkChannelRecording` å‡½æ•°ï¼š
- ä¼˜å…ˆä½¿ç”¨å¤§åSDKæŸ¥è¯¢ï¼ˆç²¾ç¡®ï¼‰
- å¤±è´¥æ—¶å›é€€åˆ°ZLMediaKitæ£€æŸ¥ï¼ˆå…¼å®¹ï¼‰
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

---

## ğŸ”§ å¾…å®Œæˆçš„å·¥ä½œ

### æ­¥éª¤1ï¼šè‹¥ä¾åç«¯é›†æˆå¤§åSDKæœåŠ¡

åœ¨è‹¥ä¾åç«¯é¡¹ç›®ï¼ˆruoyi-vue-proï¼‰ä¸­åˆ›å»ºControllerï¼Œè°ƒç”¨å¤§åSDKæœåŠ¡ã€‚

#### åˆ›å»ºæ–‡ä»¶ï¼š`CameraRecordingController.java`

ä½ç½®ï¼š`ruoyi-vue-pro/yudao-module-iot/yudao-module-iot-biz/src/main/java/cn/iocoder/yudao/module/iot/controller/admin/video/`

```java
package cn.iocoder.yudao.module.iot.controller.admin.video;

import cn.iocoder.yudao.framework.common.pojo.CommonResult;
import cn.iocoder.yudao.module.iot.dal.dataobject.channel.ChannelDO;
import cn.iocoder.yudao.module.iot.service.channel.ChannelService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;
import java.util.*;

import static cn.iocoder.yudao.framework.common.pojo.CommonResult.success;

@Tag(name = "ç®¡ç†åå° - æ‘„åƒå¤´å½•åƒï¼ˆå¤§åSDKï¼‰")
@RestController
@RequestMapping("/iot/camera/recording")
@Validated
@Slf4j
public class CameraRecordingDahuaController {

    @Resource
    private ChannelService channelService;
    
    @Autowired
    private RestTemplate restTemplate;
    
    // å¤§åSDKæœåŠ¡åœ°å€ï¼ˆéœ€è¦é…ç½®ï¼‰
    private static final String DAHUA_SDK_BASE_URL = "http://localhost:8080/DHNetController";

    @PostMapping("/query-dahua-files")
    @Operation(summary = "æŸ¥è¯¢å½•åƒæ–‡ä»¶åˆ—è¡¨ï¼ˆå¤§åSDKï¼‰")
    public CommonResult<List<Map<String, Object>>> queryDahuaRecordingFiles(
            @RequestBody Map<String, Object> params
    ) {
        try {
            // 1. è·å–å‚æ•°
            Integer channelId = (Integer) params.get("channelId");
            String startTime = (String) params.get("startTime");
            String endTime = (String) params.get("endTime");
            
            if (channelId == null || startTime == null || endTime == null) {
                return CommonResult.error(400, "å‚æ•°ä¸å®Œæ•´");
            }
            
            // 2. æŸ¥è¯¢é€šé“ä¿¡æ¯ï¼Œè·å–è®¾å¤‡è¿æ¥ä¿¡æ¯
            ChannelDO channel = channelService.getChannel(channelId.longValue());
            if (channel == null) {
                return CommonResult.error(404, "é€šé“ä¸å­˜åœ¨");
            }
            
            // 3. æ„å»ºå¤§åSDKè¯·æ±‚å‚æ•°
            Map<String, Object> dahuaParams = new HashMap<>();
            dahuaParams.put("userName", "admin");      // ä»è®¾å¤‡é…ç½®è·å–
            dahuaParams.put("password", "admin123");   // ä»è®¾å¤‡é…ç½®è·å–
            dahuaParams.put("ip", "192.168.1.100");    // ä»è®¾å¤‡é…ç½®è·å–
            dahuaParams.put("port", 80);               // ä»è®¾å¤‡é…ç½®è·å–
            dahuaParams.put("channelId", channel.getChannelNo()); // ä½¿ç”¨é€šé“å·
            dahuaParams.put("startTime", startTime);
            dahuaParams.put("endTime", endTime);
            
            // 4. è°ƒç”¨å¤§åSDKæœåŠ¡
            String url = DAHUA_SDK_BASE_URL + "/queryRecordFiles";
            Map<String, Object> response = restTemplate.postForObject(
                url, dahuaParams, Map.class
            );
            
            // 5. è¿”å›ç»“æœ
            if (response != null && Boolean.TRUE.equals(response.get("success"))) {
                @SuppressWarnings("unchecked")
                List<Map<String, Object>> data = (List<Map<String, Object>>) response.get("data");
                log.info("[å¤§åSDKå½•åƒæŸ¥è¯¢] é€šé“ID:{}, æŸ¥è¯¢åˆ° {} æ¡å½•åƒ", channelId, data.size());
                return success(data);
            } else {
                String msg = response != null ? (String) response.get("message") : "æœªçŸ¥é”™è¯¯";
                log.error("[å¤§åSDKå½•åƒæŸ¥è¯¢] å¤±è´¥: {}", msg);
                return CommonResult.error(500, "æŸ¥è¯¢å½•åƒå¤±è´¥: " + msg);
            }
            
        } catch (Exception e) {
            log.error("[å¤§åSDKå½•åƒæŸ¥è¯¢] å¼‚å¸¸", e);
            return CommonResult.error(500, "æŸ¥è¯¢å½•åƒå¼‚å¸¸: " + e.getMessage());
        }
    }
}
```

#### é…ç½®RestTemplateï¼ˆå¦‚æœæ²¡æœ‰ï¼‰

åœ¨ `ruoyi-vue-pro/yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/config/WebAutoConfiguration.java` ä¸­æ·»åŠ ï¼š

```java
@Bean
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

### æ­¥éª¤2ï¼šé…ç½®å¤§åSDKæœåŠ¡åœ°å€

åœ¨ `application-dev.yaml` ä¸­æ·»åŠ ï¼š

```yaml
dahua:
  sdk:
    base-url: http://localhost:8080  # å¤§åSDKæœåŠ¡åœ°å€
```

ç„¶åä¿®æ”¹Controllerä¸­çš„å¸¸é‡ï¼š

```java
@Value("${dahua.sdk.base-url}")
private String dahuaSdkBaseUrl;
```

### æ­¥éª¤3ï¼šå®Œå–„è®¾å¤‡è¿æ¥ä¿¡æ¯ç®¡ç†

å½“å‰ä»£ç ä¸­çš„è®¾å¤‡è¿æ¥ä¿¡æ¯æ˜¯ç¡¬ç¼–ç çš„ï¼Œéœ€è¦æ”¹ä¸ºä»æ•°æ®åº“è·å–ï¼š

```java
// ä»è®¾å¤‡è¡¨è·å–è¿æ¥ä¿¡æ¯
DeviceDO device = deviceService.getDevice(channel.getDeviceId());

dahuaParams.put("userName", device.getUsername());
dahuaParams.put("password", device.getPassword());
dahuaParams.put("ip", device.getIp());
dahuaParams.put("port", device.getPort());
```

### æ­¥éª¤4ï¼šå¯åŠ¨æœåŠ¡å¹¶æµ‹è¯•

1. **å¯åŠ¨å¤§åSDKæœåŠ¡**
   ```bash
   cd å¤§åæµ·åº·ä»£ç /å¤§åæµ·åº·ä»£ç /å¤§åJAVA_SDKä»£ç /MediaManagerServer
   mvn spring-boot:run
   ```

2. **å¯åŠ¨è‹¥ä¾åç«¯**
   ```bash
   cd ruoyi-vue-pro
   mvn spring-boot:run
   ```

3. **å¯åŠ¨å‰ç«¯**
   ```bash
   cd yudao-ui-admin-vue3
   npm run dev
   ```

4. **æµ‹è¯•å½•åƒæŸ¥è¯¢**
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
   - è¿›å…¥å½•åƒå›æ”¾é¡µé¢
   - æ‹–æ‹½é€šé“åˆ°çª—å£
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
     ```
     [å½•åƒæ£€æŸ¥-å¤§åSDK] é€šé“ 1 - æœ‰å½•åƒï¼Œå…± 10 ä¸ªæ–‡ä»¶
     ```

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ Vue3     â”‚
â”‚  (mpegts.js)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP API
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‹¥ä¾åç«¯       â”‚  â”€â”€â”€â”€RPCâ”€â”€â”€â–¶  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (Spring Boot)  â”‚               â”‚  å¤§åSDKæœåŠ¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  (JNA + SDK)     â”‚
         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚
         â”‚                                 â”‚ SDKè°ƒç”¨
         â”‚                                 â–¼
         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚   å¤§åè®¾å¤‡/NVR   â”‚
         â”‚                        â”‚   (å½•åƒå­˜å‚¨)     â”‚
         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ RTSP/GB28181
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ZLMediaKit     â”‚
â”‚  (æµåª’ä½“æœåŠ¡å™¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµ**ï¼š
1. å‰ç«¯è¯·æ±‚å½•åƒåˆ—è¡¨ â†’ è‹¥ä¾åç«¯ â†’ å¤§åSDKæœåŠ¡ â†’ å¤§åè®¾å¤‡
2. å‰ç«¯è¯·æ±‚æ’­æ”¾å½•åƒ â†’ è‹¥ä¾åç«¯ â†’ ZLMediaKit â†’ å¤§åè®¾å¤‡ â†’ å‰ç«¯æ’­æ”¾

---

## ğŸ¯ åŠŸèƒ½æ¸…å•

### âœ… å·²å®ç°
- [x] å¤§åSDKå½•åƒæŸ¥è¯¢æ¥å£ï¼ˆJavaï¼‰
- [x] å‰ç«¯APIå°è£…ï¼ˆTypeScriptï¼‰
- [x] å½•åƒæ£€æŸ¥é€»è¾‘ï¼ˆè‡ªåŠ¨å›é€€ï¼‰
- [x] ZLMediaKitåœ¨çº¿æ’­æ”¾
- [x] mpegts.jsæ’­æ”¾å™¨é”™è¯¯ä¿®å¤

### ğŸ”§ å¾…å®ç°
- [ ] è‹¥ä¾åç«¯Controlleré›†æˆ
- [ ] è®¾å¤‡è¿æ¥ä¿¡æ¯é…ç½®åŒ–
- [ ] RestTemplateé…ç½®
- [ ] å®Œæ•´çš„æµ‹è¯•éªŒè¯

### ğŸš€ å¯é€‰åŠŸèƒ½
- [ ] å½•åƒæ–‡ä»¶ä¸‹è½½/å¯¼å‡ºï¼ˆä½¿ç”¨ `CLIENT_DownloadByTimeEx`ï¼‰
- [ ] å½•åƒç‰‡æ®µå‰ªåˆ‡
- [ ] å½•åƒç»Ÿè®¡åˆ†æ
- [ ] å¤šè®¾å¤‡å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¤§åSDKæœåŠ¡æ— æ³•è¿æ¥ï¼Ÿ
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. å¤§åSDKæœåŠ¡æ˜¯å¦å¯åŠ¨ï¼ˆé»˜è®¤ç«¯å£8080ï¼‰
2. è‹¥ä¾åç«¯é…ç½®çš„SDKæœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®
3. é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œç«¯å£

### Q2: æŸ¥è¯¢å½•åƒè¿”å›ç©ºåˆ—è¡¨ï¼Ÿ
**A**: æ£€æŸ¥ï¼š
1. è®¾å¤‡IPã€ç«¯å£ã€è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
2. é€šé“å·æ˜¯å¦æ­£ç¡®ï¼ˆä»0å¼€å§‹ï¼‰
3. æ—¶é—´èŒƒå›´æ˜¯å¦æ­£ç¡®ï¼ˆè®¾å¤‡æ—¶é—´å¯èƒ½ä¸åŒæ­¥ï¼‰
4. è®¾å¤‡ç¡®å®æœ‰å½•åƒæ–‡ä»¶

### Q3: æ’­æ”¾å¤±è´¥ä½†æŸ¥è¯¢åˆ°å½•åƒï¼Ÿ
**A**: 
- æŸ¥è¯¢åˆ°å½•åƒæ–‡ä»¶åˆ—è¡¨ä¸ä»£è¡¨èƒ½æ’­æ”¾
- éœ€è¦ZLMediaKitæ­£ç¡®é…ç½®å¹¶è¿æ¥åˆ°è®¾å¤‡
- æ£€æŸ¥ZLMediaKitæ—¥å¿—

### Q4: å¦‚ä½•åˆ‡æ¢åˆ°çº¯ZLMediaKitæ–¹æ¡ˆï¼Ÿ
**A**: 
- ä¸è°ƒç”¨ `queryDahuaRecordingFiles`
- ç›´æ¥ä½¿ç”¨ `getPlaybackUrl` æ£€æŸ¥
- ä¿®æ”¹ `checkChannelRecording` å‡½æ•°å³å¯

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å¤§åSDKæ—¥å¿—
```bash
# æŸ¥çœ‹å¤§åSDKæœåŠ¡æ—¥å¿—
tail -f å¤§åSDKæœåŠ¡/logs/app.log
```

### å‰ç«¯è°ƒè¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
localStorage.debug = '*'

// æŸ¥çœ‹å½•åƒæŸ¥è¯¢ç»“æœ
console.log(await queryDahuaRecordingFiles({
  channelId: 1,
  startTime: '2026-01-22 00:00:00',
  endTime: '2026-01-22 23:59:59'
}))
```

### åç«¯è°ƒè¯•
åœ¨Controllerä¸­æ·»åŠ æ–­ç‚¹ï¼š
```java
@PostMapping("/query-dahua-files")
public CommonResult<List<Map<String, Object>>> queryDahuaRecordingFiles(...) {
    log.info("æ”¶åˆ°å½•åƒæŸ¥è¯¢è¯·æ±‚: {}", params);  // æ–­ç‚¹ä½ç½®
    // ...
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- å¤§åSDKå¼€å‘æ–‡æ¡£ï¼š`å¤§åæµ·åº·ä»£ç /æ–‡æ¡£/`
- ZLMediaKitæ–‡æ¡£ï¼šhttps://github.com/ZLMediaKit/ZLMediaKit
- mpegts.jsæ–‡æ¡£ï¼šhttps://github.com/xqq/mpegts.js

---

## ğŸ‘¤ è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ã€‚

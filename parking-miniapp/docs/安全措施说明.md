# 安全措施说明

本文档说明了微信支付集成中实施的安全措施。

## 概述

为了保护用户数据和防止滥用，我们实施了以下安全措施：

1. **敏感数据保护** - 确保令牌和 OpenID 不会在日志中暴露
2. **输入验证和清理** - 对充值金额进行验证和清理
3. **速率限制** - 限制支付和绑定尝试的频率
4. **安全日志记录** - 自动编辑日志中的敏感信息

## 1. 敏感数据保护

### 1.1 令牌保护

**要求**: Requirements 3.1

**实施**:
- 所有日志输出都通过 `securityService.safeLog()` 和 `securityService.safeError()` 进行过滤
- 自动检测并编辑以下模式：
  - `Bearer [token]` → `Bearer [REDACTED]`
  - `Authorization: Bearer [token]` → `Authorization: Bearer [REDACTED]`
  - 对象中的 `token` 字段 → `[REDACTED]`

**示例**:
```javascript
// 不安全的做法 ❌
console.log('Request headers:', { Authorization: 'Bearer abc123...' })

// 安全的做法 ✅
securityService.safeLog('Request headers:', { Authorization: 'Bearer abc123...' })
// 输出: Request headers: { Authorization: '[REDACTED]' }
```

### 1.2 OpenID 保护

**要求**: Requirements 3.1

**实施**:
- OpenID 值永远不会直接记录到控制台
- 自动检测并编辑以下模式：
  - `openid: [value]` → `openid: [REDACTED]`
  - 对象中的 `openid` 字段 → `[REDACTED]`

**示例**:
```javascript
// 不安全的做法 ❌
console.log('User info:', { openid: 'ox1234...' })

// 安全的做法 ✅
securityService.safeLog('User info:', { openid: 'ox1234...' })
// 输出: User info: { openid: '[REDACTED]' }
```

## 2. 输入验证和清理

### 2.1 金额验证

**要求**: Requirements 2.1

**实施**:
- 所有充值金额都通过 `securityService.validateAmount()` 进行验证
- 清理步骤：
  1. 移除所有非数字字符（除小数点外）
  2. 解析为浮点数
  3. 检查是否为有效数字
  4. 验证范围（0.01 - 10000 元）
  5. 四舍五入到 2 位小数

**示例**:
```javascript
// 验证金额
const validation = securityService.validateAmount(amount)
if (!validation.valid) {
  throw new Error(validation.error)
}
const sanitizedAmount = validation.sanitized

// 测试用例:
validateAmount('100')      // ✅ { valid: true, sanitized: 100 }
validateAmount('100.50')   // ✅ { valid: true, sanitized: 100.5 }
validateAmount('¥100')     // ✅ { valid: true, sanitized: 100 }
validateAmount('-50')      // ❌ { valid: false, error: '...' }
validateAmount('0')        // ❌ { valid: false, error: '...' }
validateAmount('abc')      // ❌ { valid: false, error: '...' }
validateAmount('99999')    // ❌ { valid: false, error: '...' }
```

### 2.2 防止注入攻击

**实施**:
- 移除所有特殊字符和脚本标签
- 仅允许数字和小数点
- 验证数值范围

## 3. 速率限制

### 3.1 支付速率限制

**要求**: Requirements 2.1, 3.1

**配置**:
- 时间窗口: 1 分钟
- 最大尝试次数: 5 次
- 超出限制后的行为: 显示错误消息并要求等待

**实施**:
```javascript
// 在支付前检查速率限制
const rateLimit = securityService.checkPaymentRateLimit()
if (!rateLimit.allowed) {
  const resetTime = securityService.formatResetTime(rateLimit.resetTime)
  throw new Error(`支付请求过于频繁，请在${resetTime}后重试`)
}

// 记录支付尝试
securityService.recordPaymentAttempt()
```

**用户体验**:
- 显示剩余尝试次数
- 显示重置时间倒计时
- 清晰的错误消息

### 3.2 绑定速率限制

**要求**: Requirements 3.1

**配置**:
- 时间窗口: 1 分钟
- 最大尝试次数: 3 次
- 超出限制后的行为: 显示错误消息并要求等待

**实施**:
```javascript
// 在绑定前检查速率限制
const rateLimit = securityService.checkBindingRateLimit()
if (!rateLimit.allowed) {
  const resetTime = securityService.formatResetTime(rateLimit.resetTime)
  throw new Error(`绑定请求过于频繁，请在${resetTime}后重试`)
}

// 记录绑定尝试
securityService.recordBindingAttempt()
```

## 4. 安全日志记录

### 4.1 自动编辑

**实施**:
- 所有日志都通过安全服务进行过滤
- 递归处理嵌套对象和数组
- 保留日志结构以便调试

**支持的数据类型**:
- 字符串: 使用正则表达式编辑
- 对象: 递归处理所有字段
- 数组: 处理每个元素
- 其他类型: 原样返回

### 4.2 敏感字段

以下字段会自动编辑：
- `token`
- `authorization`
- `openid`
- `access_token`
- `refresh_token`

### 4.3 使用方法

```javascript
// 导入安全服务
import securityService from '@/common/js/securityService.js'

// 使用安全日志
securityService.safeLog('User logged in', { 
  userId: '123',
  token: 'Bearer abc...',
  openid: 'ox123...'
})
// 输出: User logged in { userId: '123', token: '[REDACTED]', openid: '[REDACTED]' }

// 使用安全错误日志
securityService.safeError('Payment failed', {
  error: 'Network error',
  authorization: 'Bearer xyz...'
})
// 输出: Payment failed { error: 'Network error', authorization: '[REDACTED]' }
```

## 5. 集成点

### 5.1 支付服务 (paymentService.js)

**安全措施**:
- ✅ 金额验证和清理
- ✅ 支付速率限制
- ✅ 安全日志记录（编辑令牌和 OpenID）

### 5.2 微信绑定服务 (wechatBinding.js)

**安全措施**:
- ✅ 绑定速率限制
- ✅ 安全日志记录（编辑 OpenID）

### 5.3 HTTP 拦截器 (interceptor.js)

**安全措施**:
- ✅ 安全日志记录（编辑请求和响应中的令牌）
- ✅ 永不记录 Authorization 头的实际值

## 6. 测试

### 6.1 手动测试清单

- [ ] 验证日志中不包含实际的令牌值
- [ ] 验证日志中不包含实际的 OpenID 值
- [ ] 测试金额验证（有效和无效输入）
- [ ] 测试支付速率限制（连续 6 次尝试）
- [ ] 测试绑定速率限制（连续 4 次尝试）
- [ ] 验证速率限制重置（等待 1 分钟后）

### 6.2 测试用例

**金额验证测试**:
```javascript
// 有效输入
validateAmount('100')      // 应该通过
validateAmount('50.50')    // 应该通过
validateAmount('0.01')     // 应该通过（最小值）
validateAmount('10000')    // 应该通过（最大值）

// 无效输入
validateAmount('0')        // 应该失败
validateAmount('-50')      // 应该失败
validateAmount('abc')      // 应该失败
validateAmount('10001')    // 应该失败（超过最大值）
validateAmount('')         // 应该失败
```

**速率限制测试**:
```javascript
// 支付速率限制
for (let i = 0; i < 6; i++) {
  const result = securityService.checkPaymentRateLimit()
  console.log(`尝试 ${i + 1}: ${result.allowed ? '允许' : '拒绝'}`)
  if (result.allowed) {
    securityService.recordPaymentAttempt()
  }
}
// 预期: 前 5 次允许，第 6 次拒绝
```

## 7. 最佳实践

### 7.1 开发人员指南

1. **始终使用安全日志**
   ```javascript
   // ❌ 不要这样做
   console.log('Data:', sensitiveData)
   
   // ✅ 这样做
   securityService.safeLog('Data:', sensitiveData)
   ```

2. **验证所有用户输入**
   ```javascript
   // ❌ 不要这样做
   const amount = userInput
   
   // ✅ 这样做
   const validation = securityService.validateAmount(userInput)
   if (!validation.valid) {
     throw new Error(validation.error)
   }
   const amount = validation.sanitized
   ```

3. **检查速率限制**
   ```javascript
   // ✅ 在执行敏感操作前检查
   const rateLimit = securityService.checkPaymentRateLimit()
   if (!rateLimit.allowed) {
     // 显示错误消息
     return
   }
   securityService.recordPaymentAttempt()
   // 继续操作
   ```

### 7.2 代码审查清单

- [ ] 所有 `console.log` 和 `console.error` 都使用 `securityService.safeLog/safeError`
- [ ] 所有金额输入都经过验证
- [ ] 支付和绑定操作都有速率限制
- [ ] 没有直接记录令牌或 OpenID
- [ ] 错误消息不包含敏感信息

## 8. 维护

### 8.1 更新速率限制

如需调整速率限制，修改 `securityService.js` 中的配置：

```javascript
constructor() {
  this.RATE_LIMIT_WINDOW_MS = 60000 // 时间窗口（毫秒）
  this.MAX_PAYMENT_ATTEMPTS = 5     // 最大支付尝试次数
  this.MAX_BINDING_ATTEMPTS = 3     // 最大绑定尝试次数
}
```

### 8.2 添加新的敏感模式

如需编辑新的敏感数据模式，更新 `securityService.js` 中的 `SENSITIVE_PATTERNS`：

```javascript
this.SENSITIVE_PATTERNS = {
  token: /Bearer\s+[\w-]+\.[\w-]+\.[\w-]+/gi,
  openid: /openid["']?\s*[:=]\s*["']?[\w-]+/gi,
  // 添加新模式
  newPattern: /pattern_regex/gi
}
```

## 9. 故障排除

### 9.1 常见问题

**问题**: 速率限制未重置
**解决方案**: 检查系统时间是否正确，清除本地存储

**问题**: 日志中仍显示敏感数据
**解决方案**: 确保使用 `securityService.safeLog()` 而不是 `console.log()`

**问题**: 金额验证过于严格
**解决方案**: 调整 `validateAmount()` 中的范围限制

### 9.2 调试

启用调试模式查看详细的安全日志：

```javascript
// 在 securityService.js 中添加
this.DEBUG_MODE = true

// 在方法中添加调试日志
if (this.DEBUG_MODE) {
  console.log('[Security Debug]', details)
}
```

## 10. 合规性

本实施符合以下要求：

- ✅ Requirements 2.1: 金额验证
- ✅ Requirements 3.1: 令牌和 OpenID 保护
- ✅ 速率限制防止滥用
- ✅ 安全日志记录用于审计

## 11. 未来改进

考虑的增强功能：

1. **加密存储**: 在本地存储中加密敏感数据
2. **审计日志**: 将安全事件记录到后端
3. **异常检测**: 检测异常的使用模式
4. **会话管理**: 改进令牌刷新和过期处理
5. **设备指纹**: 添加设备识别以增强安全性

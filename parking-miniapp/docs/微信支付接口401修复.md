# 微信支付接口 401 错误修复

## 问题描述

调用微信支付统一下单接口时返回 401 错误:
```
Request URL: http://192.168.1.3:8881/wechat/pay/unified/request
Response: {"msg":"请求访问：/wechat/pay/unified/request，认证失败，无法访问系统资源","code":401}
```

## 原因分析

微信支付相关接口 `/wechat/pay/**` 没有添加到 Spring Security 的白名单中,导致需要认证才能访问。

但是微信支付接口通常需要在用户未登录或登录状态不稳定时也能访问,因此应该添加到白名单。

## 解决方案

### 修改 SecurityConfig

**文件**: `charging-pile/longtech-framework/src/main/java/com/longtech/framework/config/SecurityConfig.java`

**修改位置**: `configure(HttpSecurity httpSecurity)` 方法中的白名单配置

**添加配置**:
```java
.antMatchers("/wechat/pay/**").permitAll()
```

### 完整配置

```java
@Override
protected void configure(HttpSecurity httpSecurity) throws Exception {
    // ... 其他配置
    
    httpSecurity
        .authorizeRequests()
        // 对于登录login 注册register 验证码captchaImage 允许匿名访问
        .antMatchers("/login", "/register", "/captchaImage").permitAll()
        .antMatchers("/charging-pile/**").permitAll()
        .antMatchers("/record/**","/topUp/applyRefund","/chargingOrder/applyRefund").permitAll()
        .antMatchers("/user/bindWechat", "/user/wechatBinding/**", "/user/wechatLogin").permitAll()
        .antMatchers("/wechat/pay/**").permitAll()  // 新增:微信支付接口白名单
        // ... 其他配置
}
```

## 涵盖的接口

添加 `/wechat/pay/**` 到白名单后,以下所有微信支付相关接口都可以无需认证访问:

- `/wechat/pay/unified/request` - 统一下单
- `/wechat/pay/notify` - 支付回调通知
- `/wechat/pay/refund_notify` - 退款回调通知
- `/wechat/pay/query` - 查询订单(如果有)
- 其他所有 `/wechat/pay/` 开头的接口

## 部署步骤

1. **修改代码**: 已完成 ✅
2. **重启后端服务**: ⚠️ 必须重启才能生效
3. **测试接口**: 确认不再返回 401 错误

## 安全考虑

### 为什么微信支付接口可以放在白名单?

1. **微信回调需要**: 微信支付回调 `/wechat/pay/notify` 是微信服务器调用的,不会携带用户 token
2. **业务逻辑保护**: 虽然接口不需要认证,但业务逻辑中会验证:
   - 订单归属
   - 支付签名
   - 订单状态
   - 金额校验
3. **用户体验**: 支付流程中可能出现登录状态失效,白名单可以避免支付中断

### 安全措施

即使接口在白名单中,后端仍然需要:
- 验证微信支付签名
- 验证订单归属和状态
- 防止重复支付
- 记录所有支付操作日志

## 测试验证

### 测试步骤

1. 重启后端服务
2. 在小程序中进行充值操作
3. 观察网络请求,确认 `/wechat/pay/unified/request` 不再返回 401
4. 完成支付流程,确认回调正常

### 预期结果

- ✅ 统一下单接口返回 200 或业务错误(非 401)
- ✅ 支付流程可以正常进行
- ✅ 微信回调可以正常接收

## 相关文档

- [微信快速登录 401 问题排查](./微信快速登录401问题排查.md)
- [微信支付集成实现说明](./微信支付集成实现说明.md)
- [后端API实现完成](./后端API实现完成.md)

## 修复时间

2026-01-01

## 注意事项

⚠️ **必须重启后端服务才能使配置生效!**

如果重启后仍然有问题,请检查:
1. SecurityConfig 文件是否正确保存
2. 后端服务是否完全重启
3. 是否有其他 SecurityConfig 配置覆盖了这个设置

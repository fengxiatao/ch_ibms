# 错误处理机制说明

## 概述

本文档说明了充电桩小程序中实现的综合错误处理机制，涵盖了所有主要的错误场景和恢复流程。

## 错误类型

### 1. 401 认证错误 (Requirement 5.1)

**触发场景：**
- Token 过期或无效
- 未授权的 API 请求

**处理流程：**
1. 检测到 401 错误（HTTP 状态码或响应体中的 code）
2. 保存当前支付意图（如果存在）
3. 显示提示消息："认证失败，请重新登录"
4. 清除本地存储（保留支付意图）
5. 1.5 秒后重定向到登录页面
6. 登录成功后可恢复支付流程

**实现位置：**
- `common/http/interceptor.js` - HTTP 拦截器中的 `handleAuthenticationError()`
- `common/js/errorRecovery.js` - `handle401Error()` 方法
- `common/js/paymentService.js` - 支付服务中的 401 处理

**日志记录：**
```javascript
console.error('[HTTP Error] 401 Authentication failed:', data)
console.log('[Error Handler] Handling 401 authentication error')
```

### 2. 999 重复充值错误 (Requirement 5.2)

**触发场景：**
- 用户尝试重复充值同一订单

**处理流程：**
1. 检测到 999 错误码
2. 显示后端返回的错误消息
3. 允许用户关闭提示并重试

**实现位置：**
- `common/http/interceptor.js` - `handleDuplicateRechargeError()`
- `common/js/paymentService.js` - 支付服务中的 999 处理

**日志记录：**
```javascript
console.error('[HTTP Error] 999 Duplicate recharge:', data)
console.log('[Error Handler] Handling 999 duplicate recharge error')
```

### 3. 微信 API 错误 (Requirements 5.3, 5.4)

#### 3.1 wx.login() 失败

**触发场景：**
- 微信登录授权失败
- 网络问题导致登录失败

**处理流程：**
1. 捕获 wx.login() 的 fail 回调
2. 调用 `handleWechatApiError()` 统一处理
3. 显示错误消息："微信登录失败，请重试"
4. 提供重试选项

**实现位置：**
- `common/http/interceptor.js` - `handleWechatApiError()` 导出函数
- `common/js/paymentService.js` - 支付流程中的 wx.login 错误处理
- `common/js/wechatBinding.js` - 绑定流程中的 wx.login 错误处理

**日志记录：**
```javascript
console.error('[WeChat API Error] wx.login failed:', errorResult)
console.error('[Payment Error] wx.login failed:', errorResult)
console.error('[Binding Error] wx.login failed:', errorResult)
```

#### 3.2 wx.requestPayment() 失败

**触发场景：**
- 用户取消支付
- 支付参数错误
- 微信支付系统错误

**处理流程：**
1. 捕获 wx.requestPayment() 的 fail 回调
2. 调用 `handleWechatApiError()` 统一处理
3. 区分取消和错误：
   - 取消：显示"支付已取消"
   - 错误：显示具体错误消息
4. 提供重试选项

**实现位置：**
- `common/http/interceptor.js` - `handleWechatApiError()`
- `common/js/paymentService.js` - wx.requestPayment 错误处理

**日志记录：**
```javascript
console.error('[WeChat API Error] wx.requestPayment failed:', errorResult)
console.error('[Payment Error] wx.requestPayment failed:', errorResult)
```

### 4. 网络错误 (Requirement 5.5)

**触发场景：**
- 网络连接断开
- 请求超时
- DNS 解析失败

**处理流程：**
1. 检测网络错误（errMsg 包含 'network', 'timeout', 'fail'）
2. 显示错误消息："网络错误，请检查网络连接"
3. 提供重试机制（最多 2 次）
4. 使用指数退避策略

**实现位置：**
- `common/http/interceptor.js` - `handleNetworkError()` 和 fail 拦截器
- `common/js/errorRecovery.js` - `handleNetworkError()` 方法
- `common/js/paymentService.js` - 支付 API 调用的网络错误处理

**日志记录：**
```javascript
console.error('[HTTP Network Error]', { error, timestamp })
console.log('[Error Handler] Handling network error:', error)
```

### 5. 支付超时 (Requirement 5.5)

**触发场景：**
- 支付请求超过 5 分钟未完成

**处理流程：**
1. 启动 5 分钟超时计时器
2. 超时后显示选项对话框：
   - "查询状态"：联系客服查询
   - "重新支付"：重试支付流程
3. 清除超时追踪器

**实现位置：**
- `common/js/errorRecovery.js` - `handlePaymentTimeout()` 方法
- `common/js/paymentService.js` - 支付流程中的超时处理

**日志记录：**
```javascript
console.log('[Payment Timeout] Payment timed out')
```

## 错误恢复流程

### 1. 支付意图恢复

**场景：** Token 过期导致支付失败

**流程：**
```
用户发起支付
  → Token 验证失败 (401)
  → 保存支付意图 (金额, 用户ID, 时间戳)
  → 重定向到登录页
  → 用户登录成功
  → 检测到待恢复的支付意图
  → 显示恢复对话框
  → 用户确认后继续支付
```

**实现：**
- `errorRecovery.savePaymentIntent()` - 保存意图
- `errorRecovery.getPaymentIntent()` - 获取意图
- `errorRecovery.hasPendingPaymentIntent()` - 检查是否有待恢复意图
- `preTopUp.vue` - `checkPendingPaymentIntent()` 方法

### 2. 绑定重试机制

**场景：** 微信绑定失败

**流程：**
```
用户发起绑定
  → wx.login() 失败
  → 显示重试对话框
  → 用户点击重试
  → 重新执行绑定流程
  → 最多重试 3 次
  → 达到上限后提示联系客服
```

**实现：**
- `errorRecovery.handleBindingFailure()` - 处理绑定失败
- `errorRecovery.incrementBindingRetry()` - 增加重试计数
- `errorRecovery.isBindingRetryLimitReached()` - 检查是否达到上限
- `wechatBinding.bindWechatWithRetry()` - 带重试的绑定方法

### 3. 网络错误重试

**场景：** 网络请求失败

**流程：**
```
API 请求失败
  → 检测到网络错误
  → 显示重试对话框
  → 用户点击重试
  → 重新执行请求
  → 最多重试 2 次
  → 达到上限后显示最终错误
```

**实现：**
- `errorRecovery.handleNetworkError()` - 处理网络错误
- `paymentService.recharge()` - 支付中的网络错误处理

## 日志记录 (Requirement 7.4)

### 日志格式

所有日志都包含以下信息：
- 日志类型标签（如 `[HTTP Request]`, `[Payment Error]`）
- 相关数据（请求参数、错误信息等）
- 时间戳（ISO 8601 格式）

### 日志级别

1. **请求日志：**
```javascript
console.log('[HTTP Request]', {
  url: config.url,
  method: config.method,
  params: config.params,
  timestamp: new Date().toISOString()
})
```

2. **响应日志：**
```javascript
console.log('[HTTP Response]', {
  url: res.config?.url,
  statusCode: res.statusCode,
  data: res.data,
  timestamp: new Date().toISOString()
})
```

3. **错误日志：**
```javascript
console.error('[HTTP Error] 401 Authentication failed:', data)
console.error('[Payment Error] Payment API error:', error)
console.error('[Binding Error] wx.login failed:', errorResult)
```

4. **成功日志：**
```javascript
console.log('[Payment Success]', payRes)
console.log('[Binding Success]', { userId, timestamp })
```

### 日志位置

- **HTTP 拦截器：** `common/http/interceptor.js`
  - 所有 HTTP 请求和响应
  - 认证错误、重复充值错误
  - 网络错误

- **支付服务：** `common/js/paymentService.js`
  - 支付请求、成功、失败
  - 余额查询
  - 充值记录查询

- **绑定服务：** `common/js/wechatBinding.js`
  - 绑定检查、请求、成功、失败
  - OpenID 查询

- **错误恢复：** `common/js/errorRecovery.js`
  - 支付意图保存和恢复
  - 重试机制

## 响应验证 (Requirement 7.5)

### 验证规则

1. **响应结构验证：**
```javascript
if (!data || typeof data !== 'object') {
  console.error('[HTTP Error] Invalid response structure:', res)
  vm.$u.toast('响应数据格式错误')
  return false
}
```

2. **支付参数验证：**
```javascript
if (!response.timeStamp || !response.nonceStr || !response.packageValue) {
  console.error('[Payment Error] Invalid payment parameters:', response)
  reject({
    code: -1,
    message: '支付参数错误'
  })
  return
}
```

3. **业务逻辑验证：**
- 检查 response.code 是否为预期值
- 验证必需字段是否存在
- 验证数据类型是否正确

## 用户体验优化

### 1. 友好的错误消息

所有错误都显示用户友好的中文消息：
- ❌ "Request failed" → ✅ "请求失败，请重试"
- ❌ "401 Unauthorized" → ✅ "认证失败，请重新登录"
- ❌ "Network error" → ✅ "网络错误，请检查网络连接"

### 2. 重试机制

为可恢复的错误提供重试选项：
- 网络错误：自动重试 2 次
- 绑定失败：手动重试 3 次
- 支付超时：提供查询状态或重试选项

### 3. 状态保持

在错误恢复过程中保持用户状态：
- 保存支付意图
- 保留用户输入
- 缓存余额数据

### 4. 加载状态

在处理过程中显示加载指示器：
```javascript
uni.showLoading({
  title: '支付处理中...',
  mask: true
})
```

## 测试建议

### 1. 单元测试

测试各个错误处理函数：
- `handleAuthenticationError()`
- `handleDuplicateRechargeError()`
- `handleWechatApiError()`
- `handleNetworkError()`

### 2. 集成测试

测试完整的错误恢复流程：
- 401 错误后的支付意图恢复
- 绑定失败的重试机制
- 网络错误的自动重试

### 3. 手动测试场景

1. **401 错误测试：**
   - 使用过期 token 发起支付
   - 验证重定向到登录页
   - 登录后验证支付意图恢复

2. **网络错误测试：**
   - 断开网络连接
   - 发起支付请求
   - 验证重试对话框显示
   - 恢复网络后重试

3. **微信 API 错误测试：**
   - 模拟 wx.login() 失败
   - 模拟 wx.requestPayment() 取消
   - 验证错误消息显示

4. **支付超时测试：**
   - 模拟长时间无响应
   - 验证超时对话框显示
   - 测试查询状态和重试选项

## 维护指南

### 添加新的错误类型

1. 在 `interceptor.js` 中添加错误处理函数
2. 在相关服务中调用错误处理函数
3. 添加适当的日志记录
4. 更新本文档

### 修改错误消息

所有错误消息都集中在各个错误处理函数中，便于统一修改和国际化。

### 调整重试策略

重试次数和超时时间在 `errorRecovery.js` 中定义：
```javascript
this.MAX_RETRY_COUNT = 3
this.PAYMENT_TIMEOUT_MS = 300000 // 5 minutes
```

## 总结

本错误处理机制提供了：
- ✅ 全面的错误类型覆盖
- ✅ 智能的错误恢复流程
- ✅ 详细的日志记录
- ✅ 友好的用户体验
- ✅ 可维护的代码结构

所有错误都被妥善处理，用户在遇到问题时能够得到清晰的提示和恢复选项。

# 充值功能说明

## 功能概述

在"我的"页面添加了微信支付充值功能，用户可以通过微信支付为账户充值。

## 已实现的功能

### 1. 我的页面 (my.vue)

**新增内容**:
- ✅ 添加了"立即充值"按钮
- ✅ 点击按钮跳转到充值页面
- ✅ 显示当前账户余额

**UI 设计**:
- 渐变色按钮（红色系）
- 带图标和文字
- 阴影效果，提升视觉层次

### 2. 充值页面 (preTopUp.vue)

**已有功能**:
- ✅ 预设充值金额选项（30元、50元、100元、200元）
- ✅ 自定义输入充值金额
- ✅ 微信支付集成
- ✅ 支付成功后返回上一页

**支付流程**:
1. 用户选择或输入充值金额
2. 点击"确认支付"
3. 调用微信登录获取 code
4. 调用后端接口 `/wechat/pay/unified/request` 获取支付参数
5. 调用微信支付 API `wx.requestPayment`
6. 支付成功后返回"我的"页面

## 技术实现

### API 接口

**充值支付接口**:
```javascript
POST /wechat/pay/unified/request
参数:
{
  code: string,      // 微信登录 code
  money: number,     // 充值金额
  userId: string     // 用户 ID
}
```

**查询余额接口**:
```javascript
GET /record/accountMoney/{userId}?userId={userId}
```

### 微信支付参数

后端返回的支付参数:
```javascript
{
  timeStamp: string,
  nonceStr: string,
  packageValue: string,  // 注意：后端返回的字段名
  signType: string,
  paySign: string
}
```

## 使用说明

### 用户操作流程

1. **进入我的页面**
   - 查看当前账户余额

2. **点击"立即充值"按钮**
   - 跳转到充值页面

3. **选择充值金额**
   - 方式一：点击预设金额（30/50/100/200元）
   - 方式二：手动输入自定义金额

4. **确认支付**
   - 点击"确认支付"按钮
   - 调起微信支付
   - 完成支付

5. **支付完成**
   - 自动返回"我的"页面
   - 余额自动更新

## 注意事项

### 1. 微信小程序配置

需要在微信小程序后台配置:
- **支付功能**: 开通微信支付商户号
- **合法域名**: 添加后端域名到 request 合法域名
  - `https://sanligz.com.cn`

### 2. 后端要求

后端需要实现:
- 微信支付统一下单接口
- 支付回调处理
- 账户余额更新
- 充值记录保存

### 3. 测试建议

**开发环境测试**:
1. 使用微信开发者工具的"真机调试"功能
2. 使用测试账号进行小额充值测试
3. 验证支付成功后余额是否正确更新

**生产环境上线前**:
1. 确认微信支付商户号已配置
2. 测试完整的支付流程
3. 测试支付失败的处理
4. 测试网络异常的处理

## 可选优化建议

### 1. 充值记录页面优化

在充值记录页面 (recharge-record.vue) 可以添加:
- 充值时间
- 充值金额
- 支付方式
- 订单状态
- 退款功能（如需要）

### 2. 余额变动提醒

- 充值成功后显示 Toast 提示
- 余额变动动画效果
- 充值成功后刷新余额

### 3. 充值优惠

- 充值满额赠送
- 首次充值优惠
- 充值档位优惠（如充100送10）

### 4. 安全性增强

- 添加支付密码验证
- 限制单次充值金额上限
- 添加充值频率限制
- 记录充值 IP 和设备信息

## 相关文件

- `package/chargingPile/my/my.vue` - 我的页面
- `package/chargingPile/preTopUp.vue` - 充值页面
- `package/chargingPile/recharge-record/recharge-record.vue` - 充值记录页面
- `common/http/URL.js` - API 接口配置

## 常见问题

### Q1: 支付失败怎么办？

**可能原因**:
1. 微信支付未配置或配置错误
2. 后端接口返回参数不正确
3. 用户取消支付
4. 网络问题

**解决方法**:
- 检查微信支付商户号配置
- 查看后端日志确认接口返回
- 添加支付失败的错误提示

### Q2: 余额不更新？

**可能原因**:
1. 支付成功但后端未更新余额
2. 前端未刷新余额数据

**解决方法**:
- 在 `onShow` 生命周期中刷新余额
- 支付成功后手动调用 `getMyMoney()` 方法

### Q3: 如何测试微信支付？

**测试方法**:
1. 使用微信开发者工具的"真机调试"
2. 使用测试商户号（如果有）
3. 使用小额金额测试（如 0.01 元）

## 更新日志

### 2024-12-31
- ✅ 在"我的"页面添加"立即充值"按钮
- ✅ 实现跳转到充值页面功能
- ✅ 优化充值按钮 UI 设计
- ✅ 添加充值功能文档


---

## 问题排查与解决 (2024-12-31)

### 问题: 401 认证失败

**错误信息**:
```
{msg: "请求访问：/wechat/pay/unified/request，认证失败，无法访问系统资源", code: 401}
```

**原因分析**:
1. 请求未正确携带 Token
2. Token 格式不正确（缺少 `Bearer ` 前缀）
3. 请求头中缺少必要的认证信息

**解决方案**:

修改 `common/http/interceptor.js` 中的请求拦截器:

```javascript
// 请求拦截部分
Vue.prototype.$u.http.interceptor.request = (config) => {
	const token = uni.getStorageSync('token');

	// 设置请求头，保留 clientId 和 clientSecret
	config.header = {
		'clientId': 'app',
		'clientSecret': 'app'
	};

	// 如果有 token，添加 Authorization 头
	if (token && token != '') {
		// 检查 token 是否已经包含 Bearer 前缀
		const authToken = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
		config.header['Authorization'] = authToken;
	}
	
	return config;
}
```

**关键改进**:
1. ✅ 保留了 `clientId` 和 `clientSecret` 头信息
2. ✅ 添加了 `Bearer ` 前缀到 Token
3. ✅ 检查 Token 是否已包含前缀，避免重复添加
4. ✅ 确保所有请求都携带必要的认证信息

### 后端接口确认

**后端实现位置**:
- Controller: `charging-pile/longtech-charging-pile/src/main/java/com/longtech/charging/controller/WechatController.java`
- Service: `charging-pile/longtech-charging-pile/src/main/java/com/longtech/charging/service/impl/BizWechatPayServiceImpl.java`

**接口信息**:
```java
@RestController
@RequestMapping("/wechat/pay")
public class WechatController {
    
    @RequestMapping(value = "/unified/request", method = RequestMethod.POST)
    @ApiOperation(value = "预充值")
    public Object appPayUnifiedRequest(@RequestBody Map<String,Object> params) {
        // 创建微信支付订单
        String outTradeNo = OrderNoUtil.getOrder();
        Object createOrderResult = wechatPayService.createOrder("测试充电桩支付", outTradeNo, params);
        return createOrderResult;
    }
}
```

**请求参数**:
```javascript
{
  code: string,      // 微信登录 code
  money: number,     // 充值金额
  userId: string     // 用户 ID
}
```

**响应参数**:
```javascript
{
  timeStamp: string,
  nonceStr: string,
  packageValue: string,  // 注意字段名
  signType: string,
  paySign: string
}
```

### 测试步骤

1. **确保已登录**
   - 检查 Storage 中是否有 token
   - 确认 token 格式正确

2. **测试充值接口**
   - 打开"我的"页面
   - 点击"立即充值"
   - 选择充值金额
   - 点击"确认支付"

3. **检查请求**
   - 打开开发者工具 Network 面板
   - 查看请求头是否包含:
     - `clientId: app`
     - `clientSecret: app`
     - `Authorization: Bearer <token>`

4. **验证支付流程**
   - 确认微信支付弹窗正常显示
   - 完成支付
   - 检查余额是否更新

### 常见问题补充

**Q: 为什么需要 Bearer 前缀？**

A: Bearer 是 OAuth 2.0 的标准认证方式，后端通常期望 Token 格式为 `Bearer <token>`。

**Q: clientId 和 clientSecret 的作用？**

A: 这是应用级别的认证信息，用于标识请求来自哪个客户端应用。

**Q: 如何调试认证问题？**

A: 
1. 在拦截器中添加 `console.log(config.header)` 查看请求头
2. 检查 Storage 中的 token 是否存在
3. 使用 Postman 测试后端接口是否正常

### 后续优化建议

1. **错误提示优化**
   - 401 错误时显示友好提示
   - 自动跳转到登录页
   - 保存当前页面路径，登录后返回

2. **Token 刷新机制**
   - Token 过期自动刷新
   - 刷新失败跳转登录

3. **支付状态轮询**
   - 支付成功后轮询订单状态
   - 确保余额及时更新
   - 处理支付超时情况

# 微信快速登录 401 问题排查

## 问题描述

### 问题 1: 401 认证失败 (已解决)
调用 `/user/wechatLogin` 接口时返回 401 错误:
```json
{
  "msg": "请求访问：/user/wechatLogin，认证失败，无法访问系统资源",
  "code": 401
}
```

**解决方案**: 重启后端服务使 SecurityConfig 白名单配置生效。

### 问题 2: 500 参数缺失 (已解决)
调用 `/user/wechatLogin` 接口时返回 500 错误:
```json
{
  "msg": "Required request parameter 'code' for method parameter type String is not present",
  "code": 500
}
```

**原因**: 前端将 `code` 作为 request body 发送,但后端期望作为 query parameter 接收。

**解决方案**: 修改前端代码,将 `code` 作为 URL 查询参数发送。

## 修复详情

### 前端修复

**文件**: `ismart-chargingPile-miniapp/common/js/wechatBinding.js`

**修改前**:
```javascript
uni.$u.api.POST('/user/wechatLogin', { code: loginRes.code })
```

**修改后**:
```javascript
uni.$u.api.POST(`/user/wechatLogin?code=${loginRes.code}`)
```

### 后端接口定义

**文件**: `charging-pile/longtech-charging-pile/src/main/java/com/longtech/charging/controller/UserController.java`

```java
@PostMapping("/wechatLogin")
@ApiOperation(value = "微信快速登录")
public AjaxResult wechatLogin(@RequestParam String code) {
    // ...
}
```

注意 `@RequestParam` 注解表示参数从 URL 查询字符串中获取,而不是从 request body 中获取。

## 原因分析

401 错误表示该接口需要认证,但我们希望它是公开接口(无需登录即可访问)。

## 解决方案

### 1. 确认 SecurityConfig 配置

检查 `charging-pile/longtech-framework/src/main/java/com/longtech/framework/config/SecurityConfig.java` 文件,确保以下配置存在:

```java
@Override
protected void configure(HttpSecurity httpSecurity) throws Exception {
    // ... 其他配置
    
    httpSecurity
        .authorizeRequests()
        // 微信相关接口允许匿名访问
        .antMatchers("/user/bindWechat", "/user/wechatBinding/**", "/user/wechatLogin").permitAll()
        // ... 其他配置
}
```

**重要**: 确保这行配置在 `.anyRequest().authenticated()` 之前!

### 2. 重启后端服务

Spring Security 配置需要重启服务才能生效。

**步骤**:
1. 停止后端服务
2. 重新启动后端服务
3. 等待服务完全启动
4. 再次测试接口

### 3. 验证配置是否生效

重启后,查看后端日志,确认:
- 服务启动成功
- 没有 Spring Security 相关的错误
- SecurityConfig 被正确加载

### 4. 测试接口

使用以下方式测试接口是否可以访问:

#### 方式 1: 使用 Postman 或 curl
```bash
curl -X POST http://192.168.1.3:8881/user/wechatLogin \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code"}'
```

预期结果:
- 不应该返回 401 错误
- 应该返回业务逻辑的响应(可能是获取 openid 失败,但不是认证失败)

#### 方式 2: 在小程序中测试
点击"微信快速登录"按钮,查看网络请求。

## 常见问题

### Q1: 配置正确但仍然返回 401

**可能原因**:
1. 后端服务没有重启
2. 配置文件被缓存
3. 有多个 SecurityConfig 配置类冲突

**解决方法**:
1. 完全停止后端服务
2. 清理编译缓存: `mvn clean`
3. 重新编译: `mvn compile`
4. 重新启动服务

### Q2: 其他接口也返回 401

**可能原因**:
SecurityConfig 配置有语法错误或逻辑错误。

**解决方法**:
检查 SecurityConfig 文件,确保:
- 所有括号匹配
- 配置顺序正确
- 没有语法错误

### Q3: 白名单配置的顺序重要吗?

**是的!** Spring Security 按顺序匹配规则。

**正确的顺序**:
```java
.authorizeRequests()
    // 1. 先配置具体的路径
    .antMatchers("/login", "/register").permitAll()
    .antMatchers("/user/bindWechat", "/user/wechatLogin").permitAll()
    
    // 2. 再配置通配符路径
    .antMatchers("/charging-pile/**").permitAll()
    
    // 3. 最后配置 anyRequest
    .anyRequest().authenticated()
```

## 验证清单

在确认问题解决前,请检查:

- [ ] SecurityConfig 文件中包含 `/user/wechatLogin` 的 permitAll 配置
- [ ] 配置在 `.anyRequest().authenticated()` 之前
- [ ] 后端服务已重启
- [ ] 服务启动日志没有错误
- [ ] 使用 Postman 测试接口不返回 401
- [ ] 小程序中测试功能正常

## 当前配置状态

### SecurityConfig.java (第 119 行)
```java
.antMatchers("/user/bindWechat", "/user/wechatBinding/**", "/user/wechatLogin").permitAll()
```

✅ 配置已正确添加

### 下一步操作

**请重启后端服务,然后再次测试!**

如果重启后仍然有问题,请提供:
1. 完整的后端启动日志
2. 接口调用时的完整错误日志
3. SecurityConfig 文件的完整内容

## 相关文档

- [微信快速登录功能完成](./微信快速登录功能完成.md)
- [后端API实现完成](./后端API实现完成.md)
- [微信配置修复说明](./微信配置修复说明.md)

# 微信配置修复说明

## 问题描述

在测试微信绑定功能时,后端日志显示所有配置值都是 `null`:

```
微信获取openid的url: null?appid=null&secret=null&js_code=...&grant_type=null
```

## 问题原因

1. **配置前缀不匹配**: 
   - `WechatPayConfig` 类使用 `@ConfigurationProperties(prefix = "wxpay")`
   - 但 YAML 配置文件中只有 `wx.miniapp` 配置,没有 `wxpay` 配置

2. **字段名不规范**:
   - 配置类中使用了 `SessionKeyUrl` (大写 S)
   - 应该使用 `sessionKeyUrl` (小写 s) 符合 Java 命名规范

3. **缺少 @Component 注解**:
   - `WechatPayConfig` 类没有被 Spring 容器管理

## 修复内容

### 1. 修改 WechatPayConfig.java

**文件**: `charging-pile/longtech-charging-pile/src/main/java/com/longtech/config/WechatPayConfig.java`

**修改内容**:
- 添加 `@Component` 注解
- 将 `SessionKeyUrl` 改为 `sessionKeyUrl`

```java
@Data
@Component
@ConfigurationProperties(prefix = "wxpay")
public class WechatPayConfig {
    private String appId;
    private String mchId;
    private String mchKey;
    private String keyPath;
    private String privateKeyPath;
    private String privateCertPath;
    private String payNotifyUrl;
    private String refundNotifyUrl;
    private String secret;
    private String grantType;
    private String sessionKeyUrl;  // 改为小写开头
}
```

### 2. 添加 wxpay 配置

在以下三个配置文件中添加了 `wxpay` 配置:

#### application-prod.yml

```yaml
wxpay:
    app-id: wxa5b28f4f32f9cb01
    secret: 49019d5a9be4ccc8fb5e321897b11a16
    session-key-url: https://api.weixin.qq.com/sns/jscode2session
    grant-type: authorization_code
    mch-id: 你的商户号
    mch-key: 你的商户密钥
    pay-notify-url: https://sanligz.com.cn/wechat/pay/notify
    refund-notify-url: https://sanligz.com.cn/wechat/pay/refund_notify
```

#### application-dev.yml

```yaml
wxpay:
    app-id: wxa5b28f4f32f9cb01
    secret: 49019d5a9be4ccc8fb5e321897b11a16
    session-key-url: https://api.weixin.qq.com/sns/jscode2session
    grant-type: authorization_code
    mch-id: 你的商户号
    mch-key: 你的商户密钥
    pay-notify-url: http://47.106.206.167/wechat/pay/notify
    refund-notify-url: http://47.106.206.167/wechat/pay/refund_notify
```

#### application-local.yml

```yaml
wxpay:
    app-id: wxa5b28f4f32f9cb01
    secret: 49019d5a9be4ccc8fb5e321897b11a16
    session-key-url: https://api.weixin.qq.com/sns/jscode2session
    grant-type: authorization_code
    mch-id: 你的商户号
    mch-key: 你的商户密钥
    pay-notify-url: http://192.168.1.170/wechat/pay/notify
    refund-notify-url: http://192.168.1.170/wechat/pay/refund_notify
```

## 配置说明

### 必填配置

- **app-id**: 微信小程序 AppID
- **secret**: 微信小程序 AppSecret
- **session-key-url**: 微信 jscode2session API 地址 (固定值)
- **grant-type**: 授权类型 (固定值: authorization_code)

### 支付相关配置 (如需使用微信支付)

- **mch-id**: 微信商户号
- **mch-key**: 微信商户密钥
- **pay-notify-url**: 支付回调通知 URL
- **refund-notify-url**: 退款回调通知 URL

## 注意事项

1. **商户号配置**: 
   - 配置文件中的 `mch-id` 和 `mch-key` 需要替换为实际的商户号和密钥
   - 如果还没有申请微信支付,可以暂时保留占位符

2. **回调 URL**:
   - 回调 URL 必须是外网可访问的地址
   - 需要在微信商户平台配置白名单

3. **环境配置**:
   - 当前激活的是 `prod` 环境 (在 `application.yml` 中配置)
   - 如果要切换环境,修改 `spring.profiles.active` 的值

4. **重启服务**:
   - 修改配置后需要重启后端服务才能生效

## 验证方法

重启服务后,再次测试微信绑定功能,日志应该显示:

```
微信获取openid的url: https://api.weixin.qq.com/sns/jscode2session?appid=wxa5b28f4f32f9cb01&secret=49019d5a9be4ccc8fb5e321897b11a16&js_code=...&grant_type=authorization_code
```

如果配置正确,应该能成功获取 openid 并完成绑定。

## 相关文档

- 后端 API 实现: `ismart-chargingPile-miniapp/docs/后端API实现完成.md`
- 微信官方文档: https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html

# 错误恢复机制说明

## 概述

本文档描述了微信支付集成中实现的错误恢复机制，包括支付意图恢复、绑定失败重试、支付超时处理和重试按钮功能。

## 功能特性

### 1. 支付意图恢复（Token过期恢复）

**场景**：用户在支付过程中遇到401认证失败（token过期），需要重新登录。

**实现**：
- 当检测到401错误时，系统自动保存当前的支付意图（金额、用户ID、时间戳）
- 用户重新登录后，系统检测到未完成的支付意图
- 弹出对话框询问用户是否继续支付
- 用户确认后自动恢复支付流程

**代码位置**：
- `common/js/errorRecovery.js` - `savePaymentIntent()`, `getPaymentIntent()`, `handle401Error()`
- `common/js/paymentService.js` - 401错误处理
- `package/chargingPile/preTopUp.vue` - `checkPendingPaymentIntent()`
- `pages/login/login.vue` - 登录成功后检查待恢复支付

**使用示例**：
```javascript
// 在支付失败时保存意图
errorRecovery.handle401Error({
  amount: 100,
  userId: 'user123',
  timestamp: Date.now()
})

// 在登录后或页面加载时检查
if (errorRecovery.hasPendingPaymentIntent()) {
  const intent = errorRecovery.getPaymentIntent()
  // 显示恢复对话框
}
```

**限制**：
- 支付意图有效期：5分钟
- 最大重试次数：3次
- 超过限制后自动清除意图

### 2. 绑定失败重试机制

**场景**：用户尝试绑定微信账号时失败（网络问题、微信API错误等）。

**实现**：
- 绑定失败时自动弹出重试对话框
- 显示当前重试次数（如：1/3）
- 用户可选择重试或取消
- 达到最大重试次数后提示联系客服
- 绑定成功后自动重置重试计数

**代码位置**：
- `common/js/errorRecovery.js` - `handleBindingFailure()`, `incrementBindingRetry()`
- `common/js/wechatBinding.js` - `bindWechatWithRetry()`
- `package/chargingPile/my/my.vue` - 使用重试机制
- `package/chargingPile/preTopUp.vue` - 使用重试机制

**使用示例**：
```javascript
// 使用带重试的绑定方法
try {
  const result = await wechatBindingService.bindWechatWithRetry(userId)
  // 绑定成功
} catch (error) {
  // 错误已被重试机制处理
  if (error.message === '用户取消绑定') {
    // 用户主动取消
  } else if (error.message === '绑定重试次数已达上限') {
    // 达到重试上限
  }
}
```

**限制**：
- 最大重试次数：3次
- 重试计数在绑定成功后自动重置

### 3. 支付超时处理

**场景**：支付请求发出后长时间没有响应（超过5分钟）。

**实现**：
- 支付开始时启动超时计时器
- 超时后弹出对话框提供三个选项：
  - 查询状态：检查支付是否实际完成
  - 重新支付：取消当前请求并重新发起
  - 取消：放弃本次支付
- 支付成功或失败时自动清除超时追踪

**代码位置**：
- `common/js/errorRecovery.js` - `handlePaymentTimeout()`, `trackPaymentTimeout()`
- `common/js/paymentService.js` - 超时处理逻辑

**使用示例**：
```javascript
// 开始追踪支付超时
const paymentId = `payment_${Date.now()}_${userId}`
errorRecovery.trackPaymentTimeout(paymentId)

// 设置超时处理
setTimeout(() => {
  errorRecovery.handlePaymentTimeout({
    onCheckStatus: () => {
      // 查询支付状态
    },
    onRetry: () => {
      // 重新支付
    },
    onCancel: () => {
      // 取消支付
    }
  })
}, 300000) // 5分钟
```

**配置**：
- 超时时间：300000ms（5分钟）
- 可在 `errorRecovery.js` 中修改 `PAYMENT_TIMEOUT_MS` 常量

### 4. 网络错误重试

**场景**：网络连接失败导致API请求失败。

**实现**：
- 自动检测网络错误
- 弹出重试对话框
- 支持多次重试（默认2次）
- 显示当前重试进度

**代码位置**：
- `common/js/errorRecovery.js` - `handleNetworkError()`
- `common/js/paymentService.js` - 网络错误处理

**使用示例**：
```javascript
try {
  const result = await paymentService.recharge(amount, userId)
} catch (error) {
  if (error.errMsg && error.errMsg.includes('network')) {
    // 自动处理网络错误重试
    await errorRecovery.handleNetworkError(
      error,
      () => paymentService.recharge(amount, userId),
      2 // 最大重试次数
    )
  }
}
```

### 5. 通用重试对话框

**功能**：提供统一的重试对话框UI。

**代码位置**：
- `common/js/errorRecovery.js` - `showRetryDialog()`

**使用示例**：
```javascript
errorRecovery.showRetryDialog({
  title: '操作失败',
  content: '操作失败，是否重试？',
  onRetry: () => {
    // 重试逻辑
  },
  onCancel: () => {
    // 取消逻辑
  }
})
```

## 存储键说明

错误恢复服务使用以下本地存储键：

| 键名 | 用途 | 数据格式 |
|------|------|----------|
| `payment_intent` | 保存待恢复的支付意图 | JSON字符串 |
| `binding_retry_count` | 绑定重试计数 | 数字字符串 |
| `payment_timeout_tracker` | 支付超时追踪 | JSON字符串 |

## 错误码说明

| 错误码 | 含义 | 处理方式 |
|--------|------|----------|
| 401 | 认证失败 | 保存支付意图，重定向到登录页 |
| 999 | 重复充值 | 显示后端错误消息 |
| -1 | 支付参数错误 | 显示错误提示 |
| -2 | 支付取消/失败 | 显示错误提示 |
| -3 | 支付请求失败 | 提供重试选项 |
| -4 | 获取授权码失败 | 显示错误提示 |
| -5 | 微信登录失败 | 显示错误提示 |
| -6 | 支付超时 | 提供查询状态/重试选项 |

## 用户体验流程

### 场景1：Token过期恢复

1. 用户选择充值金额100元
2. 点击确认支付
3. 系统检测到token过期（401错误）
4. 自动保存支付意图（金额：100元）
5. 显示"认证失败，请重新登录"
6. 1.5秒后跳转到登录页
7. 用户输入账号密码登录
8. 登录成功后自动跳转到充值页
9. 弹出对话框："检测到未完成的充值订单（金额：¥100），是否继续支付？"
10. 用户点击"继续支付"
11. 自动填充金额并发起支付

### 场景2：绑定失败重试

1. 用户点击充值按钮
2. 系统检测到未绑定微信
3. 弹出绑定提示对话框
4. 用户确认绑定
5. 绑定失败（网络错误）
6. 自动弹出重试对话框："绑定微信失败，是否重试？（1/3）"
7. 用户点击"重试"
8. 再次尝试绑定
9. 如果再次失败，显示"（2/3）"
10. 最多重试3次
11. 达到上限后提示："多次绑定失败，请稍后再试或联系客服"

### 场景3：支付超时

1. 用户发起支付
2. 网络缓慢，5分钟内没有响应
3. 弹出对话框："支付请求超时，请选择操作"
4. 提供三个选项：
   - "查询状态"：检查支付是否完成
   - "重新支付"：重新发起支付
   - "取消"：放弃本次支付
5. 用户选择相应操作

## 配置参数

可在 `common/js/errorRecovery.js` 中修改以下参数：

```javascript
this.MAX_RETRY_COUNT = 3              // 最大重试次数
this.PAYMENT_TIMEOUT_MS = 300000      // 支付超时时间（毫秒）
```

## 测试建议

### 测试Token过期恢复
1. 登录系统
2. 手动清除token（开发工具中）
3. 尝试支付
4. 验证是否保存支付意图并跳转登录
5. 重新登录
6. 验证是否显示恢复对话框

### 测试绑定重试
1. 模拟网络错误（开发工具中）
2. 尝试绑定微信
3. 验证重试对话框是否显示
4. 验证重试计数是否正确
5. 验证达到上限后的提示

### 测试支付超时
1. 修改超时时间为较短值（如10秒）
2. 发起支付
3. 等待超时
4. 验证超时对话框是否显示
5. 测试各个选项的功能

## 注意事项

1. **存储清理**：支付成功后会自动清除相关存储，但异常情况下可能需要手动清理
2. **时间戳验证**：支付意图包含时间戳，过期的意图会被自动清除
3. **重试限制**：所有重试操作都有次数限制，防止无限重试
4. **用户体验**：所有错误提示都应该清晰明了，避免技术术语
5. **日志记录**：关键操作都有console.log记录，便于调试

## 未来改进

1. 添加支付状态查询API集成
2. 实现更智能的网络错误检测
3. 添加错误统计和上报功能
4. 支持自定义重试策略
5. 添加离线支付队列功能

# 微信支付集成实现说明

## 概述

本文档说明了微信支付功能的完整实现，包括微信账号绑定、支付流程、错误处理等核心功能。

## 实现状态

### ✅ 已完成 (7/20 核心任务)

1. **微信绑定服务** - 完整实现账号绑定逻辑
2. **支付服务** - 完整实现支付流程
3. **API 配置** - 添加所需的 API 端点
4. **状态管理** - Vuex store 集成
5. **我的页面** - 集成绑定检查和余额显示
6. **充值页面** - 集成支付服务和错误处理
7. **绑定对话框** - 可复用的绑定 UI 组件

### ⚠️ 待完成

- 后端 API 实现（关键阻塞项）
- 单元测试（可选）
- 错误恢复流程优化
- 余额缓存和刷新优化

## 核心功能

### 1. 微信账号绑定

**文件**: `common/js/wechatBinding.js`

**功能**:
- `checkBinding(userId)` - 检查用户是否已绑定微信
- `bindWechat(userId)` - 绑定微信账号
- `getOpenId(userId)` - 获取用户的 openid

**流程**:
```
用户点击充值 
→ 检查是否已绑定 
→ 未绑定：显示对话框 
→ 用户确认 
→ 调用 wx.login() 
→ 发送 code 到后端 
→ 后端返回 openid 
→ 保存到 Vuex 
→ 绑定成功
```

### 2. 支付服务

**文件**: `common/js/paymentService.js`

**功能**:
- `recharge(amount, userId)` - 发起充值支付
- `getBalance(userId)` - 查询账户余额
- `getPaymentHistory(userId)` - 获取支付历史

**支付流程**:
```
验证金额 
→ 调用 wx.login() 
→ 获取 code 
→ 调用支付 API 
→ 获取支付参数 
→ 调用 wx.requestPayment() 
→ 支付成功/失败处理
```

### 3. 状态管理

**文件**: `store/index.js`

**新增状态**:
```javascript
{
  isWechatBound: false,      // 微信绑定状态
  accountBalance: 0,          // 账户余额缓存
  userInfo: {
    ...existing,
    openid: string            // 微信 openid
  }
}
```

**新增 Actions**:
- `updateWechatBound(bound)` - 更新绑定状态
- `updateAccountBalance(balance)` - 更新余额缓存

### 4. UI 组件

#### 我的页面 (`package/chargingPile/my/my.vue`)

**新增功能**:
- 页面加载时检查微信绑定状态
- 点击充值前检查绑定状态
- 未绑定时显示绑定对话框
- 使用 paymentService 获取余额
- 支持余额缓存和错误处理

#### 充值页面 (`package/chargingPile/preTopUp.vue`)

**新增功能**:
- 支付前检查微信绑定状态
- 使用 paymentService 处理支付
- 完整的错误处理（401, 999, 网络错误等）
- 防重复提交
- 加载状态显示

#### 绑定对话框 (`components/wechat-bind-dialog/wechat-bind-dialog.vue`)

**功能**:
- 可复用的绑定对话框组件
- 显示绑定说明
- 确认/取消按钮
- 加载状态

## 后端 API 需求

### 1. 绑定微信账号

**端点**: `POST /user/bindWechat`

**请求**:
```json
{
  "userId": "105",
  "code": "wx_login_code"
}
```

**响应**:
```json
{
  "code": 200,
  "msg": "绑定成功",
  "data": {
    "openid": "oxxxxxxxxxxxxxx"
  }
}
```

**实现要点**:
1. 验证 userId 是否存在
2. 使用 WxJava SDK 调用微信 API: `code2Session(code)`
3. 获取 openid 和 session_key
4. 更新用户表: `UPDATE users SET openid = ? WHERE id = ?`
5. 返回 openid

### 2. 检查绑定状态

**端点**: `GET /user/wechatBinding/{userId}`

**响应**:
```json
{
  "code": 200,
  "data": {
    "bound": true,
    "openid": "oxxxxxxxxxxxxxx"
  }
}
```

**实现要点**:
1. 查询用户表: `SELECT openid FROM users WHERE id = ?`
2. 判断 openid 是否为空
3. 返回绑定状态

### 3. 数据库变更

**用户表添加字段**:
```sql
ALTER TABLE users ADD COLUMN openid VARCHAR(64) DEFAULT NULL COMMENT '微信openid';
CREATE INDEX idx_openid ON users(openid);
```

### 4. 支付 API 更新

**端点**: `POST /wechat/pay/unified/request`

**当前实现**: 已存在，但需要确认是否支持以下两种方式：

**方式 1**: 使用 code 获取 openid（当前实现）
```json
{
  "code": "wx_login_code",
  "money": 100,
  "userId": "105"
}
```

**方式 2**: 直接使用已绑定的 openid（推荐）
```json
{
  "money": 100,
  "userId": "105"
}
```

**建议**: 支付 API 应该优先从用户表中获取已绑定的 openid，而不是每次都通过 code 获取。

## 错误处理

### 前端错误处理

**支付服务** (`paymentService.js`):
- 金额验证错误 → 抛出异常
- wx.login() 失败 → 返回错误码 -5
- 支付 API 401 → 返回错误码 401
- 支付 API 999 → 返回错误码 999
- 支付参数错误 → 返回错误码 -1
- wx.requestPayment() 失败 → 返回错误码 -2
- 网络错误 → 返回错误码 -3

**充值页面** (`preTopUp.vue`):
- 未登录 → 跳转登录页
- 金额无效 → 显示提示
- 未绑定微信 → 显示绑定对话框
- 401 错误 → 跳转登录页
- 999 错误 → 显示重复充值提示
- 其他错误 → 显示通用错误提示

### 后端错误处理

**建议返回的错误码**:
- `200` - 成功
- `401` - 认证失败（token 无效）
- `403` - 权限不足
- `404` - 资源不存在（用户不存在、openid 不存在）
- `999` - 业务逻辑错误（重复充值、余额不足等）
- `500` - 服务器内部错误

## 测试指南

### 前置条件

1. **微信小程序配置**:
   - 配置合法域名: `https://sanligz.com.cn`
   - 开通微信支付功能
   - 配置支付商户号

2. **后端准备**:
   - 实现绑定 API
   - 用户表添加 openid 字段
   - 配置微信小程序 AppID 和 AppSecret

### 测试场景

#### 场景 1: 新用户首次充值

1. 注册新账号并登录
2. 进入"我的"页面
3. 点击"立即充值"按钮
4. **预期**: 显示"绑定微信账号"对话框
5. 点击"立即绑定"
6. **预期**: 调用 wx.login()，发送 code 到后端
7. **预期**: 绑定成功，显示成功提示
8. **预期**: 自动跳转到充值页面
9. 选择充值金额（如 30 元）
10. 点击"确认支付"
11. **预期**: 调起微信支付
12. 完成支付
13. **预期**: 显示"充值成功"，返回"我的"页面
14. **预期**: 余额更新为 30 元

#### 场景 2: 已绑定用户充值

1. 登录已绑定微信的账号
2. 进入"我的"页面
3. 点击"立即充值"按钮
4. **预期**: 直接跳转到充值页面（不显示绑定对话框）
5. 选择充值金额
6. 点击"确认支付"
7. **预期**: 调起微信支付
8. 完成支付
9. **预期**: 余额更新

#### 场景 3: 错误处理测试

**3.1 未登录访问**:
- 清除缓存
- 直接访问"我的"页面
- **预期**: 显示"请先登录"，跳转到登录页

**3.2 无效金额**:
- 进入充值页面
- 输入 0 或负数
- 点击"确认支付"
- **预期**: 显示"请输入有效的充值金额"

**3.3 微信登录失败**:
- 模拟 wx.login() 失败（需要修改代码测试）
- **预期**: 显示"微信登录失败"

**3.4 支付取消**:
- 发起支付
- 在微信支付界面点击取消
- **预期**: 显示"支付已取消"

**3.5 重复充值**:
- 后端返回 999 错误
- **预期**: 显示"您已充值过了，无需再次充值"

### 调试技巧

1. **查看请求头**:
   ```javascript
   // 在 interceptor.js 中添加
   console.log('Request headers:', config.header)
   ```

2. **查看绑定状态**:
   ```javascript
   // 在控制台执行
   console.log('Bound:', this.isWechatBound)
   console.log('OpenID:', this.getUser.openid)
   ```

3. **查看余额缓存**:
   ```javascript
   // 在控制台执行
   console.log('Balance:', this.$store.state.accountBalance)
   ```

4. **模拟错误**:
   ```javascript
   // 在 paymentService.js 中临时添加
   throw new Error('Test error')
   ```

## 性能优化

### 已实现

1. **余额缓存**: 余额保存在 Vuex，减少 API 调用
2. **防重复提交**: 支付过程中禁用按钮
3. **加载状态**: 显示加载提示，提升用户体验

### 待优化

1. **下拉刷新**: 在"我的"页面添加下拉刷新余额
2. **请求去重**: 防止短时间内多次调用同一 API
3. **错误重试**: 网络错误时自动重试
4. **离线缓存**: 支持离线查看余额和历史记录

## 安全考虑

### 已实现

1. **Token 认证**: 所有请求携带 Bearer token
2. **客户端认证**: 请求头包含 clientId 和 clientSecret
3. **金额验证**: 前端验证金额必须大于 0
4. **防重复提交**: 支付过程中禁用按钮

### 建议增强

1. **支付密码**: 添加支付密码验证
2. **金额限制**: 限制单次充值上限
3. **频率限制**: 限制充值频率（如每天最多 10 次）
4. **IP 记录**: 记录充值 IP 和设备信息
5. **异常监控**: 监控异常充值行为

## 常见问题

### Q1: 为什么需要绑定微信？

A: 微信支付需要用户的 openid 来创建支付订单。openid 是微信用户在小程序中的唯一标识。

### Q2: 绑定失败怎么办？

A: 可能的原因：
- 微信登录失败（网络问题）
- 后端 API 未实现
- 用户拒绝授权

解决方法：
- 检查网络连接
- 确认后端 API 已实现
- 重试绑定

### Q3: 支付失败怎么办？

A: 可能的原因：
- 认证失败（401）
- 重复充值（999）
- 微信支付参数错误
- 用户取消支付

解决方法：
- 401: 重新登录
- 999: 检查是否已充值
- 参数错误: 联系技术支持
- 取消支付: 重新发起

### Q4: 余额不更新怎么办？

A: 可能的原因：
- 余额 API 不存在（404）
- 网络错误
- 缓存未刷新

解决方法：
- 确认后端 API 已实现
- 检查网络连接
- 手动刷新页面（下拉刷新）

## 相关文档

- [需求文档](../../.kiro/specs/wechat-payment-integration/requirements.md)
- [设计文档](../../.kiro/specs/wechat-payment-integration/design.md)
- [任务列表](../../.kiro/specs/wechat-payment-integration/tasks.md)
- [充值功能说明](./充值功能说明.md)
- [修复说明](../../修复说明.md)

## 更新日志

### 2024-12-31

- ✅ 创建微信绑定服务
- ✅ 创建支付服务
- ✅ 更新 Vuex store
- ✅ 更新"我的"页面
- ✅ 更新充值页面
- ✅ 创建绑定对话框组件
- ✅ 编写实现文档

### 下一步

- ⏳ 等待后端实现绑定 API
- ⏳ 集成测试
- ⏳ 性能优化
- ⏳ 编写单元测试（可选）

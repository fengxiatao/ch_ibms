# 设备激活后显示离线问题排查指南

## 📋 问题现象
设备激活成功后，在设备管理中显示"离线"状态

## 🔍 排查步骤

### 1. 检查Gateway服务是否运行

```bash
# 查看Gateway进程
jps | grep Gateway

# 或查看日志
tail -f logs/yudao-module-iot-gateway.log
```

**如果Gateway未运行：**
- 启动Gateway服务
- 检查Gateway配置是否正确

### 2. 检查设备网络连通性

```bash
# Ping设备IP
ping 192.168.1.200

# 检查ONVIF端口（通常是80或8000）
telnet 192.168.1.200 80

# 检查RTSP端口（通常是554）
telnet 192.168.1.200 554
```

### 3. 检查设备激活日志

在后端日志中搜索关键字：
```
[activateDevice]
[handleDeviceActivationAfterCommit]
[DeviceOnlineConsumer]
[DeviceOfflineConsumer]
```

**正常流程应该看到：**
```
[activateDevice] 开始激活设备: activationId=xxx, ip=192.168.1.200
[activateDevice] 设备记录已保存: deviceId=123
[handleDeviceActivationAfterCommit] 事务已提交，发送设备连接请求: deviceId=123
[DeviceOnlineConsumer] 收到设备上线消息: deviceId=123
[DeviceOnlineConsumer] 设备上线处理完成: deviceId=123
```

**如果看到离线消息：**
```
[DeviceOfflineConsumer] 收到设备离线消息: deviceId=123
```
说明Gateway连接设备失败。

### 4. 检查Gateway连接日志

在Gateway日志中搜索：
```
[DeviceConnectSubscriber]
[CameraGateway]
[OnvifGateway]
```

**常见错误：**
- `Connection refused` - 端口不通或设备未开启服务
- `Authentication failed` - 用户名密码错误
- `Timeout` - 网络超时，设备不可达
- `Unsupported protocol` - 协议不支持

### 5. 检查数据库设备状态

```sql
-- 查看设备记录
SELECT 
    id,
    device_name,
    ip,
    status,
    username,
    create_time,
    last_online_time
FROM iot_device
WHERE ip = '192.168.1.200';

-- status 字段含义：
-- 0: INACTIVE (未激活)
-- 1: ONLINE (在线)
-- 2: OFFLINE (离线)
-- 3: DISABLED (禁用)
```

### 6. 检查消息总线

```sql
-- 如果使用Redis作为消息总线，检查Redis连接
redis-cli ping

-- 查看消息订阅情况
redis-cli pubsub channels
```

## 🛠️ 常见问题解决方案

### 问题1：用户名密码错误

**现象：** Gateway日志显示 `Authentication failed`

**解决：**
1. 确认设备的实际用户名密码
2. 在设备管理中修改设备的用户名密码
3. 或重新激活设备，输入正确的凭据

### 问题2：设备端口配置错误

**现象：** Gateway日志显示 `Connection refused`

**解决：**
1. 登录设备Web界面，查看ONVIF端口配置
2. 常见端口：
   - ONVIF: 80, 8000, 8080
   - RTSP: 554
   - HTTP: 80, 8000
3. 在设备管理中修改端口配置

### 问题3：Gateway服务未启动

**现象：** 没有看到Gateway相关日志

**解决：**
```bash
# 启动Gateway服务
cd yudao-module-iot/yudao-module-iot-gateway
mvn spring-boot:run
```

### 问题4：网络不通

**现象：** Ping不通设备IP

**解决：**
1. 检查设备和服务器是否在同一网段
2. 检查防火墙设置
3. 检查路由配置

### 问题5：设备协议不支持

**现象：** Gateway日志显示 `Unsupported protocol`

**解决：**
1. 确认设备支持的协议（ONVIF、大华私有、海康私有）
2. 在产品配置中选择正确的协议
3. 如果设备不支持ONVIF，需要使用厂商私有协议

## 📝 手动触发设备上线

如果设备实际在线但系统显示离线，可以手动触发连接：

```java
// 在设备管理界面，点击"重新连接"按钮
// 或通过API调用
POST /admin-api/iot/device/reconnect?id=123
```

## 🔄 设备状态同步机制

### 自动同步
- Gateway每隔30秒检查一次设备连接状态
- 设备离线超过1分钟会自动标记为离线
- 设备重新连接后会自动标记为在线

### 手动同步
- 在设备管理界面点击"刷新状态"
- 调用设备心跳检测API

## 📊 设备状态流转

```
INACTIVE (未激活)
    ↓ 激活
OFFLINE (离线) ←→ ONLINE (在线)
    ↓ 禁用
DISABLED (禁用)
```

## 🚨 紧急处理

如果大量设备显示离线：

1. **检查Gateway服务**
   ```bash
   systemctl status iot-gateway
   # 或
   ps aux | grep gateway
   ```

2. **检查Redis服务**
   ```bash
   systemctl status redis
   redis-cli ping
   ```

3. **检查网络**
   ```bash
   # 检查网卡状态
   ifconfig
   # 检查路由
   route -n
   ```

4. **重启Gateway服务**
   ```bash
   systemctl restart iot-gateway
   ```

## 📞 技术支持

如果以上方法都无法解决问题，请联系技术支持并提供：
1. 完整的后端日志（最近1小时）
2. Gateway日志（最近1小时）
3. 设备IP和型号
4. 网络拓扑图

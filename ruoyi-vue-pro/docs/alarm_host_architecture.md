# æŠ¥è­¦ä¸»æœºç³»ç»Ÿæ¶æ„è¯´æ˜

## æ¶æ„è®¾è®¡åŸåˆ™

**æ ¸å¿ƒåŸåˆ™ï¼šä¸šåŠ¡å±‚ä¸ç›´æ¥ä¸è®¾å¤‡äº¤äº’ï¼Œæ‰€æœ‰è®¾å¤‡é€šä¿¡ç”±Gatewayå±‚ç»Ÿä¸€å¤„ç†**

## ç³»ç»Ÿåˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯å±‚                              â”‚
â”‚                    (Vue3 + Element Plus)                     â”‚
â”‚  - æŠ¥è­¦ä¸»æœºåˆ—è¡¨å±•ç¤º                                           â”‚
â”‚  - é’»å–å¼æ ‘å½¢ç»“æ„ï¼ˆä¸»æœºâ†’åˆ†åŒºâ†’é˜²åŒºï¼‰                           â”‚
â”‚  - å®æ—¶çŠ¶æ€æ˜¾ç¤º                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸šåŠ¡å±‚ (Biz)                         â”‚
â”‚              (yudao-module-iot-biz)                          â”‚
â”‚                                                              â”‚
â”‚  Controller:                                                 â”‚
â”‚  - IotAlarmHostController                                    â”‚
â”‚    â”œâ”€ GET /iot/alarm/host/{id}/partitions (æŸ¥è¯¢åˆ†åŒº)        â”‚
â”‚    â”œâ”€ GET /iot/alarm/host/{id}/zones (æŸ¥è¯¢é˜²åŒº)             â”‚
â”‚    â””â”€ GET /iot/alarm/host/{id}/status (æŸ¥è¯¢å®æ—¶çŠ¶æ€)        â”‚
â”‚                                                              â”‚
â”‚  Service:                                                    â”‚
â”‚  - IotAlarmPartitionService                                  â”‚
â”‚    â”œâ”€ getPartitionListByHostId() - æŸ¥è¯¢åˆ†åŒºåˆ—è¡¨             â”‚
â”‚    â”œâ”€ queryAndSyncHostStatus() - æŸ¥è¯¢ä¸»æœºçŠ¶æ€               â”‚
â”‚    â””â”€ syncHostStatusToDatabase() - åŒæ­¥çŠ¶æ€åˆ°æ•°æ®åº“         â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ ä¸ç›´æ¥ä¸è®¾å¤‡é€šä¿¡ï¼Œé€šè¿‡HTTPè°ƒç”¨Gatewayæ¥å£                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘å…³å±‚ (Gateway)                        â”‚
â”‚            (yudao-module-iot-gateway)                        â”‚
â”‚                                                              â”‚
â”‚  HTTP Controller:                                            â”‚
â”‚  - AlarmHostQueryController                                  â”‚
â”‚    â””â”€ GET /api/alarm/host/{account}/query-status            â”‚
â”‚       (æ¥æ”¶Bizå±‚çš„HTTPè¯·æ±‚)                                  â”‚
â”‚                                                              â”‚
â”‚  ä¸‹è¡Œå¤„ç†å™¨:                                                  â”‚
â”‚  - IotAlarmDownstreamHandler                                 â”‚
â”‚    â”œâ”€ queryHostStatus() - å‘é€æŸ¥è¯¢å‘½ä»¤åˆ°è®¾å¤‡                 â”‚
â”‚    â”œâ”€ sendControlCommand() - å‘é€æ§åˆ¶å‘½ä»¤                    â”‚
â”‚    â””â”€ handleResponse() - å¤„ç†è®¾å¤‡å“åº”                        â”‚
â”‚                                                              â”‚
â”‚  åè®®è§£æå™¨:                                                  â”‚
â”‚  - AlarmHostStatusParser                                     â”‚
â”‚    â”œâ”€ buildQueryCommand() - æ„é€ æŸ¥è¯¢å‘½ä»¤                     â”‚
â”‚    â””â”€ parse() - è§£æè®¾å¤‡å“åº”                                 â”‚
â”‚                                                              â”‚
â”‚  ä¸Šè¡Œå¤„ç†å™¨:                                                  â”‚
â”‚  - IotAlarmUpstreamHandler                                   â”‚
â”‚    â”œâ”€ å¤„ç†è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥çš„äº‹ä»¶                                  â”‚
â”‚    â”œâ”€ è®¾å¤‡è®¤è¯                                               â”‚
â”‚    â””â”€ å¿ƒè·³å¤„ç†                                               â”‚
â”‚                                                              â”‚
â”‚  è¿æ¥ç®¡ç†:                                                    â”‚
â”‚  - IotAlarmConnectionManager                                 â”‚
â”‚    â””â”€ ç®¡ç†æ‰€æœ‰æŠ¥è­¦ä¸»æœºçš„TCPè¿æ¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ TCP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æŠ¥è­¦ä¸»æœºè®¾å¤‡                           â”‚
â”‚                   (PS600 OPC v1.2 åè®®)                      â”‚
â”‚                                                              â”‚
â”‚  - æ¥æ”¶æŸ¥è¯¢å‘½ä»¤ï¼šC{account},10,0,9876,{sequence}             â”‚
â”‚  - è¿”å›çŠ¶æ€æ•°æ®ï¼šc{account},0,{sequence}Ã‰S0aaaaaaAB          â”‚
â”‚  - ä¸»åŠ¨ä¸ŠæŠ¥äº‹ä»¶ï¼š{account},{event},{area},{point},{sequence} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµå‘

### 1. æŸ¥è¯¢åˆ†åŒº/é˜²åŒºæµç¨‹

```
å‰ç«¯ â†’ Biz â†’ Gateway â†’ è®¾å¤‡
 â†“      â†“       â†“       â†“
è¯·æ±‚  æŸ¥è¯¢DB  å‘TCP   è¿”å›çŠ¶æ€
 â†‘      â†‘    è§£æåè®®    â†‘
 â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ­¥éª¤ï¼š**

1. **å‰ç«¯å‘èµ·è¯·æ±‚**
   ```http
   GET /admin-api/iot/alarm/host/109/partitions
   ```

2. **Bizå±‚å¤„ç†**
   ```java
   // IotAlarmPartitionServiceImpl.getPartitionListByHostId()
   
   // 2.1 å…ˆæŸ¥è¯¢æ•°æ®åº“
   List<IotAlarmPartitionDO> partitions = partitionMapper.selectListByHostId(hostId);
   
   // 2.2 å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œè°ƒç”¨GatewayæŸ¥è¯¢
   if (partitions.isEmpty()) {
       // å‘é€HTTPè¯·æ±‚åˆ°Gateway
       String url = "http://127.0.0.1:48082/api/alarm/host/1234/query-status?sequence=xxx";
       String response = HttpUtils.get(url, null);
       
       // è§£æGatewayè¿”å›çš„JSON
       AlarmHostStatusDTO status = parseResponse(response);
       
       // åŠ¨æ€ç”Ÿæˆåˆ†åŒºå’Œé˜²åŒºåˆ—è¡¨
       return generatePartitionsFromStatus(status);
   }
   ```

3. **Gatewayå±‚å¤„ç†**
   ```java
   // AlarmHostQueryController.queryHostStatus()
   
   // 3.1 è°ƒç”¨ä¸‹è¡Œå¤„ç†å™¨
   CompletableFuture<AlarmHostStatusDTO> future = 
       downstreamHandler.queryHostStatus(account, sequence);
   
   // 3.2 ä¸‹è¡Œå¤„ç†å™¨å‘é€TCPå‘½ä»¤
   // IotAlarmDownstreamHandler.queryHostStatus()
   String command = "C1234,10,0,9876,131\n";  // æŸ¥è¯¢å‘½ä»¤
   socket.write(Buffer.buffer(command));
   
   // 3.3 ç­‰å¾…è®¾å¤‡å“åº”
   AlarmHostStatusDTO status = future.get(10, TimeUnit.SECONDS);
   ```

4. **è®¾å¤‡å“åº”**
   ```
   è®¾å¤‡è¿”å›ï¼šc1234,0,131Ã‰S0aaaaaaAB
   ```

5. **Gatewayè§£æåè®®**
   ```java
   // AlarmHostStatusParser.parse()
   
   // 5.1 æŸ¥æ‰¾'S'æ ‡è®°
   int sIndex = response.indexOf('S');
   
   // 5.2 è§£æç³»ç»ŸçŠ¶æ€ï¼ˆ'S'åç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
   char systemStatus = response.charAt(sIndex + 1);  // '0' = æ’¤é˜²
   
   // 5.3 è§£æé˜²åŒºçŠ¶æ€ï¼ˆ'S'åç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹ï¼‰
   String zoneStr = "aaaaaaAB";
   // a = é˜²åŒº1æ’¤é˜²
   // a = é˜²åŒº2æ’¤é˜²
   // ...
   // A = é˜²åŒº7å¸ƒé˜²
   // B = é˜²åŒº8å¸ƒé˜²ä¸”æŠ¥è­¦
   ```

6. **Gatewayè¿”å›JSON**
   ```json
   {
     "code": 0,
     "msg": "æŸ¥è¯¢æˆåŠŸ",
     "data": {
       "account": "1234",
       "systemStatus": 0,
       "zones": [
         {"zoneNo": 1, "status": 0, "alarmStatus": 0},
         {"zoneNo": 2, "status": 0, "alarmStatus": 0},
         ...
         {"zoneNo": 7, "status": 1, "alarmStatus": 0},
         {"zoneNo": 8, "status": 1, "alarmStatus": 1}
       ],
       "rawData": "c1234,0,131Ã‰S0aaaaaaAB"
     }
   }
   ```

7. **Bizå±‚ç”ŸæˆVO**
   ```java
   // åŠ¨æ€ç”Ÿæˆåˆ†åŒº
   IotAlarmPartitionRespVO partition = new IotAlarmPartitionRespVO();
   partition.setPartitionNo(1);
   partition.setPartitionName("é»˜è®¤åˆ†åŒº");
   partition.setStatus(statusVO.getSystemStatus());
   partition.setZoneCount(statusVO.getZones().size());
   
   // åŠ¨æ€ç”Ÿæˆé˜²åŒº
   List<IotAlarmZoneRespVO> zones = statusVO.getZones().stream()
       .map(z -> {
           IotAlarmZoneRespVO vo = new IotAlarmZoneRespVO();
           vo.setZoneNo(z.getZoneNo());
           vo.setZoneName("é˜²åŒº" + z.getZoneNo());
           vo.setZoneStatus(z.getStatus() == 1 ? "ARM" : "DISARM");
           vo.setAlarmCount(z.getAlarmStatus());
           return vo;
       }).collect(Collectors.toList());
   ```

8. **å‰ç«¯å±•ç¤º**
   ```
   ğŸ“± å¤§å ‚æŠ¥è­¦ä¸»æœº
     ğŸ“ é»˜è®¤åˆ†åŒº (æ’¤é˜²)
       ğŸ“ é˜²åŒº1 - æ’¤é˜²
       ğŸ“ é˜²åŒº2 - æ’¤é˜²
       ğŸ“ é˜²åŒº3 - æ’¤é˜²
       ğŸ“ é˜²åŒº4 - æ’¤é˜²
       ğŸ“ é˜²åŒº5 - æ’¤é˜²
       ğŸ“ é˜²åŒº6 - æ’¤é˜²
       ğŸ“ é˜²åŒº7 - å¸ƒé˜²
       ğŸ“ é˜²åŒº8 - å¸ƒé˜²ä¸”æŠ¥è­¦ âš ï¸
   ```

## åè®®è¯¦è§£

### PS600 OPC v1.2 åè®®

#### 1. æŸ¥è¯¢ä¸»æœºçŠ¶æ€

**ä¸‹è¡Œå‘½ä»¤ï¼ˆä¸­å¿ƒâ†’ä¸»æœºï¼‰ï¼š**
```
C{account},10,0,9876,{sequence}\n

å‚æ•°è¯´æ˜ï¼š
- C: å‘½ä»¤å‰ç¼€ï¼ˆå¤§å†™ï¼‰
- account: ä¸»æœºè´¦å·ï¼ˆå¦‚ï¼š1234ï¼‰
- 10: å‘½ä»¤ç ï¼ˆ10è¡¨ç¤ºæŸ¥è¯¢çŠ¶æ€ï¼‰
- 0: å‚æ•°ï¼ˆ0è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰é˜²åŒºï¼‰
- 9876: éšæœºæ•°ï¼ˆç”¨äºéªŒè¯ï¼‰
- sequence: åºåˆ—å·ï¼ˆç”¨äºåŒ¹é…è¯·æ±‚å’Œå“åº”ï¼‰
- \n: æ¢è¡Œç¬¦ï¼ˆå¸§ç»“æŸæ ‡è®°ï¼‰

ç¤ºä¾‹ï¼šC1234,10,0,9876,131\n
```

**ä¸Šè¡Œå“åº”ï¼ˆä¸»æœºâ†’ä¸­å¿ƒï¼‰ï¼š**
```
c{account},0,{sequence}Ã‰{data}\n

å‚æ•°è¯´æ˜ï¼š
- c: å“åº”å‰ç¼€ï¼ˆå°å†™ï¼‰
- account: ä¸»æœºè´¦å·
- 0: ç»“æœç ï¼ˆ0è¡¨ç¤ºæˆåŠŸï¼‰
- sequence: åºåˆ—å·ï¼ˆä¸è¯·æ±‚å¯¹åº”ï¼‰
- Ã‰: åˆ†éš”ç¬¦
- data: çŠ¶æ€æ•°æ®ï¼ˆå¦‚ï¼šS0aaaaaaABï¼‰
- \n: æ¢è¡Œç¬¦

ç¤ºä¾‹ï¼šc1234,0,131Ã‰S0aaaaaaAB\n
```

#### 2. çŠ¶æ€æ•°æ®è§£æ

**æ ¼å¼ï¼šS{ç³»ç»ŸçŠ¶æ€}{é˜²åŒºçŠ¶æ€åˆ—è¡¨}**

```
S0aaaaaaAB

è§£æè§„åˆ™ï¼š
- S: çŠ¶æ€æ ‡è®°
- 0: ç³»ç»ŸçŠ¶æ€ï¼ˆç¬¬1ä¸ªå­—ç¬¦ï¼‰
  - 0 = ç³»ç»Ÿæ’¤é˜²
  - 1 = ç³»ç»Ÿå¸ƒé˜²
  
- aaaaaaAB: é˜²åŒºçŠ¶æ€ï¼ˆç¬¬2ä¸ªå­—ç¬¦å¼€å§‹ï¼‰
  - å°å†™å­—æ¯(a-z): é˜²åŒºæ’¤é˜²
  - å¤§å†™å­—æ¯(A-Z): é˜²åŒºå¸ƒé˜²
  - å¤§å†™å­—æ¯+æ•°å­—: é˜²åŒºå¸ƒé˜²ä¸”æŠ¥è­¦
  
ç¤ºä¾‹è§£æï¼š
  a = é˜²åŒº1æ’¤é˜²
  a = é˜²åŒº2æ’¤é˜²
  a = é˜²åŒº3æ’¤é˜²
  a = é˜²åŒº4æ’¤é˜²
  a = é˜²åŒº5æ’¤é˜²
  a = é˜²åŒº6æ’¤é˜²
  A = é˜²åŒº7å¸ƒé˜²
  B = é˜²åŒº8å¸ƒé˜²ä¸”æŠ¥è­¦
```

#### 3. äº‹ä»¶ä¸ŠæŠ¥

**ä¸Šè¡Œäº‹ä»¶ï¼ˆä¸»æœºâ†’ä¸­å¿ƒï¼‰ï¼š**
```
{account},{event},{area},{point},{sequence}\n

å‚æ•°è¯´æ˜ï¼š
- account: ä¸»æœºè´¦å·
- event: äº‹ä»¶ç ï¼ˆå¦‚ï¼š1=å¸ƒé˜²ï¼Œ2=æ’¤é˜²ï¼Œ3=æŠ¥è­¦ç­‰ï¼‰
- area: åˆ†åŒºå·
- point: é˜²åŒºå·
- sequence: åºåˆ—å·

ç¤ºä¾‹ï¼š1234,3,1,8,132\n
ï¼ˆä¸»æœº1234ï¼ŒæŠ¥è­¦äº‹ä»¶ï¼Œåˆ†åŒº1ï¼Œé˜²åŒº8ï¼‰
```

#### 4. æ§åˆ¶å‘½ä»¤

**ä¸‹è¡Œæ§åˆ¶ï¼ˆä¸­å¿ƒâ†’ä¸»æœºï¼‰ï¼š**
```
{account},{control},{param},{password},{sequence}\n

å‚æ•°è¯´æ˜ï¼š
- account: ä¸»æœºè´¦å·
- control: æ§åˆ¶ç ï¼ˆå¦‚ï¼š1=å¸ƒé˜²ï¼Œ2=æ’¤é˜²ï¼Œ3=æ¶ˆè­¦ç­‰ï¼‰
- param: å‚æ•°ï¼ˆå¦‚ï¼šåˆ†åŒºå·ã€é˜²åŒºå·ï¼‰
- password: å¯†ç 
- sequence: åºåˆ—å·

ç¤ºä¾‹ï¼š1234,1,0,123456,133\n
ï¼ˆä¸»æœº1234ï¼Œå¸ƒé˜²å‘½ä»¤ï¼Œæ‰€æœ‰åˆ†åŒºï¼Œå¯†ç 123456ï¼‰
```

## å…³é”®ç»„ä»¶è¯´æ˜

### Gatewayå±‚ç»„ä»¶

#### 1. AlarmHostQueryController
- **èŒè´£**ï¼šæä¾›HTTPæ¥å£ä¾›Bizå±‚è°ƒç”¨
- **ç«¯å£**ï¼š48082ï¼ˆGatewayæœåŠ¡ç«¯å£ï¼‰
- **æ¥å£**ï¼š`GET /api/alarm/host/{account}/query-status`

#### 2. IotAlarmDownstreamHandler
- **èŒè´£**ï¼šå‘é€å‘½ä»¤åˆ°è®¾å¤‡ï¼Œå¤„ç†å“åº”
- **åŠŸèƒ½**ï¼š
  - æŸ¥è¯¢ä¸»æœºçŠ¶æ€
  - å‘é€æ§åˆ¶å‘½ä»¤
  - ç®¡ç†è¯·æ±‚-å“åº”æ˜ å°„
  - è¶…æ—¶å¤„ç†

#### 3. AlarmHostStatusParser
- **èŒè´£**ï¼šåè®®è§£æ
- **åŠŸèƒ½**ï¼š
  - æ„é€ æŸ¥è¯¢å‘½ä»¤
  - è§£æçŠ¶æ€å“åº”
  - æå–ç³»ç»ŸçŠ¶æ€å’Œé˜²åŒºçŠ¶æ€

#### 4. IotAlarmUpstreamHandler
- **èŒè´£**ï¼šå¤„ç†è®¾å¤‡ä¸Šè¡Œæ¶ˆæ¯
- **åŠŸèƒ½**ï¼š
  - è®¾å¤‡è®¤è¯
  - å¿ƒè·³å¤„ç†
  - äº‹ä»¶ä¸ŠæŠ¥å¤„ç†
  - æ§åˆ¶å“åº”å¤„ç†

#### 5. IotAlarmConnectionManager
- **èŒè´£**ï¼šTCPè¿æ¥ç®¡ç†
- **åŠŸèƒ½**ï¼š
  - æ³¨å†Œ/æ³¨é”€è¿æ¥
  - æ ¹æ®accountæŸ¥æ‰¾è¿æ¥
  - è¿æ¥çŠ¶æ€ç»´æŠ¤

### Bizå±‚ç»„ä»¶

#### 1. IotAlarmHostController
- **èŒè´£**ï¼šå¯¹å¤–æä¾›REST API
- **æ¥å£**ï¼š
  - `GET /iot/alarm/host/{id}/partitions` - æŸ¥è¯¢åˆ†åŒº
  - `GET /iot/alarm/host/{id}/zones` - æŸ¥è¯¢é˜²åŒº
  - `GET /iot/alarm/host/{id}/status` - æŸ¥è¯¢çŠ¶æ€

#### 2. IotAlarmPartitionService
- **èŒè´£**ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†
- **åŠŸèƒ½**ï¼š
  - æŸ¥è¯¢åˆ†åŒºåˆ—è¡¨ï¼ˆä¼˜å…ˆæ•°æ®åº“ï¼Œæ— æ•°æ®åˆ™æŸ¥è®¾å¤‡ï¼‰
  - æŸ¥è¯¢é˜²åŒºåˆ—è¡¨ï¼ˆä¼˜å…ˆæ•°æ®åº“ï¼Œæ— æ•°æ®åˆ™æŸ¥è®¾å¤‡ï¼‰
  - è°ƒç”¨GatewayæŸ¥è¯¢è®¾å¤‡çŠ¶æ€
  - åŒæ­¥çŠ¶æ€åˆ°æ•°æ®åº“

## é…ç½®è¯´æ˜

### Gatewayé…ç½®
```yaml
# application.yml
iot:
  gateway:
    base-url: http://127.0.0.1:48082  # GatewayæœåŠ¡åœ°å€
    alarm:
      port: 9988                       # TCPç›‘å¬ç«¯å£
      idle-timeout: 300                # ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰
      ssl-enabled: false               # æ˜¯å¦å¯ç”¨SSL
```

### Bizé…ç½®
```yaml
# application.yml
iot:
  gateway:
    base-url: http://127.0.0.1:48082  # GatewayæœåŠ¡åœ°å€ï¼ˆç”¨äºHTTPè°ƒç”¨ï¼‰
```

## æ•°æ®åº“è®¾è®¡

### æŠ¥è­¦ä¸»æœºè¡¨ (iot_alarm_host)
```sql
CREATE TABLE iot_alarm_host (
    id BIGINT PRIMARY KEY,
    host_name VARCHAR(100),      -- ä¸»æœºåç§°
    host_model VARCHAR(50),       -- ä¸»æœºå‹å·
    host_sn VARCHAR(100),         -- ä¸»æœºåºåˆ—å·
    device_id BIGINT,             -- å…³è”è®¾å¤‡ID
    account VARCHAR(50),          -- ä¸»æœºè´¦å·ï¼ˆç”¨äºåè®®é€šä¿¡ï¼‰
    password VARCHAR(100),        -- ä¸»æœºå¯†ç 
    ip_address VARCHAR(50),       -- IPåœ°å€
    port INT,                     -- ç«¯å£
    zone_count INT,               -- é˜²åŒºæ•°é‡
    status TINYINT,               -- çŠ¶æ€ï¼š0-ç¦»çº¿ï¼Œ1-åœ¨çº¿
    ...
);
```

### åˆ†åŒºè¡¨ (iot_alarm_partition)
```sql
CREATE TABLE iot_alarm_partition (
    id BIGINT PRIMARY KEY,
    host_id BIGINT,               -- ä¸»æœºID
    partition_no INT,             -- åˆ†åŒºç¼–å·
    partition_name VARCHAR(100),  -- åˆ†åŒºåç§°
    status TINYINT,               -- å¸ƒé˜²çŠ¶æ€ï¼š0-æ’¤é˜²ï¼Œ1-å¸ƒé˜²
    description VARCHAR(500),     -- æè¿°
    ...
);
```

### é˜²åŒºè¡¨ (iot_alarm_zone)
```sql
CREATE TABLE iot_alarm_zone (
    id BIGINT PRIMARY KEY,
    host_id BIGINT,               -- ä¸»æœºID
    zone_no INT,                  -- é˜²åŒºç¼–å·
    zone_name VARCHAR(100),       -- é˜²åŒºåç§°
    zone_type VARCHAR(50),        -- é˜²åŒºç±»å‹
    zone_status VARCHAR(20),      -- å¸ƒé˜²çŠ¶æ€ï¼šARM/DISARM
    online_status TINYINT,        -- åœ¨çº¿çŠ¶æ€
    alarm_count INT,              -- æŠ¥è­¦æ¬¡æ•°
    last_alarm_time DATETIME,     -- æœ€åæŠ¥è­¦æ—¶é—´
    ...
);
```

## ä¼˜åŠ¿æ€»ç»“

### 1. æ¶æ„æ¸…æ™°
- âœ… ä¸šåŠ¡å±‚ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
- âœ… Gatewayå±‚ä¸“æ³¨è®¾å¤‡é€šä¿¡
- âœ… èŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤

### 2. åè®®éš”ç¦»
- âœ… åè®®ç»†èŠ‚å°è£…åœ¨Gateway
- âœ… Bizå±‚æ— éœ€å…³å¿ƒåè®®æ ¼å¼
- âœ… åè®®å˜æ›´ä¸å½±å“ä¸šåŠ¡å±‚

### 3. è¿æ¥å¤ç”¨
- âœ… Gatewayç»Ÿä¸€ç®¡ç†TCPè¿æ¥
- âœ… é¿å…é‡å¤è¿æ¥
- âœ… æé«˜é€šä¿¡æ•ˆç‡

### 4. çµæ´»åˆ‡æ¢
- âœ… æ•°æ®åº“æœ‰æ•°æ®ä¼˜å…ˆç”¨æ•°æ®åº“
- âœ… æ•°æ®åº“æ— æ•°æ®è‡ªåŠ¨æŸ¥è®¾å¤‡
- âœ… æ”¯æŒå®æ—¶æŸ¥è¯¢å’Œå†å²æ•°æ®

### 5. æ˜“äºæ‰©å±•
- âœ… æ–°å¢è®¾å¤‡ç±»å‹åªéœ€æ‰©å±•Gateway
- âœ… ä¸šåŠ¡é€»è¾‘ä¿æŒä¸å˜
- âœ… æ”¯æŒå¤šç§åè®®å¹¶å­˜

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡
```bash
# 1. å¯åŠ¨GatewayæœåŠ¡ï¼ˆç«¯å£48082ï¼‰
# 2. å¯åŠ¨BizæœåŠ¡ï¼ˆç«¯å£48888ï¼‰
# 3. ç¡®ä¿æŠ¥è­¦ä¸»æœºå·²è¿æ¥åˆ°Gateway
```

### 2. æµ‹è¯•Gatewayæ¥å£
```bash
# ç›´æ¥è°ƒç”¨Gatewayæ¥å£æµ‹è¯•
curl "http://127.0.0.1:48082/api/alarm/host/1234/query-status?sequence=123"

# é¢„æœŸè¿”å›ï¼š
{
  "code": 0,
  "msg": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "account": "1234",
    "systemStatus": 0,
    "zones": [...]
  }
}
```

### 3. æµ‹è¯•Bizæ¥å£
```bash
# è°ƒç”¨Bizå±‚æ¥å£ï¼ˆä¼šè‡ªåŠ¨è°ƒç”¨Gatewayï¼‰
curl "http://localhost:3001/admin-api/iot/alarm/host/109/partitions"

# é¢„æœŸè¿”å›åˆ†åŒºåˆ—è¡¨
```

### 4. å‰ç«¯æµ‹è¯•
```
1. è®¿é—®æŠ¥è­¦ä¸»æœºé¡µé¢
2. ç‚¹å‡»å±•å¼€ä¸»æœº
3. æŸ¥çœ‹åˆ†åŒºå’Œé˜²åŒºåˆ—è¡¨
4. éªŒè¯çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
```

## æ•…éšœæ’æŸ¥

### 1. 404é”™è¯¯
- âœ… æ£€æŸ¥BizæœåŠ¡æ˜¯å¦å¯åŠ¨
- âœ… æ£€æŸ¥æ¥å£è·¯å¾„æ˜¯å¦æ­£ç¡®
- âœ… æ£€æŸ¥æƒé™é…ç½®

### 2. æŸ¥è¯¢è¶…æ—¶
- âœ… æ£€æŸ¥GatewayæœåŠ¡æ˜¯å¦å¯åŠ¨
- âœ… æ£€æŸ¥æŠ¥è­¦ä¸»æœºæ˜¯å¦åœ¨çº¿
- âœ… æ£€æŸ¥TCPè¿æ¥æ˜¯å¦æ­£å¸¸

### 3. åè®®è§£æå¤±è´¥
- âœ… æŸ¥çœ‹Gatewayæ—¥å¿—
- âœ… æ£€æŸ¥åŸå§‹å“åº”æ•°æ®
- âœ… éªŒè¯åè®®æ ¼å¼æ˜¯å¦æ­£ç¡®

### 4. æ•°æ®ä¸ä¸€è‡´
- âœ… æ¸…ç©ºæ•°æ®åº“æ•°æ®é‡æ–°æŸ¥è¯¢
- âœ… æ£€æŸ¥åŒæ­¥é€»è¾‘æ˜¯å¦æ­£ç¡®
- âœ… éªŒè¯è®¾å¤‡é…ç½®æ˜¯å¦å˜æ›´

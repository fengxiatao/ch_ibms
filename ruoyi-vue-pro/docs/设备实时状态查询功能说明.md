# è®¾å¤‡å®æ—¶çŠ¶æ€æŸ¥è¯¢åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨è®¾å¤‡ç®¡ç†é¡µé¢æ‰“å¼€æ—¶ï¼Œè‡ªåŠ¨æŸ¥è¯¢è®¾å¤‡çš„**å®æ—¶åœ¨çº¿çŠ¶æ€**ï¼Œè€Œä¸æ˜¯ä»…æ˜¾ç¤ºæ•°æ®åº“ä¸­å­˜å‚¨çš„çŠ¶æ€ï¼ˆå¯èƒ½å·²è¿‡æœŸï¼‰ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—èŒè´£åˆ’åˆ†

```
å‰ç«¯ (Vue3)
    â†“ HTTP
ä¸šåŠ¡æ¨¡å— (yudao-module-iot-biz)
    â”œâ”€ IotDeviceController - è®¾å¤‡åˆ†é¡µæ¥å£
    â”œâ”€ IotDeviceServiceImpl - ä¸šåŠ¡é€»è¾‘
    â””â”€ GatewayClient - HTTPå®¢æˆ·ç«¯ï¼ˆè°ƒç”¨Gatewayï¼‰
        â†“ HTTP (æ— ä»£ç ä¾èµ–)
ç½‘å…³æ¨¡å— (yudao-module-iot-gateway)
    â”œâ”€ DeviceStatusController - çŠ¶æ€æŸ¥è¯¢æ¥å£
    â””â”€ DeviceConnectionManager - è®¾å¤‡è¿æ¥ç®¡ç†
```

### å…³é”®ç‰¹æ€§

1. **ä¸šåŠ¡æ¨¡å—å’Œç½‘å…³æ¨¡å—å®Œå…¨è§£è€¦** - é€šè¿‡HTTPé€šä¿¡ï¼Œæ— ä»£ç ä¾èµ–
2. **å¸¦è¶…æ—¶é…ç½®çš„HTTPè°ƒç”¨** - é¿å…ç½‘å…³ä¸å¯è¾¾æ—¶é•¿æ—¶é—´é˜»å¡
3. **å¤±è´¥é™çº§** - Gatewayè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨æ•°æ®åº“çŠ¶æ€ï¼Œä¸å½±å“ä¸»æµç¨‹

## ğŸ“ æ¶‰åŠçš„æ–‡ä»¶

### ä¸šåŠ¡æ¨¡å— (yudao-module-iot-biz)

#### 1. Controllerå±‚
**æ–‡ä»¶ï¼š** `IotDeviceController.java`
```java
@GetMapping("/page")
public CommonResult<PageResult<IotDeviceRespVO>> getDevicePage(@Valid IotDevicePageReqVO pageReqVO) {
    PageResult<IotDeviceDO> pageResult = deviceService.getDevicePage(pageReqVO);
    PageResult<IotDeviceRespVO> result = BeanUtils.toBean(pageResult, IotDeviceRespVO.class);
    
    // âœ… è¡¥å……å®æ—¶åœ¨çº¿çŠ¶æ€ï¼ˆä»GatewayæŸ¥è¯¢ï¼‰
    deviceService.fillDeviceRealTimeStatus(result.getList());
    
    return success(result);
}
```

#### 2. Serviceæ¥å£
**æ–‡ä»¶ï¼š** `IotDeviceService.java`
```java
/**
 * å¡«å……è®¾å¤‡å®æ—¶åœ¨çº¿çŠ¶æ€ï¼ˆä»GatewayæŸ¥è¯¢ï¼‰
 *
 * @param devices è®¾å¤‡åˆ—è¡¨
 */
void fillDeviceRealTimeStatus(List<IotDeviceRespVO> devices);
```

#### 3. Serviceå®ç°
**æ–‡ä»¶ï¼š** `IotDeviceServiceImpl.java`
```java
@Resource
private GatewayClient gatewayClient;

@Override
public void fillDeviceRealTimeStatus(List<IotDeviceRespVO> devices) {
    if (devices == null || devices.isEmpty()) {
        return;
    }
    
    try {
        // æå–è®¾å¤‡IDåˆ—è¡¨
        List<Long> deviceIds = devices.stream()
                .map(IotDeviceRespVO::getId)
                .filter(Objects::nonNull)
                .toList();
        
        // è°ƒç”¨Gatewayæ‰¹é‡æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
        Map<Long, GatewayClient.DeviceStatus> statusMap = 
                gatewayClient.batchGetDeviceStatus(deviceIds);
        
        // å¡«å……å®æ—¶çŠ¶æ€
        for (IotDeviceRespVO device : devices) {
            GatewayClient.DeviceStatus status = statusMap.get(device.getId());
            if (status != null) {
                device.setState(status.getStatus()); // æ›´æ–°ä¸ºå®æ—¶çŠ¶æ€
            }
        }
    } catch (Exception e) {
        log.error("[fillDeviceRealTimeStatus] å¡«å……è®¾å¤‡å®æ—¶çŠ¶æ€å¤±è´¥", e);
        // å¤±è´¥æ—¶ä¸å½±å“ä¸»æµç¨‹ï¼Œä½¿ç”¨æ•°æ®åº“ä¸­çš„çŠ¶æ€
    }
}
```

#### 4. Gateway HTTPå®¢æˆ·ç«¯
**æ–‡ä»¶ï¼š** `gateway/GatewayClient.java`

**å…³é”®ç‰¹æ€§ï¼š**
- å†…éƒ¨åˆ›å»ºå¸¦è¶…æ—¶é…ç½®çš„RestTemplate
- è¿æ¥è¶…æ—¶ï¼š5ç§’
- è¯»å–è¶…æ—¶ï¼š15ç§’
- æ”¯æŒGateway Tokenè®¤è¯
- å¤±è´¥æ—¶è¿”å›ç¦»çº¿çŠ¶æ€

**ä¸»è¦æ–¹æ³•ï¼š**
```java
// æ‰¹é‡æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
public Map<Long, DeviceStatus> batchGetDeviceStatus(List<Long> deviceIds)

// å•ä¸ªæŸ¥è¯¢è®¾å¤‡çŠ¶æ€
public DeviceStatus getDeviceStatus(Long deviceId)
```

### ç½‘å…³æ¨¡å— (yudao-module-iot-gateway)

#### 5. è®¾å¤‡çŠ¶æ€æŸ¥è¯¢æ¥å£
**æ–‡ä»¶ï¼š** `DeviceStatusController.java`

**æä¾›çš„æ¥å£ï¼š**
- `GET /gateway/device/status/get?deviceId={id}` - æŸ¥è¯¢å•ä¸ªè®¾å¤‡çŠ¶æ€
- `POST /gateway/device/status/batch` - æ‰¹é‡æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
- `GET /gateway/device/status/online-devices` - è·å–æ‰€æœ‰åœ¨çº¿è®¾å¤‡

## âš™ï¸ é…ç½®è¯´æ˜

### application.yaml é…ç½®

```yaml
yudao:
  iot:
    gateway:
      url: http://localhost:48889  # GatewayæœåŠ¡åœ°å€
      token: ""  # å¯é€‰çš„è®¤è¯tokenï¼ˆå¦‚æœGatewayéœ€è¦ï¼‰
```

### è¶…æ—¶é…ç½®

åœ¨ `GatewayClient` æ„é€ å‡½æ•°ä¸­é…ç½®ï¼š
```java
factory.setConnectTimeout(5000); // 5s è¿æ¥è¶…æ—¶
factory.setReadTimeout(15000);   // 15s è¯»å–è¶…æ—¶
```

## ğŸ”„ è°ƒç”¨æµç¨‹

### 1. å‰ç«¯è¯·æ±‚è®¾å¤‡åˆ†é¡µ
```
GET /admin-api/iot/device/page?pageNo=1&pageSize=10
```

### 2. åç«¯å¤„ç†æµç¨‹
```
IotDeviceController.getDevicePage()
    â†“
IotDeviceServiceImpl.getDevicePage()  // æŸ¥è¯¢æ•°æ®åº“
    â†“
IotDeviceServiceImpl.fillDeviceRealTimeStatus()  // è¡¥å……å®æ—¶çŠ¶æ€
    â†“
GatewayClient.batchGetDeviceStatus()  // HTTPè°ƒç”¨Gateway
    â†“
POST http://localhost:48889/gateway/device/status/batch
    â†“
DeviceStatusController.batchGetDeviceStatus()  // Gatewayå¤„ç†
    â†“
DeviceConnectionManager.isDeviceOnline()  // æŸ¥è¯¢å®é™…è¿æ¥çŠ¶æ€
```

### 3. è¿”å›ç»™å‰ç«¯
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 123,
        "deviceName": "æ‘„åƒå¤´01",
        "state": 1,  // âœ… å®æ—¶çŠ¶æ€ï¼š1=åœ¨çº¿, 2=ç¦»çº¿
        ...
      }
    ],
    "total": 100
  }
}
```

## ğŸš¨ å¼‚å¸¸å¤„ç†

### Gatewayä¸å¯è¾¾
- **ç°è±¡ï¼š** GatewayæœåŠ¡æœªå¯åŠ¨æˆ–ç½‘ç»œä¸é€š
- **å¤„ç†ï¼š** 5ç§’è¿æ¥è¶…æ—¶åï¼Œä½¿ç”¨æ•°æ®åº“ä¸­çš„çŠ¶æ€
- **æ—¥å¿—ï¼š** `[GatewayClient] è°ƒç”¨Gatewayæ‰¹é‡æŸ¥è¯¢è®¾å¤‡çŠ¶æ€å¼‚å¸¸`

### Gatewayè¿”å›é”™è¯¯
- **ç°è±¡ï¼š** Gatewayè¿”å›é200çŠ¶æ€ç æˆ–code!=0
- **å¤„ç†ï¼š** ä½¿ç”¨æ•°æ®åº“ä¸­çš„çŠ¶æ€
- **æ—¥å¿—ï¼š** `[GatewayClient] æ‰¹é‡æŸ¥è¯¢è®¾å¤‡çŠ¶æ€å¤±è´¥`

### æ•°æ®è½¬æ¢å¼‚å¸¸
- **ç°è±¡ï¼š** Gatewayè¿”å›çš„æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
- **å¤„ç†ï¼š** æ•è·å¼‚å¸¸ï¼Œä½¿ç”¨æ•°æ®åº“ä¸­çš„çŠ¶æ€
- **æ—¥å¿—ï¼š** `[fillDeviceRealTimeStatus] å¡«å……è®¾å¤‡å®æ—¶çŠ¶æ€å¤±è´¥`

## âœ… æµ‹è¯•è¦ç‚¹

### 1. æ­£å¸¸åœºæ™¯
- Gatewayæ­£å¸¸è¿è¡Œ
- è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- åˆ†é¡µæŸ¥è¯¢æ€§èƒ½æ­£å¸¸ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰

### 2. å¼‚å¸¸åœºæ™¯
- Gatewayæœªå¯åŠ¨ â†’ åº”æ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€ï¼Œä¸æŠ¥é”™
- Gatewayè¶…æ—¶ â†’ 5ç§’åé™çº§ï¼Œä¸é˜»å¡
- ç½‘ç»œå¼‚å¸¸ â†’ ä¼˜é›…é™çº§

### 3. æ€§èƒ½æµ‹è¯•
- 100ä¸ªè®¾å¤‡çš„åˆ†é¡µæŸ¥è¯¢ â†’ åº”åœ¨1ç§’å†…å®Œæˆ
- Gatewayå“åº”æ—¶é—´ â†’ åº”åœ¨100mså†…

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡æŸ¥è¯¢
- ä¸€æ¬¡HTTPè¯·æ±‚æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡çŠ¶æ€
- é¿å…N+1æŸ¥è¯¢é—®é¢˜

### è¶…æ—¶æ§åˆ¶
- è¿æ¥è¶…æ—¶ï¼š5ç§’
- è¯»å–è¶…æ—¶ï¼š15ç§’
- é¿å…é•¿æ—¶é—´é˜»å¡

### å¤±è´¥é™çº§
- Gatewayè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨æ•°æ®åº“çŠ¶æ€
- ä¸å½±å“ä¸»æµç¨‹

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¼˜åŒ–**
   - Gatewayå¯ä»¥ç¼“å­˜è®¾å¤‡çŠ¶æ€ï¼ˆRedisï¼‰
   - å‡å°‘å®æ—¶æŸ¥è¯¢å‹åŠ›

2. **WebSocketæ¨é€**
   - è®¾å¤‡çŠ¶æ€å˜åŒ–æ—¶ä¸»åŠ¨æ¨é€åˆ°å‰ç«¯
   - å‡å°‘è½®è¯¢æŸ¥è¯¢

3. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**
   - Gatewayæ”¯æŒåˆ†æ‰¹æŸ¥è¯¢ï¼ˆå¦‚æ¯æ‰¹100ä¸ªï¼‰
   - é¿å…å•æ¬¡æŸ¥è¯¢è®¾å¤‡è¿‡å¤š

4. **ç›‘æ§å‘Šè­¦**
   - ç›‘æ§Gatewayè°ƒç”¨æˆåŠŸç‡
   - ç›‘æ§å“åº”æ—¶é—´
   - å¼‚å¸¸æ—¶å‘Šè­¦

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Gatewayå¿…é¡»å…ˆå®ç° `DeviceConnectionManager`**
2. **Gatewayéœ€è¦å•ç‹¬å¯åŠ¨**ï¼Œç›‘å¬48889ç«¯å£
3. **ä¸šåŠ¡æ¨¡å—å’ŒGatewayå¯ä»¥ç‹¬ç«‹éƒ¨ç½²**
4. **ç¡®ä¿ç½‘ç»œè¿é€šæ€§**ï¼ˆç‰¹åˆ«æ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰
5. **é…ç½®æ­£ç¡®çš„Gatewayåœ°å€**

## ğŸ¯ æ€»ç»“

é€šè¿‡è¿™ä¸ªåŠŸèƒ½ï¼Œå®ç°äº†ï¼š
- âœ… è®¾å¤‡ç®¡ç†é¡µé¢æ˜¾ç¤º**å®æ—¶åœ¨çº¿çŠ¶æ€**
- âœ… ä¸šåŠ¡æ¨¡å—å’Œç½‘å…³æ¨¡å—**å®Œå…¨è§£è€¦**
- âœ… **é«˜æ€§èƒ½**æ‰¹é‡æŸ¥è¯¢
- âœ… **é«˜å¯ç”¨**å¤±è´¥é™çº§
- âœ… **æ˜“ç»´æŠ¤**æ¸…æ™°çš„æ¶æ„

ç¬¦åˆå¾®æœåŠ¡è®¾è®¡åŸåˆ™ï¼Œä¸¤ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ï¼

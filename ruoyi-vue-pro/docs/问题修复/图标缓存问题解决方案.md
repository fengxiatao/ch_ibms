# 设备图标缓存问题解决方案

## 📝 问题描述

更换了产品的图片和图标后，在以下位置没有立即生效：
1. 编辑平面图中的设备模板图标
2. 实时预览中的电子地图中的设备图标

## 🔍 根本原因

### 1. **后端 Redis 缓存**
- 产品信息被 Redis 缓存（`@Cacheable`）
- 更新产品后缓存未及时清理

### 2. **前端浏览器缓存**
- 浏览器缓存了旧的图片文件
- URL 没有变化，浏览器不会重新请求

### 3. **CDN 缓存**（如果使用了 CDN）
- CDN 缓存了旧的图片
- 需要手动刷新 CDN 缓存

---

## ✅ 解决方案（完整版）

### 方案 1：清理后端 Redis 缓存（立即生效）

#### 方法 A：通过 Redis CLI

```bash
# 连接 Redis
redis-cli -h 192.168.1.126 -p 6379

# 查看所有产品缓存
KEYS iot:product:*

# 删除特定产品的缓存（例如产品ID=1）
DEL iot:product:1

# 或删除所有产品缓存
DEL iot:product:*
```

#### 方法 B：重启应用（最简单）

```bash
# 停止应用
./stop.sh

# 启动应用
./start.sh
```

**优点**：清空所有缓存，确保最新数据
**缺点**：会影响所有在线用户，短暂中断服务

---

### 方案 2：强制前端刷新（用户操作）

#### 方法 A：强制刷新浏览器

- **Windows/Linux**: `Ctrl + F5` 或 `Ctrl + Shift + R`
- **Mac**: `Cmd + Shift + R`

#### 方法 B：清除浏览器缓存

1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

#### 方法 C：禁用缓存（开发时）

在开发者工具中：
1. 打开 Network 面板
2. 勾选 "Disable cache"
3. 刷新页面

---

### 方案 3：前端添加时间戳（推荐，长期方案）

#### 前端代码修改示例

```javascript
// ❌ 旧代码：直接使用 URL
<img :src="product.icon" />

// ✅ 新代码：添加时间戳参数
<img :src="addTimestamp(product.icon)" />

// 工具函数
function addTimestamp(url) {
  if (!url) return '';
  const separator = url.includes('?') ? '&' : '?';
  return `${url}${separator}t=${Date.now()}`;
}
```

#### 或者在后端添加版本号

```java
// 在产品 VO 中添加 iconVersion 字段
@Schema(description = "图标版本", example = "1730899200000")
private Long iconVersion;

// 在更新产品时自动更新版本
product.setIconVersion(System.currentTimeMillis());

// 前端使用
<img :src="`${product.icon}?v=${product.iconVersion}`" />
```

---

### 方案 4：后端代码优化（已实现）

#### 修改 1：在缓存清理前就清理缓存

```java
@CacheEvict(value = RedisKeyConstants.PRODUCT, key = "#updateReqVO.id", beforeInvocation = true)
public void updateProduct(IotProductSaveReqVO updateReqVO) {
    // ... 更新逻辑
}
```

**作用**：确保即使更新失败，缓存也会被清理

#### 修改 2：添加日志记录

```java
if (StrUtil.isNotEmpty(updateReqVO.getIcon()) || StrUtil.isNotEmpty(updateReqVO.getPicUrl())) {
    log.info("[updateProduct] 产品图标已更新 - 产品ID: {}, icon: {}, picUrl: {}", 
            updateReqVO.getId(), updateReqVO.getIcon(), updateReqVO.getPicUrl());
}
```

**作用**：方便排查问题，可以通过日志确认图标是否真的更新了

---

## 🚀 立即执行步骤（推荐）

### Step 1：重启应用（最简单）

```bash
# 重启应用以清空所有 Redis 缓存
./restart.sh
```

### Step 2：强制刷新浏览器

- 按 `Ctrl + F5` 强制刷新

### Step 3：验证更新

1. 打开开发者工具（F12）
2. 进入 Network 面板
3. 筛选图片请求（Filter: img）
4. 检查图标 URL 是否正确
5. 查看图片是否是新的

---

## 📊 验证缓存清理是否成功

### 方法 1：查看 Redis

```bash
# 连接 Redis
redis-cli -h 192.168.1.126 -p 6379

# 查看产品缓存
GET iot:product:1

# 如果返回 (nil) 说明缓存已清理
```

### 方法 2：查看后端日志

```bash
# 查看日志中是否有以下信息
tail -f logs/app.log | grep "产品图标已更新"

# 应该看到：
# [updateProduct] 产品图标已更新 - 产品ID: 1, icon: http://..., picUrl: http://...
```

### 方法 3：查看数据库

```sql
-- 查看产品图标字段
SELECT id, name, icon, pic_url, update_time 
FROM iot_product 
WHERE id = 1;

-- 检查 update_time 是否是最新的
```

---

## ⚠️ 常见问题

### Q1：重启应用后还是看不到新图标？

**原因**：可能是浏览器缓存
**解决**：按 `Ctrl + Shift + Delete` 清除浏览器缓存

### Q2：部分设备图标更新了，部分没更新？

**原因**：可能是 GIS 数据库的设备表没有同步
**解决**：检查设备是否关联了正确的产品 ID

```sql
-- 查询 GIS 数据库中的设备产品关联
SELECT id, name, product_id 
FROM iot_device 
WHERE product_id = 1;
```

### Q3：如何避免以后再出现这个问题？

**推荐做法**：
1. ✅ 前端添加时间戳参数：`url?t=${Date.now()}`
2. ✅ 后端使用版本号字段：`icon_version`
3. ✅ 上传新图片时使用新的文件名（推荐）

**最佳实践**：
```javascript
// 前端上传文件时，自动在文件名中加时间戳
const filename = `${productName}_${Date.now()}.${extension}`;
```

这样每次上传都会生成新的 URL，彻底避免缓存问题！

---

## 📋 总结

| 方案 | 立即生效 | 持久有效 | 难度 | 推荐度 |
|------|---------|---------|------|--------|
| 重启应用 | ✅ 是 | ❌ 否 | 简单 | ⭐⭐⭐⭐ |
| 清理 Redis | ✅ 是 | ❌ 否 | 中等 | ⭐⭐⭐ |
| 强制刷新浏览器 | ✅ 是 | ❌ 否 | 简单 | ⭐⭐⭐⭐ |
| 前端添加时间戳 | ✅ 是 | ✅ 是 | 中等 | ⭐⭐⭐⭐⭐ |
| 使用新文件名 | ✅ 是 | ✅ 是 | 简单 | ⭐⭐⭐⭐⭐ |

**最终建议**：
1. **立即**：重启应用 + 强制刷新浏览器
2. **长期**：前端添加时间戳参数，或上传时使用新文件名

---

## 🔧 代码修改记录

### 后端修改

**文件**：`IotProductServiceImpl.java`

**修改内容**：
1. `@CacheEvict` 添加 `beforeInvocation = true`
2. 添加图标更新日志

### 前端修改（待实施）

**建议修改文件**：
- 平面图编辑器组件
- 电子地图组件

**修改内容**：
```javascript
// 工具函数：添加时间戳
function addCacheBuster(url) {
  if (!url) return '';
  const separator = url.includes('?') ? '&' : '?';
  return `${url}${separator}v=${Date.now()}`;
}

// 使用示例
<img :src="addCacheBuster(device.icon)" />
```

---

## 📞 联系支持

如果以上方案都无法解决问题，请联系技术支持并提供：
1. 产品 ID
2. 新图标的 URL
3. 浏览器开发者工具的 Network 截图
4. 后端日志中的相关记录


































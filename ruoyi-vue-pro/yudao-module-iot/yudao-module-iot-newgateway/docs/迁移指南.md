# IoT 网关迁移指南

## 概述

本文档描述了从旧网关模块 (`yudao-module-iot-gateway`) 迁移到新网关模块 (`yudao-module-iot-newgateway`) 的完整指南。

### 为什么要迁移？

| 旧网关问题 | 新网关解决方案 |
|-----------|---------------|
| 设备类型间代码耦合 | 每个设备类型独立插件 |
| 修改一个设备影响其他设备 | 插件间完全隔离 |
| 代码职责不清晰 | 核心框架与插件分离 |
| 难以添加新设备类型 | 复制模板即可扩展 |
| 无法按需启用设备 | 配置化启用/禁用插件 |

---

## 一、迁移步骤

### 1.1 添加新网关依赖

在 `yudao-server/pom.xml` 中添加：

```xml
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-module-iot-newgateway</artifactId>
    <version>${revision}</version>
</dependency>
```

### 1.2 添加配置

在 `application.yaml` 中添加新网关配置：

```yaml
iot:
  newgateway:
    core:
      heartbeat-check-interval: 30000    # 心跳检测间隔
      device-offline-threshold: 90000    # 离线判定阈值
      worker-threads: 4                  # 工作线程数
      health-check-enabled: true         # 启用健康检查
      metrics-enabled: true              # 启用指标收集
    
    plugins:
      # 插件启用配置（初始全部禁用）
      enabled:
        alarm: false
        changhui: false
        access-gen1: false
        access-gen2: false
        nvr: false
```

### 1.3 逐步启用插件

按设备类型逐个启用并验证：

**第一步：启用报警主机插件**
```yaml
iot:
  newgateway:
    plugins:
      enabled:
        alarm: true
      alarm:
        port: 9500
        heartbeat-timeout: 60000
```

**第二步：验证功能**
- 设备连接/断开
- 心跳检测
- 命令执行
- 事件上报

**第三步：启用下一个插件**

重复以上步骤，直到所有插件迁移完成。

### 1.4 停用旧网关

所有插件验证通过后：

1. 从 `yudao-server/pom.xml` 移除旧网关依赖
2. 删除 `yudao-module-iot-gateway` 模块
3. 从父 `pom.xml` 移除模块引用

---

## 二、配置变更

### 2.1 配置前缀变更

| 旧配置 | 新配置 |
|-------|-------|
| `iot.gateway.*` | `iot.newgateway.*` |
| `iot.gateway.tcp.port` | `iot.newgateway.plugins.{type}.port` |
| `iot.gateway.alarm.*` | `iot.newgateway.plugins.alarm.*` |

### 2.2 各插件配置

#### 报警主机 (alarm)
```yaml
iot.newgateway.plugins:
  alarm:
    port: 9500                # TCP监听端口
    heartbeat-timeout: 60000  # 心跳超时（毫秒）
```

#### 长辉TCP (changhui)
```yaml
iot.newgateway.plugins:
  changhui:
    port: 9700                # TCP监听端口
    heartbeat-timeout: 60000  # 心跳超时（毫秒）
    upgrade-timeout: 300000   # 升级超时（毫秒）
```

#### 门禁一代 (access-gen1)
```yaml
iot.newgateway.plugins:
  access-gen1:
    sdk-path: ""              # 大华SDK路径
    reconnect-interval: 30000 # 重连间隔（毫秒）
```

#### 门禁二代 (access-gen2)
```yaml
iot.newgateway.plugins:
  access-gen2:
    sdk-path: ""              # 大华SDK路径
    reconnect-interval: 30000 # 重连间隔（毫秒）
```

#### NVR (nvr)
```yaml
iot.newgateway.plugins:
  nvr:
    sdk-path: ""              # 大华SDK路径
    reconnect-interval: 30000 # 重连间隔（毫秒）
```

### 2.3 日志配置

```yaml
logging:
  level:
    cn.iocoder.yudao.module.iot.newgateway.core: INFO
    cn.iocoder.yudao.module.iot.newgateway.plugins: INFO
    cn.iocoder.yudao.module.iot.newgateway.consumer: INFO
```

### 2.4 监控端点配置

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,gateway,gateway-metrics
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
    gateway-metrics:
      enabled: true
```

---

## 三、兼容性说明

### 3.1 消息主题兼容

新网关复用 `iot-core` 中的消息主题，**与旧网关完全兼容**：

| 主题 | 说明 |
|------|------|
| `iot_device_state_changed` | 设备状态变更 |
| `iot_alarm_host_event` | 报警主机事件 |
| `iot_alarm_host_control` | 报警主机控制 |
| `iot_access_control_device_command` | 门禁控制命令 |
| `iot_access_control_device_response` | 门禁控制响应 |
| `iot_access_control_event` | 门禁事件 |

### 3.2 DTO 兼容

新网关复用 `iot-core` 中的公共 DTO，**Biz 层无需修改**：

- `DeviceStateChangeMessage`
- `DeviceInfo`
- `AccessControlDeviceCommand`
- `AccessControlDeviceResponse`
- `AccessControlEventMessage`

### 3.3 数据库兼容

新网关不涉及数据库变更，使用相同的数据表。

---

## 四、并行运行

### 4.1 端口规划

为避免冲突，新旧网关使用不同端口：

| 设备类型 | 旧网关端口 | 新网关端口（建议） |
|---------|-----------|------------------|
| 报警主机 | 9500 | 9510 |
| 长辉TCP | 9700 | 9710 |

### 4.2 设备分流测试

1. 选择测试设备
2. 修改设备配置指向新网关端口
3. 验证功能正常
4. 逐步迁移更多设备

---

## 五、回滚方案

### 5.1 快速回滚

禁用所有新网关插件：

```yaml
iot:
  newgateway:
    plugins:
      enabled:
        alarm: false
        changhui: false
        access-gen1: false
        access-gen2: false
        nvr: false
```

重启应用即可回滚到旧网关。

### 5.2 完全回滚

1. 移除新网关依赖
2. 删除新网关配置
3. 重新编译部署

---

## 六、监控与验证

### 6.1 健康检查

访问 `/actuator/health` 查看插件健康状态：

```json
{
  "status": "UP",
  "components": {
    "gatewayPlugins": {
      "status": "UP",
      "details": {
        "alarm": "UP",
        "changhui": "UP"
      }
    }
  }
}
```

### 6.2 网关状态

访问 `/actuator/gateway` 查看网关详细状态：

```json
{
  "plugins": {
    "alarm": {
      "enabled": true,
      "onlineDevices": 5
    }
  }
}
```

### 6.3 指标监控

访问 `/actuator/gateway-metrics` 查看指标：

```json
{
  "alarm": {
    "onlineCount": 5,
    "messageCount": 1234,
    "errorCount": 0
  }
}
```

---

## 七、常见问题

### Q1: 迁移过程中设备会断线吗？

使用不同端口并行运行时，设备不会断线。切换时需修改设备配置。

### Q2: Biz 层需要修改吗？

不需要。消息主题和 DTO 保持兼容。

### Q3: 如何添加新设备类型？

参考 `plugins/template/` 目录，复制并实现设备特定逻辑。

### Q4: 新旧网关可以同时处理同一设备吗？

不建议。同一设备应只由一个网关处理。

---

## 八、删除旧网关

迁移完成后，删除旧网关代码：

```bash
# 1. 删除模块目录
rm -rf yudao-module-iot/yudao-module-iot-gateway

# 2. 从父 pom.xml 移除模块引用
# <module>yudao-module-iot-gateway</module>

# 3. 从 yudao-server/pom.xml 移除依赖
# <artifactId>yudao-module-iot-gateway</artifactId>
```

---

## 联系方式

如有问题，请联系 IoT 网关开发团队。

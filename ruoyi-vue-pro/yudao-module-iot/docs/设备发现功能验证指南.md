# 设备发现功能验证指南

## 🎯 修复内容总结

### 问题根源
之前只在 Service 层添加了 `@TenantIgnore`，但 **MyBatis 拦截器仍然会检查租户**，导致：
- ❌ 数据库操作失败
- ❌ `iot_message_idempotent` 表记录 status = `FAILED`
- ❌ `iot_discovered_device` 表**无任何记录**

### 本次修复
在 **Mapper 接口**上添加 `@InterceptorIgnore(tenantLine = "true")`：

| Mapper | 状态 | 说明 |
|--------|------|------|
| `IotMessageIdempotentMapper` | ✅ 已修复 | 消息幂等性检查 |
| `IotDiscoveredDeviceMapper` | ✅ 已修复 | 发现设备记录 |

## 🚀 验证步骤（5分钟）

### 步骤1：重启 Biz 服务

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
cd F:\work\ch_ibms\ruoyi-vue-pro\yudao-server
mvn spring-boot:run
```

**观察启动日志**，应该看到：
```
[DeviceDiscoveredConsumer] 已注册设备发现消息订阅
```

### 步骤2：等待设备发现（自动或手动）

#### 选项A：等待自动扫描（5分钟）

Gateway 会每5分钟自动扫描一次。

**Gateway 日志**（自动出现）：
```
[OnvifScanner] [scan][ONVIF发现设备: 192.168.1.200 (onvif)]
[OnvifScanner] [scan][ONVIF发现设备: 192.168.1.202 (onvif)]
[DeviceDiscoveryManager] [publishDiscoveryEvent][发布设备发现消息: ...]
```

#### 选项B：手动触发（立即测试）

```bash
# 获取 Token
curl -X POST "http://localhost:48080/admin-api/system/auth/login" \
  -H "Content-Type: application/json" \
  -H "tenant-id: 1" \
  -d '{"username": "admin", "password": "admin123"}'

# 手动触发扫描
curl -X POST "http://localhost:48080/admin-api/iot/device/discovery/scan" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"scanType": "onvif", "timeout": 5000}'
```

### 步骤3：观察 Biz 日志（关键）

**✅ 应该看到完整的处理流程**：
```
[DeviceDiscoveredConsumer] [onMessage][收到设备发现消息: 192.168.1.202 (onvif)]
[MessageIdempotentService] [tryProcess][消息可以处理: 192.168.1.202_2025-10-27T...]
[IotDeviceService] [isDeviceExistsByIp][检查设备是否存在: 192.168.1.202]
[DiscoveredDeviceService] [saveDiscoveredDevice][保存发现记录: 192.168.1.202 (onvif)]
[AlertWebSocketHandler] [broadcastMessage][推送 WebSocket 消息]
```

**❌ 不应该看到**：
```
ERROR: TenantContextHolder 不存在租户编号！
```

### 步骤4：检查数据库（最终验证）

```sql
-- 在 MySQL 客户端执行
USE ch_ibms;

-- 1. 检查发现设备表（应该有新记录）
SELECT 
    id, ip, vendor, device_type, 
    discovery_method, discovery_time, 
    added, status
FROM iot_discovered_device
WHERE discovery_time > DATE_SUB(NOW(), INTERVAL 15 MINUTE)
ORDER BY discovery_time DESC;

-- 预期结果：2 条记录
-- 192.168.1.200 | onvif | camera | onvif | 2025-10-27 XX:XX:XX | 0 | 1
-- 192.168.1.202 | onvif | camera | onvif | 2025-10-27 XX:XX:XX | 0 | 1

-- 2. 检查幂等性表（应该是 SUCCESS）
SELECT 
    id, message_id, topic, status, 
    error_message, create_time
FROM iot_message_idempotent
WHERE create_time > DATE_SUB(NOW(), INTERVAL 15 MINUTE)
ORDER BY create_time DESC;

-- 预期结果：2 条记录，status = 'SUCCESS'
-- NOT 'FAILED'
```

## ✅ 成功标准

所有以下条件都满足，则验证通过：

- [x] Biz 日志中有完整的消费流程
- [x] 日志中**没有**租户错误
- [x] `iot_discovered_device` 表有 2 条新记录
- [x] `iot_message_idempotent` 表的 `status` 是 `SUCCESS`
- [x] `error_message` 字段为空

## 🔍 如果还是失败

### 1. 检查编译是否成功

```bash
cd F:\work\ch_ibms\ruoyi-vue-pro\yudao-module-iot\yudao-module-iot-biz
mvn clean compile -DskipTests
```

应该看到：`BUILD SUCCESS`

### 2. 确认 Mapper 有注解

```bash
# 检查 IotMessageIdempotentMapper.java
grep "@InterceptorIgnore" yudao-module-iot-biz/src/main/java/cn/iocoder/yudao/module/iot/dal/mysql/message/IotMessageIdempotentMapper.java

# 检查 IotDiscoveredDeviceMapper.java
grep "@InterceptorIgnore" yudao-module-iot-biz/src/main/java/cn/iocoder/yudao/module/iot/dal/mysql/device/IotDiscoveredDeviceMapper.java
```

应该都能找到：`@InterceptorIgnore(tenantLine = "true")`

### 3. 查看完整错误日志

```bash
# 查找租户相关错误
grep "Tenant" logs/spring.log | tail -20

# 查找设备发现相关日志
grep "DeviceDiscovered" logs/spring.log | tail -30
```

## 📊 验证矩阵

| 检查项 | 预期结果 | 实际结果 | 状态 |
|-------|---------|---------|------|
| Biz 启动日志 | 看到 "已注册设备发现消息订阅" | ☐ | |
| Gateway 发现设备 | 发现 2 个设备（.200, .202） | ☐ | |
| Biz 消费日志 | 看到 "收到设备发现消息" | ☐ | |
| 租户错误 | **没有**租户错误 | ☐ | |
| iot_discovered_device | 有 2 条新记录 | ☐ | |
| iot_message_idempotent | status = SUCCESS | ☐ | |

## 🎨 验证通过后的下一步

### 1. 测试 API（5分钟）

```bash
# 获取最近发现的设备
curl -X GET "http://localhost:48080/admin-api/iot/device/discovery/recent?hours=1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "tenant-id: 1"

# 应该返回 2 个设备的 JSON 数据
```

### 2. 测试 WebSocket（可选）

```javascript
// 在浏览器控制台测试
const ws = new WebSocket('ws://localhost:48080/ws/alert');
ws.onopen = () => console.log('✅ WebSocket 已连接');
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    console.log('收到消息:', msg);
    if (msg.type === 'device_discovered') {
        console.log('✅ 发现新设备通知:', msg.data.device);
    }
};
```

### 3. 规划前端页面（需要开发）

创建前端页面展示发现的设备：
- 页面路径：`/iot/device/discovery`
- 功能：列表、添加、忽略
- WebSocket 实时刷新

## 📁 相关文档

- [Mapper 级别拦截错误详解](./errors/后端_多租户上下文缺失_Mapper级别拦截错误.md)
- [完整业务流程图](./设备发现完整业务流程图.md)
- [API 测试指南](./API测试_设备发现接口.md)
- [多租户检查清单](./多租户_RocketMQ消费者完整检查清单.md)

## 💡 经验总结

**芋道源码多租户框架的关键认识**：

```
处理 RocketMQ 消费者需要两层注解：

1️⃣ Service 层：@TenantIgnore
   └─ 跳过 Spring AOP 的租户检查

2️⃣ Mapper 层：@InterceptorIgnore(tenantLine = "true")  ← 关键！
   └─ 跳过 MyBatis Plus 的租户拦截器

缺一不可！
```

---

**创建时间**：2025-10-27  
**版本**：v2025.09-SNAPSHOT  
**作者**：长辉信息科技有限公司















# è®¾å¤‡å‘ç°åŠŸèƒ½é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æ¸…å•ä¸ä¿®å¤

### 1. âœ… æ‰«æè¿›åº¦å¡åœ¨90%

**é—®é¢˜æè¿°**ï¼š
- å‰ç«¯ç‚¹å‡»"å¼€å§‹æ‰«æ"åï¼Œè¿›åº¦æ¡åˆ°90%å°±ä¸€ç›´åœç•™åœ¨"æ‰«æä¸­..."
- å®é™…å·²å‘ç°è®¾å¤‡ï¼ˆæ—¥å¿—æ˜¾ç¤º21ä¸ªè®¾å¤‡ï¼‰ï¼Œä½†å‰ç«¯æ— æ³•è·å–ç»“æœ

**æ ¹æœ¬åŸå› **ï¼š
- Bizå±‚å‘é€äº† `DEVICE_SCAN_REQUEST` æ¶ˆæ¯åˆ° Gateway
- Gateway **æ²¡æœ‰è®¢é˜…è€…**å¤„ç†è¿™ä¸ªè¯·æ±‚
- å¯¼è‡´æ°¸è¿œæ²¡æœ‰è¿”å› `DEVICE_SCAN_RESULT`
- å‰ç«¯è½®è¯¢è·å–æ‰«æçŠ¶æ€ï¼Œä¸€ç›´æ˜¯ `scanning`

**è§£å†³æ–¹æ¡ˆ**ï¼š
åˆ›å»ºäº†å®Œæ•´çš„è¯·æ±‚-å“åº”æœºåˆ¶ï¼š

```
ã€æ¶ˆæ¯æµç¨‹ã€‘
å‰ç«¯ â†’ Biz (startScan)
  â†“
Biz å‘é€ DEVICE_SCAN_REQUEST â†’ RocketMQ
  â†“
Gateway è®¢é˜…è€…æ¥æ”¶ â†’ æ‰§è¡Œæ‰«æ â†’ å‘é€ DEVICE_SCAN_RESULT
  â†“
Biz è®¢é˜…è€…æ¥æ”¶ â†’ æ›´æ–°æ‰«æçŠ¶æ€
  â†“
å‰ç«¯è½®è¯¢è·å–ç»“æœ â†’ æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
```

**æ–°å¢æ–‡ä»¶**ï¼š
1. `DeviceScanRequest.java` (Core) - æ‰«æè¯·æ±‚DTO
2. `DeviceScanResult.java` (Core) - æ‰«æç»“æœDTO
3. `DeviceScanRequestSubscriber.java` (Gateway) - æ‰«æè¯·æ±‚è®¢é˜…è€…
4. `DeviceScanResultConsumer.java` (Biz) - æ‰«æç»“æœæ¶ˆè´¹è€…

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `IotDeviceDiscoveryController.java` - ä¼˜åŒ–ç»“æœè¿”å›é€»è¾‘

---

### 2. âœ… é‡å¤æ’å…¥è®¾å¤‡ï¼ˆå·²æœ‰å»é‡ï¼‰

**é—®é¢˜æè¿°**ï¼š
å·²æ’å…¥çš„æœªæ¿€æ´»è®¾å¤‡å¯èƒ½é‡å¤æ’å…¥åˆ°æ•°æ®åº“

**å½“å‰å»é‡æœºåˆ¶**ï¼š

#### (1) è‡ªåŠ¨å‘ç°å»é‡ï¼ˆ24å°æ—¶ï¼‰

```java
// DiscoveredDeviceServiceImpl.saveDiscoveredDevice()
// 24å°æ—¶å†…åŒä¸€IPåªè®°å½•ä¸€æ¬¡
IotDiscoveredDeviceDO existing = discoveredDeviceMapper.selectByIpAndTime(
    device.getIp(),
    LocalDateTime.now().minusHours(24)
);
if (existing != null) {
    return false; // æœªä¿å­˜ï¼Œè¿”å› false
}
```

#### (2) è¡¨çº§å”¯ä¸€çº¦æŸ

```sql
-- iot_discovered_device è¡¨
UNIQUE KEY `uk_ip_discovery_time` (`ip`,`discovery_time`,`deleted`)
```

#### (3) å·²æ¿€æ´»è®¾å¤‡æ£€æŸ¥

```java
// DeviceDiscoveredConsumer.onMessage()
boolean exists = deviceService.isDeviceExistsByIp(device.getIp());
if (!exists) {
    // æ¨é€ WebSocket é€šçŸ¥
    pushNewDeviceNotification(device);
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- å‰ç«¯æ¿€æ´»è®¾å¤‡æ—¶ï¼Œå¯ä»¥å¢åŠ  `added` å­—æ®µæ›´æ–°é€»è¾‘
- åœ¨ `getUnaddedDevices()` æŸ¥è¯¢ä¸­è¿‡æ»¤å·²æ¿€æ´»è®¾å¤‡

---

### 3. ğŸ“Œ "å¿½ç•¥"åŠŸèƒ½ä¸šåŠ¡é€»è¾‘

**ä¸šåŠ¡åœºæ™¯**ï¼š
åœ¨è®¾å¤‡å‘ç°è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰«æåˆ°å„ç§ç½‘ç»œè®¾å¤‡ï¼Œä½†å¹¶éæ‰€æœ‰è®¾å¤‡éƒ½éœ€è¦æ¥å…¥ç³»ç»Ÿï¼š

- âœ… **éœ€è¦æ¥å…¥**ï¼šç›‘æ§æ‘„åƒå¤´ã€é—¨ç¦è®¾å¤‡ã€ä¼ æ„Ÿå™¨ç­‰
- âŒ **ä¸éœ€è¦æ¥å…¥**ï¼š
  - å·²åºŸå¼ƒçš„è®¾å¤‡
  - æµ‹è¯•/æ¼”ç¤ºè®¾å¤‡
  - å…¶ä»–ç³»ç»Ÿç®¡ç†çš„è®¾å¤‡
  - éIoTè®¾å¤‡ï¼ˆå¦‚ï¼šè·¯ç”±å™¨ã€æ‰“å°æœºï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼š

| æ“ä½œ | æ•ˆæœ | æ•°æ®åº“çŠ¶æ€ |
|------|------|----------|
| **å¿½ç•¥** | ä»"æœªæ·»åŠ åˆ—è¡¨"ä¸­éšè— | `status` = 3 (å·²å¿½ç•¥) |
| **å¿½ç•¥ï¼ˆ7å¤©ï¼‰** | 7å¤©å†…ä¸æ˜¾ç¤ºï¼Œ7å¤©åé‡æ–°å‡ºç° | `ignore_until` = NOW() + 7å¤© |
| **å¿½ç•¥ï¼ˆæ°¸ä¹…ï¼‰** | æ°¸ä¹…ä¸æ˜¾ç¤º | `ignore_until` = NULL |
| **å–æ¶ˆå¿½ç•¥** | é‡æ–°å‡ºç°åœ¨åˆ—è¡¨ | `status` = 1 (å·²å‘ç°) |

**å®ç°ç»†èŠ‚**ï¼š

```java
// å¿½ç•¥è®¾å¤‡
device.setStatus(DiscoveredDeviceStatusEnum.IGNORED.getStatus());
device.setIgnoredBy(SecurityFrameworkUtils.getLoginUserId());
device.setIgnoredTime(LocalDateTime.now());
if (ignoreDays != null && ignoreDays > 0) {
    device.setIgnoreUntil(LocalDateTime.now().plusDays(ignoreDays));
} else {
    device.setIgnoreUntil(null); // NULL = æ°¸ä¹…å¿½ç•¥
}
```

**å‰ç«¯äº¤äº’**ï¼š

```vue
<el-button link type="warning" @click="handleIgnore(row)">
  å¿½ç•¥
</el-button>

<!-- å¼¹å‡ºç¡®è®¤æ¡† -->
ç¡®å®šè¦å¿½ç•¥è®¾å¤‡ 192.168.1.202 å—ï¼Ÿ
å¿½ç•¥åå°†ä¸å†æç¤ºè¯¥è®¾å¤‡ã€‚
[å–æ¶ˆ] [ç¡®å®š]
```

---

### 4. ğŸ”§ "æµ‹è¯•"åŠŸèƒ½ï¼ˆå¾…å¼€å‘ï¼‰

**ä¸šåŠ¡åœºæ™¯**ï¼š
åœ¨æ¿€æ´»è®¾å¤‡å‰ï¼Œæµ‹è¯•è®¾å¤‡è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œé¿å…æ·»åŠ æ— æ³•è¿æ¥çš„è®¾å¤‡ã€‚

**åŠŸèƒ½è®¾è®¡**ï¼š

#### æµ‹è¯•é¡¹ç›®ï¼š
1. âœ… **ç½‘ç»œè¿é€šæ€§**ï¼šPing è®¾å¤‡IP
2. âœ… **HTTPç«¯å£**ï¼šè®¿é—® `http://{ip}:{port}/`
3. âœ… **ONVIFæœåŠ¡**ï¼šè°ƒç”¨ `GetDeviceInformation`
4. âœ… **RTSPæµ**ï¼šéªŒè¯è§†é¢‘æµåœ°å€

#### å®ç°æ­¥éª¤ï¼š

**Step 1ï¼šåˆ›å»ºæµ‹è¯•API**

```java
// IotDeviceDiscoveryController.java
@PostMapping("/test/{id}")
@Operation(summary = "æµ‹è¯•è®¾å¤‡è¿æ¥")
public CommonResult<DeviceTestResult> testDevice(@PathVariable("id") Long id) {
    return success(deviceDiscoveryService.testDeviceConnection(id));
}
```

**Step 2ï¼šå®ç°æµ‹è¯•é€»è¾‘**

```java
// IotDeviceDiscoveryService.java
public DeviceTestResult testDeviceConnection(Long id) {
    IotDiscoveredDeviceDO device = discoveredDeviceMapper.selectById(id);
    
    DeviceTestResult result = new DeviceTestResult();
    result.setIp(device.getIp());
    
    // 1. Pingæµ‹è¯•
    result.setPingSuccess(pingDevice(device.getIp()));
    
    // 2. HTTPæµ‹è¯•
    result.setHttpSuccess(testHttp(device.getIp(), device.getHttpPort()));
    
    // 3. ONVIFæµ‹è¯•
    result.setOnvifSuccess(testOnvif(device.getIp(), device.getOnvifPort()));
    
    // 4. RTSPæµ‹è¯•
    result.setRtspSuccess(testRtsp(device.getIp(), device.getRtspPort()));
    
    return result;
}
```

**Step 3ï¼šå‰ç«¯æ˜¾ç¤ºæµ‹è¯•ç»“æœ**

```vue
<el-button link type="success" @click="handleTest(row)">
  æµ‹è¯•
</el-button>

<!-- æµ‹è¯•ç»“æœå¯¹è¯æ¡† -->
<el-dialog title="è®¾å¤‡è¿æ¥æµ‹è¯•" v-model="testDialogVisible">
  <el-descriptions :column="1">
    <el-descriptions-item label="IPåœ°å€">192.168.1.202</el-descriptions-item>
    <el-descriptions-item label="Pingæµ‹è¯•">
      <el-tag :type="testResult.pingSuccess ? 'success' : 'danger'">
        {{ testResult.pingSuccess ? 'é€šè¿‡' : 'å¤±è´¥' }}
      </el-tag>
    </el-descriptions-item>
    <el-descriptions-item label="HTTPç«¯å£">
      <el-tag :type="testResult.httpSuccess ? 'success' : 'danger'">
        {{ testResult.httpSuccess ? 'é€šè¿‡' : 'å¤±è´¥' }}
      </el-tag>
    </el-descriptions-item>
    <el-descriptions-item label="ONVIFæœåŠ¡">
      <el-tag :type="testResult.onvifSuccess ? 'success' : 'danger'">
        {{ testResult.onvifSuccess ? 'é€šè¿‡' : 'å¤±è´¥' }}
      </el-tag>
    </el-descriptions-item>
    <el-descriptions-item label="RTSPæµ">
      <el-tag :type="testResult.rtspSuccess ? 'success' : 'danger'">
        {{ testResult.rtspSuccess ? 'é€šè¿‡' : 'å¤±è´¥' }}
      </el-tag>
    </el-descriptions-item>
  </el-descriptions>
</el-dialog>
```

**å½“å‰çŠ¶æ€**ï¼š
```javascript
// ä¸´æ—¶å®ç°
const handleTest = async (device: any) => {
  ElMessage.info('æµ‹è¯•è¿æ¥åŠŸèƒ½å¼€å‘ä¸­...')
  // TODO: å®ç°æµ‹è¯•è¿æ¥åŠŸèƒ½
}
```

---

## ğŸš€ éªŒè¯æ­¥éª¤

### 1. é‡å¯æœåŠ¡

```bash
# åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
# Gateway
cd F:\work\ch_ibms\ruoyi-vue-pro\yudao-module-iot\yudao-module-iot-gateway
mvn spring-boot:run

# Biz (åœ¨æ–°çª—å£)
cd F:\work\ch_ibms\ruoyi-vue-pro\yudao-server
mvn spring-boot:run
```

### 2. æµ‹è¯•æ‰«æåŠŸèƒ½

1. **è®¿é—®è®¾å¤‡å‘ç°é¡µé¢**
   ```
   http://localhost:3000/iot/device/discovery
   ```

2. **ç‚¹å‡»"å¼€å§‹æ‰«æ"**

3. **è§‚å¯Ÿè¿›åº¦**ï¼š
   - è¿›åº¦æ¡åº”è¯¥ä» 0% â†’ 90% â†’ 100%
   - æ˜¾ç¤º"æ‰«æå®Œæˆï¼å‘ç° X ä¸ªè®¾å¤‡"
   - åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºå‘ç°çš„è®¾å¤‡

4. **æŸ¥çœ‹åç«¯æ—¥å¿—**ï¼š

**Gatewayæ—¥å¿—**ï¼š
```
[DeviceScanRequestSubscriber] æ”¶åˆ°è®¾å¤‡æ‰«æè¯·æ±‚: scanId=xxx
[DeviceDiscoveryManager] å¼€å§‹è‡ªåŠ¨å‘ç°è®¾å¤‡
[OnvifScanner] ONVIFå‘ç°è®¾å¤‡: 192.168.1.200
[OnvifScanner] ONVIFå‘ç°è®¾å¤‡: 192.168.1.202
[DeviceScanRequestSubscriber] æ‰«æå®Œæˆ: scanId=xxx, å‘ç°2ä¸ªè®¾å¤‡
```

**Bizæ—¥å¿—**ï¼š
```
[DeviceScanResultConsumer] æ”¶åˆ°è®¾å¤‡æ‰«æç»“æœ: scanId=xxx, status=completed, deviceCount=2
[IotDeviceDiscoveryServiceImpl] æ‰«æå®Œæˆ: scanId=xxx, å‘ç°2ä¸ªè®¾å¤‡
```

### 3. æµ‹è¯•å¿½ç•¥åŠŸèƒ½

1. é€‰æ‹©ä¸€ä¸ªè®¾å¤‡ï¼Œç‚¹å‡»"å¿½ç•¥"
2. ç¡®è®¤å¼¹çª—ï¼Œç‚¹å‡»"ç¡®å®š"
3. è§‚å¯Ÿï¼š
   - æç¤º"å·²å¿½ç•¥è¯¥è®¾å¤‡"
   - è®¾å¤‡ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
4. æŸ¥è¯¢æ•°æ®åº“ï¼š
   ```sql
   SELECT ip, status, ignored_by, ignored_time 
   FROM iot_discovered_device 
   WHERE ip = '192.168.1.202';
   ```
   åº”è¯¥æ˜¾ç¤º `status = 3 (å·²å¿½ç•¥)`

---

## ğŸ“Š æ¶‰åŠçš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰

| æ¨¡å— | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| Core | `DeviceScanRequest.java` | æ‰«æè¯·æ±‚DTO |
| Core | `DeviceScanResult.java` | æ‰«æç»“æœDTO |
| Gateway | `DeviceScanRequestSubscriber.java` | å¤„ç†æ‰«æè¯·æ±‚ |
| Biz | `DeviceScanResultConsumer.java` | å¤„ç†æ‰«æç»“æœ |
| Docs | `è®¾å¤‡å‘ç°åŠŸèƒ½é—®é¢˜ä¿®å¤è¯´æ˜.md` | æœ¬æ–‡æ¡£ |
| Docs | `è®¾å¤‡å‘ç°åŠŸèƒ½éªŒè¯æŒ‡å—.md` | ï¼ˆå·²æœ‰ï¼‰éªŒè¯æŒ‡å— |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

| æ¨¡å— | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| Biz | `IotDeviceDiscoveryController.java` | ä¼˜åŒ–æ‰«æç»“æœè¿”å›é€»è¾‘ |
| Gateway | åˆ é™¤ `DeviceScanSubscriber.java` | åˆ é™¤æ—§çš„å†²çªæ–‡ä»¶ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
- [ ] å®ç°"æµ‹è¯•è¿æ¥"åŠŸèƒ½
- [ ] ä¼˜åŒ–è®¾å¤‡å»é‡é€»è¾‘
- [ ] æ·»åŠ "å·²æ¿€æ´»è®¾å¤‡"è¿‡æ»¤

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰
- [ ] æ”¯æŒæ‰‹åŠ¨æŒ‡å®šIPèŒƒå›´æ‰«æ
- [ ] æ”¯æŒæ‰«æå†å²è®°å½•æŸ¥è¯¢
- [ ] æ”¯æŒæ‰¹é‡å¿½ç•¥/æ¿€æ´»

### é•¿æœŸ
- [ ] æ”¯æŒå¤šç§è®¾å¤‡åè®®ï¼ˆUPnP, Bonjourç­‰ï¼‰
- [ ] AIè¯†åˆ«è®¾å¤‡ç±»å‹
- [ ] è®¾å¤‡å¥åº·åº¦è¯„åˆ†

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ‰«æååˆ—è¡¨æ˜¯ç©ºçš„ï¼Ÿ

**A:** å¯èƒ½åŸå› ï¼š
1. è®¾å¤‡å·²ç»åœ¨24å°æ—¶å†…å‘ç°è¿‡ï¼ˆå»é‡ï¼‰
2. è®¾å¤‡å·²ç»æ¿€æ´»æ·»åŠ åˆ°ç³»ç»Ÿ
3. è®¾å¤‡å·²è¢«å¿½ç•¥

**è§£å†³æ–¹æ³•**ï¼š
- ç‚¹å‡»"æœ€è¿‘å‘ç°"æŸ¥çœ‹æ‰€æœ‰è®°å½•
- æ£€æŸ¥æ•°æ®åº“ `iot_discovered_device` è¡¨

### Q2: æ‰«æå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A:** æ‰«ææ—¶é—´å–å†³äºï¼š
- ç½‘ç»œç¯å¢ƒï¼ˆå±€åŸŸç½‘ vs å¹¿åŸŸç½‘ï¼‰
- è®¾å¤‡æ•°é‡
- æ‰«æç±»å‹ï¼ˆONVIF > SSDP > ARPï¼‰

**ä¼˜åŒ–å»ºè®®**ï¼š
- å‡å°‘æ‰«æè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤5ç§’ï¼‰
- æŒ‡å®šIPèŒƒå›´ç¼©å°æ‰«æèŒƒå›´
- ä½¿ç”¨æ›´å¿«çš„æ‰«æåè®®

### Q3: å¦‚ä½•æŸ¥çœ‹å·²å¿½ç•¥çš„è®¾å¤‡ï¼Ÿ

**A:** 
```sql
SELECT * FROM iot_discovered_device 
WHERE status = 3  -- å·²å¿½ç•¥
ORDER BY ignored_time DESC;
```

æˆ–ç­‰å¾…å‰ç«¯"å·²å¿½ç•¥åˆ—è¡¨"åŠŸèƒ½å¼€å‘å®Œæˆã€‚

---

**ä¿®å¤æ—¶é—´**ï¼š2025-10-27  
**ç‰ˆæœ¬**ï¼šv2025.09-SNAPSHOT  
**ä½œè€…**ï¼šé•¿è¾‰ä¿¡æ¯ç§‘æŠ€æœ‰é™å…¬å¸















# IoT 消息通信架构说明

## 🚨 重要澄清：RocketMQ vs MQTT

您提出的问题非常关键！这涉及到项目中两个完全不同的消息通信场景。

---

## 1. 两种消息通信场景

### 场景1：物理设备 ↔ Gateway（设备接入层）
**使用协议：MQTT、ONVIF、HTTP 等**

```
┌─────────────┐                 ┌─────────────────────┐
│  物理设备    │   MQTT 协议     │   Gateway 模块      │
│ (摄像头/传感器)│ ────────────→ │  (iot-gateway)      │
│             │   1883端口      │                     │
└─────────────┘                 └─────────────────────┘
```

**这里的 MQTT：**
- ✅ 用于**物理设备**连接到网关
- ✅ 符合 IoT 设备标准（AIOT 标准文档描述的就是这个）
- ✅ 网关作为 MQTT Broker（或连接外部 EMQX）
- ✅ 设备使用 MQTT Topic：`$oc/devices/{device_id}/sys/...`

### 场景2：Gateway ↔ Biz（内部模块通信）
**使用协议：RocketMQ**

```
┌─────────────────────┐         ┌─────────────────────┐
│   Gateway 模块      │ RocketMQ│   Biz 模块          │
│  (iot-gateway)      │ ─────→  │  (iot-biz)          │
│                     │Topic    │                     │
└─────────────────────┘         └─────────────────────┘
```

**这里的 RocketMQ：**
- ✅ 用于**内部微服务**之间通信
- ✅ Gateway 和 Biz 是两个独立的 Spring Boot 应用
- ✅ 使用 RocketMQ Topic：`iot.device.online`、`iot.device.discovered` 等

---

## 2. 完整的通信链路

```
物理设备 → Gateway → Biz → 前端
   │          │        │       │
   │          │        │       │
  MQTT    RocketMQ  WebSocket HTTP
```

### 2.1 上行链路（设备数据上报）

```
1. 摄像头 ─ MQTT ─→ Gateway (MQTT Server)
   Topic: $oc/devices/camera_001/sys/properties/report
   
2. Gateway ─ RocketMQ ─→ Biz
   Topic: iot.device.property.reported
   
3. Biz ─ WebSocket ─→ 前端
   消息推送给管理员
```

### 2.2 下行链路（设备控制）

```
1. 前端 ─ HTTP ─→ Biz
   API: /iot/device/command/invoke
   
2. Biz ─ RocketMQ ─→ Gateway
   Topic: iot.device.service.invoke
   
3. Gateway ─ MQTT ─→ 摄像头
   Topic: $oc/devices/camera_001/sys/commands/request_id=xxx
```

---

## 3. 为什么使用 RocketMQ 而不是 MQTT？

### Gateway ↔ Biz 使用 RocketMQ 的原因

| 特性 | RocketMQ | MQTT |
|------|----------|------|
| **场景** | 企业级微服务通信 | 物联网设备通信 |
| **消息可靠性** | ✅ 强一致性，持久化 | ⚠️ QoS 0-2 |
| **消息顺序** | ✅ 顺序消费 | ❌ 无保证 |
| **消息积压** | ✅ 支持百万级积压 | ⚠️ Broker 压力大 |
| **消费模型** | ✅ 推送+拉取 | 推送 |
| **事务消息** | ✅ 支持 | ❌ 不支持 |
| **死信队列** | ✅ 支持 | ❌ 不支持 |
| **延时消息** | ✅ 支持 | ❌ 不支持 |
| **运维成熟度** | ✅ 阿里巴巴生产验证 | ⚠️ 需要额外 Broker |

### 物理设备使用 MQTT 的原因

| 特性 | MQTT | HTTP/其他 |
|------|------|----------|
| **轻量级** | ✅ 协议开销小 | ❌ HTTP 较重 |
| **低功耗** | ✅ 适合电池设备 | ❌ 功耗较高 |
| **双向通信** | ✅ 天然支持 | ⚠️ HTTP 需轮询 |
| **QoS** | ✅ 3个等级 | ❌ 无 |
| **断线重连** | ✅ 自动处理 | ❌ 需自行实现 |
| **行业标准** | ✅ IoT 事实标准 | - |

---

## 4. 当前项目的实际使用情况

### 4.1 RocketMQ 使用场景（内部通信）

#### Gateway → Biz
1. **设备生命周期**
   ```java
   Topic: iot.device.online
   Topic: iot.device.offline
   ```

2. **设备发现**
   ```java
   Topic: iot.device.discovered
   ```

3. **事件上报**
   ```java
   Topic: iot.device.event.reported
   ```

4. **服务调用响应**
   ```java
   Topic: iot.device.service.result
   ```

#### Biz → Gateway
1. **设备连接控制**
   ```java
   Topic: iot.device.connect.request
   Topic: iot.device.disconnect.request
   ```

2. **服务调用**
   ```java
   Topic: iot.device.service.invoke
   ```

3. **设备扫描**
   ```java
   Topic: iot.device.scan.request
   ```

### 4.2 MQTT 使用场景（设备接入）

#### 当前实现

**Gateway 作为 MQTT Client 连接到 EMQX：**

```yaml
# application.yaml
yudao.iot.gateway.protocol.emqx:
  enabled: true
  mqtt-host: 192.168.1.126  # 外部 EMQX Broker
  mqtt-port: 1883
  mqtt-topics:
    - "/sys/#"
    - "/iot/upstream/#"
```

**设备连接流程：**
```
1. 物理设备 → EMQX Broker (MQTT)
2. Gateway 订阅 EMQX Topic
3. Gateway 收到设备消息 → 转发到 RocketMQ → Biz
```

### 4.3 其他协议使用场景

1. **ONVIF（摄像头）**
   - 用于大华、海康等网络摄像头
   - Gateway 主动连接设备

2. **HTTP（通用）**
   - 用于支持 HTTP API 的设备
   - 设备主动上报或 Gateway 轮询

---

## 5. 关于"考虑引入 MQTT Broker"的澄清

### ❌ 我之前的表述有误

在 V2 设计方案中提到的"考虑引入 MQTT Broker"是**不恰当的**，原因：

1. **项目已经有 EMQX**
   - 配置文件显示已经连接到外部 EMQX（192.168.1.126:1883）
   - EMQX 就是一个成熟的 MQTT Broker

2. **混淆了两个通信层**
   - RocketMQ 用于**内部微服务通信**（Gateway ↔ Biz）
   - MQTT 用于**设备接入**（物理设备 ↔ Gateway）
   - 两者不应该互相替代

3. **架构已经合理**
   ```
   设备 ─MQTT→ EMQX ─订阅→ Gateway ─RocketMQ→ Biz
   ```

### ✅ 正确的表述应该是

**短期（无需改动）：**
- 保持现有架构
- RocketMQ 用于内部通信
- MQTT/EMQX 用于设备接入

**中期（优化）：**
- 优化 RocketMQ Topic 设计（V2方案）
- 完善 MQTT Topic 规范（符合 AIOT 标准）
- 两者各司其职

**长期（扩展）：**
- 考虑支持更多设备协议（CoAP、LwM2M）
- 考虑边缘计算网关
- **不是**用 MQTT 替代 RocketMQ

---

## 6. AIOT 标准文档中的 Topic 是给谁用的？

### ✅ 答案：给物理设备用的（MQTT 层）

AIOT 标准文档中的 Topic 格式：
```
$oc/devices/{device_id}/sys/properties/report
$oc/devices/{device_id}/sys/commands/request_id={request_id}
```

这些 Topic 是：
- ✅ 物理设备通过 MQTT 协议上报数据时使用
- ✅ Gateway 通过 MQTT 协议下发命令时使用
- ❌ **不是** Gateway 和 Biz 之间用 RocketMQ 通信时使用

### 对比示例

**场景1：摄像头上报温度（使用 MQTT）**
```
摄像头 ─MQTT─→ EMQX
Topic: $oc/devices/camera_001/sys/properties/report
Payload: {"services":[{"service_id":"Temperature","properties":{"value":25.5}}]}
```

**场景2：Gateway 通知 Biz（使用 RocketMQ）**
```
Gateway ─RocketMQ─→ Biz
Topic: iot.device.property.reported
Payload: {"deviceId":12345, "temperature":25.5}
```

---

## 7. 正确的 Topic 设计策略

### 7.1 MQTT Topic（设备层）- 参考 AIOT 标准

```java
/**
 * MQTT Topic 常量（物理设备使用）
 */
public interface MqttTopicTemplates {
    
    // 属性上报
    String PROPERTY_REPORT = "$oc/devices/{device_id}/sys/properties/report";
    
    // 命令下发
    String COMMAND_REQUEST = "$oc/devices/{device_id}/sys/commands/request_id={request_id}";
    String COMMAND_RESPONSE = "$oc/devices/{device_id}/sys/commands/response/request_id={request_id}";
    
    // 事件上报
    String EVENT_REPORT = "$oc/devices/{device_id}/sys/events/report";
}
```

### 7.2 RocketMQ Topic（服务层）- 当前使用

```java
/**
 * RocketMQ Topic 常量（内部服务使用）
 */
public interface IotMessageTopics {
    
    // 设备生命周期
    String DEVICE_ONLINE = "iot.device.online";
    String DEVICE_OFFLINE = "iot.device.offline";
    
    // 设备发现
    String DEVICE_DISCOVERED = "iot.device.discovered";
    
    // 属性上报（来自Gateway的转换）
    String DEVICE_PROPERTY_REPORTED = "iot.device.property.reported";
    
    // 服务调用
    String DEVICE_SERVICE_INVOKE = "iot.device.service.invoke";
    String DEVICE_SERVICE_RESULT = "iot.device.service.result";
}
```

---

## 8. 总结

### ✅ 正确的理解

1. **RocketMQ 是项目的内部消息总线**
   - 用于 Gateway ↔ Biz 微服务通信
   - 不会被 MQTT 替代

2. **MQTT 是设备接入协议**
   - 用于物理设备 ↔ Gateway 通信
   - 已经通过 EMQX 实现

3. **两者不冲突，各司其职**
   ```
   设备 ─MQTT→ Gateway ─RocketMQ→ Biz
   ```

### ❌ 之前的错误表述

在 V2 设计方案中提到的"考虑引入 MQTT Broker"是不准确的，应该是：
- ✅ 优化现有的 MQTT Topic 设计（符合 AIOT 标准）
- ✅ 优化现有的 RocketMQ Topic 设计（更规范）
- ❌ **不是**用 MQTT 替代 RocketMQ

### 📋 行动建议

1. **短期**：
   - 继续使用 RocketMQ 作为内部消息总线
   - 继续使用 EMQX 作为设备接入 Broker
   - 两者分工明确，无需变更

2. **中期**：
   - 规范 MQTT Topic（参考 AIOT 标准）
   - 优化 RocketMQ Topic（V2 方案去掉 MQTT Broker 部分）
   - 完善文档，避免混淆

3. **长期**：
   - 支持更多设备协议
   - 考虑边缘计算
   - 保持双层消息架构

---

**感谢您的提问！** 这个问题让我意识到之前的文档有混淆两个不同通信层的问题。现在已经澄清了。

**文档版本**：v1.0  
**最后更新**：2025-10-27  
**维护者**：长辉信息科技有限公司















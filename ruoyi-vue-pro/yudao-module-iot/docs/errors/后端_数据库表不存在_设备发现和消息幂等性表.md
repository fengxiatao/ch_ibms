# 数据库表不存在 - 设备发现和消息幂等性表

## 错误信息

```
org.springframework.jdbc.BadSqlGrammarException: 
### Error updating database.  Cause: java.sql.SQLSyntaxErrorException: 
Table 'ch_ibms.iot_message_idempotent' doesn't exist
### The error may exist in cn/iocoder/yudao/module/iot/dal/mysql/message/IotMessageIdempotentMapper.java (best guess)
### The error may involve cn.iocoder.yudao.module.iot.dal.mysql.message.IotMessageIdempotentMapper.insert-Inline
### The error occurred while setting parameters
### SQL: INSERT INTO iot_message_idempotent  ( message_id, topic, status,   create_time, update_time, creator, updater )  VALUES (  ?, ?, ?,   ?, ?, ?, ?  )
### Cause: java.sql.SQLSyntaxErrorException: Table 'ch_ibms.iot_message_idempotent' doesn't exist
```

**类似错误**：
- `Table 'ch_ibms.iot_discovered_device' doesn't exist`

## 错误原因

### 问题分析

在实现设备发现和消息幂等性功能时，创建了以下新的数据库表：

1. **`iot_message_idempotent`** - 消息幂等性检查表
   - 用于防止 RocketMQ 消息重复消费
   - 记录消息处理状态

2. **`iot_discovered_device`** - 发现设备表
   - 记录自动发现的设备
   - 支持设备状态管理和忽略功能

但在开发时**未及时创建对应的 SQL 脚本**，导致部署时缺少这些表。

### 根本原因

- ✅ 代码层面：DO、Mapper、Service 都已实现
- ❌ 数据库层面：缺少表结构定义
- ❌ 部署文档：未提供 SQL 脚本

## 解决方案

### 方式1：使用批处理脚本（推荐，Windows）

```bash
cd F:\work\ch_ibms\ruoyi-vue-pro\sql\mysql
一键创建设备发现表.bat
```

**优点**：
- 交互式输入数据库信息
- 自动验证执行结果
- 包含详细的提示信息

### 方式2：直接执行 SQL（推荐，Linux/Mac）

```bash
cd /path/to/ruoyi-vue-pro/sql/mysql

# 方式 A：管道方式
mysql -hlocalhost -P3306 -uroot -p ch_ibms < iot_tables_device_discovery_and_message.sql

# 方式 B：source 方式
mysql -hlocalhost -P3306 -uroot -p
> USE ch_ibms;
> source iot_tables_device_discovery_and_message.sql;
```

### 方式3：使用可视化工具

#### Navicat
1. 连接到数据库
2. 打开 `iot_tables_device_discovery_and_message.sql`
3. 点击"运行"按钮

#### DBeaver / MySQL Workbench
1. 连接到 `ch_ibms` 数据库
2. 打开 SQL 编辑器
3. 加载并执行 `iot_tables_device_discovery_and_message.sql`

### 方式4：单独创建表

```sql
-- 1. 消息幂等性检查表
source iot_message_idempotent.sql;

-- 2. 发现设备表
source iot_discovered_device.sql;
```

## 完整的表结构

### 1. iot_message_idempotent

```sql
CREATE TABLE IF NOT EXISTS `iot_message_idempotent` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `message_id` VARCHAR(255) NOT NULL COMMENT '消息ID',
    `topic` VARCHAR(255) NOT NULL COMMENT '消息主题',
    `status` VARCHAR(20) NOT NULL DEFAULT 'PROCESSING' COMMENT '状态',
    `processed_time` DATETIME NULL DEFAULT NULL COMMENT '处理完成时间',
    `error_message` TEXT NULL COMMENT '错误信息',
    
    -- BaseDO 标准字段
    `creator` VARCHAR(64) NULL DEFAULT '',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updater` VARCHAR(64) NULL DEFAULT '',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted` BIT(1) NOT NULL DEFAULT b'0',
    `tenant_id` BIGINT(20) NOT NULL DEFAULT 0,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_message_id_topic` (`message_id`, `topic`, `deleted`),
    KEY `idx_topic_status` (`topic`, `status`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='IoT 消息幂等性检查表';
```

### 2. iot_discovered_device

```sql
CREATE TABLE IF NOT EXISTS `iot_discovered_device` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `ip` VARCHAR(50) NOT NULL COMMENT 'IP地址',
    `mac` VARCHAR(50) NULL DEFAULT NULL COMMENT 'MAC地址',
    `vendor` VARCHAR(100) NULL DEFAULT NULL COMMENT '厂商',
    `model` VARCHAR(100) NULL DEFAULT NULL COMMENT '型号',
    `serial_number` VARCHAR(100) NULL DEFAULT NULL COMMENT '序列号',
    `device_type` VARCHAR(50) NULL DEFAULT NULL COMMENT '设备类型',
    `firmware_version` VARCHAR(50) NULL DEFAULT NULL COMMENT '固件版本',
    `discovery_method` VARCHAR(20) NOT NULL COMMENT '发现方式',
    `discovery_time` DATETIME NOT NULL COMMENT '发现时间',
    
    -- 设备注册状态
    `added` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否已添加',
    `device_id` BIGINT(20) NULL DEFAULT NULL COMMENT '平台设备ID',
    `status` TINYINT(2) NOT NULL DEFAULT 1 COMMENT '状态',
    
    -- 通知相关
    `notified_count` INT(11) NOT NULL DEFAULT 0,
    `last_notified_time` DATETIME NULL DEFAULT NULL,
    
    -- 忽略相关
    `ignored_by` BIGINT(20) NULL DEFAULT NULL,
    `ignored_time` DATETIME NULL DEFAULT NULL,
    `ignore_reason` VARCHAR(255) NULL DEFAULT NULL,
    `ignore_until` DATETIME NULL DEFAULT NULL,
    
    -- BaseDO 标准字段
    `creator` VARCHAR(64) NULL DEFAULT '',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updater` VARCHAR(64) NULL DEFAULT '',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted` BIT(1) NOT NULL DEFAULT b'0',
    `tenant_id` BIGINT(20) NOT NULL DEFAULT 0,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_ip_discovery_time` (`ip`, `discovery_time`, `deleted`),
    KEY `idx_ip` (`ip`),
    KEY `idx_status` (`status`),
    KEY `idx_discovery_time` (`discovery_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='IoT 发现设备表';
```

## 验证表是否创建成功

### 1. 检查表是否存在

```sql
SHOW TABLES LIKE 'iot_message_idempotent';
SHOW TABLES LIKE 'iot_discovered_device';
```

**预期结果**：返回两个表名

### 2. 查看表结构

```sql
DESC iot_message_idempotent;
DESC iot_discovered_device;
```

**预期结果**：显示完整的字段列表

### 3. 查看表信息

```sql
SELECT 
    TABLE_NAME AS '表名',
    TABLE_COMMENT AS '表注释',
    CREATE_TIME AS '创建时间'
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'ch_ibms'
  AND TABLE_NAME IN ('iot_discovered_device', 'iot_message_idempotent');
```

**预期结果**：
| 表名 | 表注释 | 创建时间 |
|-----|-------|---------|
| iot_discovered_device | IoT 发现设备表 | 2025-10-27 xx:xx:xx |
| iot_message_idempotent | IoT 消息幂等性检查表 | 2025-10-27 xx:xx:xx |

### 4. 重启服务验证

```bash
# 停止服务
# 启动服务
mvn spring-boot:run

# 查看日志，确认无表不存在错误
```

**预期结果**：服务正常启动，无 SQL 错误

## 涉及文件

### SQL 脚本文件

- `sql/mysql/iot_tables_device_discovery_and_message.sql` - 完整脚本（推荐）
- `sql/mysql/iot_message_idempotent.sql` - 消息幂等性表
- `sql/mysql/iot_discovered_device.sql` - 发现设备表
- `sql/mysql/一键创建设备发现表.bat` - Windows 批处理脚本
- `sql/mysql/README_设备发现表说明.md` - 详细说明文档

### Java 代码文件

- `IotMessageIdempotentDO.java` - 消息幂等性 DO
- `IotMessageIdempotentMapper.java` - 消息幂等性 Mapper
- `MessageIdempotentService.java` - 消息幂等性服务
- `IotDiscoveredDeviceDO.java` - 发现设备 DO
- `DiscoveredDeviceService.java` - 发现设备服务

## 预防措施

### 1. 开发时同步创建 SQL 脚本

**最佳实践**：
```
创建 DO → 创建 Mapper → 创建 SQL 脚本 → 提交代码
```

### 2. SQL 脚本命名规范

```
格式: 表名.sql 或 功能模块_表名.sql
示例:
  - iot_message_idempotent.sql
  - iot_discovered_device.sql
  - iot_tables_device_discovery_and_message.sql  (合并脚本)
```

### 3. 使用 Flyway / Liquibase

**版本化数据库迁移**：
```
db/migration/
  V1__create_iot_message_idempotent.sql
  V2__create_iot_discovered_device.sql
```

**优点**：
- 自动执行
- 版本控制
- 可回滚

### 4. 在部署文档中说明

**部署清单**：
```markdown
## 数据库迁移

执行以下 SQL 脚本：
1. iot_tables_device_discovery_and_message.sql
2. 验证表是否创建成功
```

### 5. CI/CD 集成

在持续集成流程中添加数据库检查：
```bash
# 检查必需的表是否存在
mysql -e "USE ch_ibms; SHOW TABLES LIKE 'iot_message_idempotent';"
```

## 相关错误

- `Table doesn't exist` - 表不存在
- `Unknown column` - 字段不存在（表结构不匹配）
- `Duplicate entry` - 违反唯一索引约束

## 参考资料

- [README_设备发现表说明.md](../../../sql/mysql/README_设备发现表说明.md)
- [芋道源码 - 数据库设计规范](https://doc.iocoder.cn/)
- [MySQL 官方文档](https://dev.mysql.com/doc/)

---

**错误时间**：2025-10-27  
**修复状态**：✅ 已修复（已提供 SQL 脚本）  
**影响范围**：设备发现、消息幂等性功能  
**修复版本**：v2025.09-SNAPSHOT  
**SQL 脚本位置**：`sql/mysql/iot_tables_device_discovery_and_message.sql`















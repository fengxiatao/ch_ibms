<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.iot.dal.tdengine.IotDeviceMessageMapper">

    <!-- 检查表是否存在（MySQL版本） -->
    <select id="showSTable" resultType="String">
        SELECT TABLE_NAME FROM information_schema.TABLES 
        WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'iot_device_message'
    </select>

    <!-- 插入设备消息数据（MySQL版本） -->
    <insert id="insert">
        INSERT INTO iot_device_message (
            id, device_id, tenant_id, server_id, report_time, ts,
            upstream, reply, identifier, request_id, method,
            params, data, code, msg
        )
        VALUES (
            #{id}, #{deviceId}, #{tenantId}, #{serverId}, #{reportTime}, NOW(3),
            #{upstream}, #{reply}, #{identifier}, #{requestId}, #{method}, 
            #{params}, #{data}, #{code}, #{msg}
        )
    </insert>

    <!-- 分页查询（MySQL版本） -->
    <select id="selectPage" resultType="cn.iocoder.yudao.module.iot.dal.dataobject.device.IotDeviceMessageDO">
        SELECT ts, id, report_time AS reportTime, tenant_id AS tenantId, server_id AS serverId,
               device_id AS deviceId, upstream, reply, identifier, request_id AS requestId, 
               method, params, data, code, msg
        FROM iot_device_message
        <where>
            device_id = #{reqVO.deviceId}
            <if test="reqVO.method != null and reqVO.method != ''">
                AND method = #{reqVO.method}
            </if>
            <if test="reqVO.upstream != null">
                AND upstream = #{reqVO.upstream}
            </if>
            <if test="reqVO.reply != null">
                AND reply = #{reqVO.reply}
            </if>
            <if test="reqVO.identifier != null and reqVO.identifier != ''">
                AND identifier = #{reqVO.identifier}
            </if>
        </where>
        ORDER BY ts DESC
    </select>

    <!-- 按requestIds批量查询消息（MySQL版本） -->
    <select id="selectListByRequestIdsAndReply" resultType="cn.iocoder.yudao.module.iot.dal.dataobject.device.IotDeviceMessageDO">
        SELECT ts, id, report_time AS reportTime, tenant_id AS tenantId, server_id AS serverId,
               device_id AS deviceId, upstream, reply, identifier, request_id AS requestId, 
               method, params, data, code, msg
        FROM iot_device_message
        WHERE device_id = #{deviceId}
        AND reply = #{reply}
        AND request_id IN
        <foreach collection="requestIds" item="requestId" open="(" close=")" separator=",">
            #{requestId}
        </foreach>
        ORDER BY ts DESC
    </select>

    <!-- 统计消息数量（MySQL版本） -->
    <select id="selectCountByCreateTime" resultType="Long">
        SELECT COUNT(*)
        FROM iot_device_message
        <where>
            <if test="createTime != null">
                AND UNIX_TIMESTAMP(ts) * 1000 >= #{createTime}
            </if>
        </where>
    </select>

    <!-- 按时间分组统计消息数量（MySQL版本） -->
    <select id="selectDeviceMessageCountGroupByDate" resultType="java.util.Map">
        SELECT
            DATE_FORMAT(ts, '%Y-%m-%d %H:00:00') AS time,
            SUM(CASE WHEN upstream = 1 THEN 1 ELSE 0 END) AS upstream_count,
            SUM(CASE WHEN upstream = 0 THEN 1 ELSE 0 END) AS downstream_count
        FROM iot_device_message
        <where>
            <if test="startTime != null">
                AND UNIX_TIMESTAMP(ts) * 1000 >= #{startTime}
            </if>
            <if test="endTime != null">
                AND UNIX_TIMESTAMP(ts) * 1000 &lt;= #{endTime}
            </if>
        </where>
        GROUP BY DATE_FORMAT(ts, '%Y-%m-%d %H:00:00')
        ORDER BY time
    </select>

</mapper>

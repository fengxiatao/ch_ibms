# 设备注册自动初始化方案

## 问题背景

### 原有架构的问题
1. **内存缓存**：网关的 `OnvifPresenceProvider` 使用 `ConcurrentHashMap` 存储设备信息
2. **网关重启丢失**：网关重启后，`deviceInfoCache` 清空，所有设备显示离线
3. **依赖手动触发**：只有在创建/更新摄像头时才会注册设备到网关

## 解决方案

### 核心思路
**网关启动时主动从业务侧拉取所有设备并注册**

### 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│  网关启动 (IotGatewayServerApplication)                          │
│  端口: 8099                                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  DeviceInitializer (@PostConstruct)                             │
│  - 延迟 10 秒启动（等待业务服务）                                │
│  - 异步执行，不阻塞网关启动                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTP GET
┌─────────────────────────────────────────────────────────────────┐
│  业务侧 (yudao-server)                                           │
│  端口: 48888                                                     │
│                                                                 │
│  GET /admin-api/iot/camera/list-for-gateway                    │
│  ↓                                                              │
│  IotCameraController.listForGateway()                          │
│  ↓                                                              │
│  IotCameraServiceImpl.listForGateway()                         │
│  - 查询所有摄像头配置 (iot_camera)                              │
│  - 批量查询设备信息 (iot_device) 获取 IP                        │
│  - 组装返回 IotCameraForGatewayRespVO                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓ 返回设备列表
┌─────────────────────────────────────────────────────────────────┐
│  DeviceInitializer.initializeDevices()                          │
│  - 遍历设备列表                                                  │
│  - 逐个注册到 OnvifPresenceProvider                             │
│    onvifPresenceProvider.registerDevice(...)                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  OnvifPresenceProvider                                          │
│  - deviceInfoCache 填充完成                                      │
│  - 开始定期探测设备在线状态                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 实现细节

### 1. 网关侧配置

**文件**: `yudao-module-iot-gateway/src/main/resources/application.yaml`

```yaml
# 网关配置
gateway:
  # 设备 RPC 配置（网关调用业务侧接口）
  rpc:
    url: http://127.0.0.1:48888 # 主程序 API 地址
    connect-timeout: 30s
    read-timeout: 30s
  # 设备初始化配置
  device-init:
    enabled: true # 是否启用设备初始化
    delay-seconds: 10 # 延迟启动时间（秒）
```

### 2. 网关侧实现

**文件**: `DeviceInitializer.java`

```java
@Component
@ConditionalOnProperty(name = "gateway.device-init.enabled", havingValue = "true", matchIfMissing = true)
@Slf4j
public class DeviceInitializer {
    
    @Resource
    private OnvifPresenceProvider onvifPresenceProvider;
    
    @Value("${gateway.rpc.url:http://127.0.0.1:48888}")
    private String businessServiceUrl;
    
    @PostConstruct
    public void init() {
        // 延迟执行，等待业务服务启动
        new Thread(() -> {
            Thread.sleep(delaySeconds * 1000L);
            initializeDevices();
        }, "device-initializer").start();
    }
    
    private void initializeDevices() {
        // 调用业务侧接口获取设备列表
        String url = businessServiceUrl + "/admin-api/iot/camera/list-for-gateway";
        ResponseEntity<CommonResult<List<CameraDeviceVO>>> response = 
            restTemplate.exchange(url, HttpMethod.GET, null, ...);
        
        // 遍历设备并注册
        for (CameraDeviceVO device : devices) {
            onvifPresenceProvider.registerDevice(
                device.getDeviceId(),
                device.getIp(),
                device.getOnvifPort(),
                device.getUsername(),
                device.getPassword()
            );
        }
    }
}
```

### 3. 业务侧接口

**Controller**: `IotCameraController.java`

```java
@GetMapping("/list-for-gateway")
@Operation(summary = "获取所有摄像头设备列表（供网关使用）")
@PermitAll // 允许网关无需登录即可访问
@TenantIgnore // 忽略租户隔离，获取所有租户的设备（网关需要管理所有设备）
public CommonResult<List<IotCameraForGatewayRespVO>> listForGateway() {
    return success(cameraService.listForGateway());
}
```

**Service**: `IotCameraServiceImpl.java`

```java
@Override
public List<IotCameraForGatewayRespVO> listForGateway() {
    // 1. 查询所有摄像头配置
    List<IotCameraDO> cameras = cameraMapper.selectList();
    
    // 2. 批量查询设备信息（获取IP地址）
    List<Long> deviceIds = cameras.stream()
        .map(IotCameraDO::getDeviceId)
        .toList();
    List<IotDeviceDO> devices = deviceMapper.selectBatchIds(deviceIds);
    Map<Long, IotDeviceDO> deviceMap = devices.stream()
        .collect(Collectors.toMap(IotDeviceDO::getId, device -> device));
    
    // 3. 组装返回结果
    List<IotCameraForGatewayRespVO> result = new ArrayList<>();
    for (IotCameraDO camera : cameras) {
        IotDeviceDO device = deviceMap.get(camera.getDeviceId());
        if (device == null || device.getIp() == null) {
            continue;
        }
        
        IotCameraForGatewayRespVO vo = new IotCameraForGatewayRespVO();
        vo.setDeviceId(camera.getDeviceId());
        vo.setIp(device.getIp());
        vo.setOnvifPort(camera.getOnvifPort() != null ? camera.getOnvifPort() : 80);
        vo.setUsername(camera.getUsername());
        vo.setPassword(camera.getPassword());
        
        result.add(vo);
    }
    
    return result;
}
```

**VO**: `IotCameraForGatewayRespVO.java`

```java
@Data
public class IotCameraForGatewayRespVO {
    private Long deviceId;
    private String ip;
    private Integer onvifPort;
    private String username;
    private String password;
}
```

## 配置说明

### 网关配置项

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `gateway.rpc.url` | 业务侧服务地址 | `http://127.0.0.1:48888` | - |
| `gateway.device-init.enabled` | 是否启用设备初始化 | `true` | `true`/`false` |
| `gateway.device-init.delay-seconds` | 延迟启动时间（秒） | `10` | `10` |

### 业务侧配置项

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `iot.gateway.base-url` | 网关服务地址 | `http://localhost:8099` | `http://127.0.0.1:8099` |
| `iot.gateway.token` | 网关认证Token | - | `yudaoIotGatewayTokenSecret123456789` |

## 启动流程

### 1. 启动顺序

```bash
# 1. 先启动业务服务（yudao-server）
cd yudao-server
mvn spring-boot:run
# 等待启动完成，监听 48888 端口

# 2. 再启动网关服务（yudao-module-iot-gateway）
cd yudao-module-iot-gateway
mvn spring-boot:run
# 等待启动完成，监听 8099 端口
```

### 2. 初始化日志

网关启动后，应该看到以下日志：

```
[DeviceInitializer] 将在 10 秒后开始初始化设备
[DeviceInitializer] 开始从业务侧拉取设备列表...
[DeviceInitializer] 获取到 5 个摄像头设备，开始注册...
[OnvifPresenceProvider] 注册设备: deviceId=82, ip=192.168.1.200, port=80
[OnvifPresenceProvider] 注册设备: deviceId=83, ip=192.168.1.201, port=80
...
[DeviceInitializer] 设备初始化完成: 成功 5/5
```

## 验证方法

### 1. 检查网关注册

```bash
# 查询网关在线设备列表
curl http://localhost:8099/gateway/device/status/online-devices
```

### 2. 检查设备状态

```bash
# 查询单个设备状态
curl "http://localhost:8099/gateway/device/status/get?deviceId=82"

# 批量查询设备状态
curl -X POST http://localhost:8099/gateway/device/status/batch \
  -H "Content-Type: application/json" \
  -d "[82, 83]"
```

### 3. 检查业务侧设备列表

```bash
# 查询设备分页列表（应该显示在线状态）
curl "http://localhost:48888/admin-api/iot/device/page?pageNo=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 优势

1. **自动恢复**：网关重启后自动重新注册所有设备
2. **无需手动操作**：不依赖用户创建/更新设备触发注册
3. **配置灵活**：可通过配置文件启用/禁用、调整延迟时间
4. **异步执行**：不阻塞网关启动流程
5. **容错处理**：单个设备注册失败不影响其他设备

## 注意事项

1. **启动顺序**：必须先启动业务服务，再启动网关服务
2. **延迟时间**：默认延迟 10 秒，确保业务服务完全启动
3. **网络连通性**：确保网关能访问业务服务的 48888 端口
4. **设备IP**：确保设备表中的IP地址正确
5. **ONVIF端口**：默认使用 80 端口，如果设备使用其他端口需要在摄像头配置中指定

## 文件清单

### 新增文件

1. **网关侧**
   - `DeviceInitializer.java` - 设备初始化器

2. **业务侧**
   - `IotCameraForGatewayRespVO.java` - 网关设备信息VO

### 修改文件

1. **网关侧**
   - `application.yaml` - 添加设备初始化配置

2. **业务侧**
   - `IotCameraService.java` - 添加 `listForGateway()` 方法
   - `IotCameraServiceImpl.java` - 实现 `listForGateway()` 方法
   - `IotCameraController.java` - 添加 `/list-for-gateway` 接口
   - `GatewayClient.java` - 修正配置键为 `iot.gateway.base-url`
   - `GatewayStatusClient.java` - 修正配置键为 `iot.gateway.base-url`

## 后续优化建议

1. **持久化存储**：考虑将设备注册信息持久化到 Redis，避免网关重启丢失
2. **增量更新**：支持设备增量更新，而不是每次全量拉取
3. **健康检查**：定期检查设备注册状态，自动重新注册失败的设备
4. **监控告警**：添加设备注册失败的监控和告警机制
5. **批量注册**：优化为批量注册接口，减少HTTP请求次数

# 🚀 快速开始 - 修复500错误

## 问题现象

```
❌ 点击"产品管理"的"定时任务"按钮报错
❌ Request failed with status code 500
❌ [IoT 物联网 yudao-module-iot - 表结构未导入]
```

---

## 🎯 一键解决方案（最快）

### 步骤1：导入MySQL表（业务表）

```bash
# 进入目录
cd F:\work\ch_ibms\ruoyi-vue-pro\sql\mysql

# 双击运行
一键导入所有表结构.bat
```

**输入MySQL密码 → 等待完成 → 看到成功提示**

### 步骤2：导入PostgreSQL表（空间表）

```bash
# 进入目录
cd F:\work\ch_ibms\ruoyi-vue-pro\sql\postgresql

# 双击运行
导入GIS空间表.bat
```

**输入PostgreSQL密码 → 等待完成 → 看到成功提示**

### 步骤3：重启后端

- 停止 `YudaoServerApplication`
- 重新启动

### 步骤4：刷新前端

- 按 `Ctrl + F5` 强制刷新浏览器
- 重新测试"定时任务"功能

**✅ 完成！问题已解决！**

---

## 📊 数据库架构说明

您的系统使用**双数据源**：

```
MySQL (ch_ibms)              PostgreSQL (ibms_gis)
├─ 业务表                     ├─ 园区表 (campus)
├─ IoT设备表                  ├─ 建筑表 (building)
├─ 产品表                     ├─ 楼层表 (floor)
└─ 任务类型定义表 ⭐          └─ 区域表 (area)
```

**关键表：`iot_job_type_definition`**
- 存储位置：MySQL的`ch_ibms`数据库
- 作用：定义所有可用的任务类型
- 记录数：20条预定义任务类型

---

## 🔍 关于您提到的接口

```java
@GetMapping("/applicable")
public CommonResult<List<JobTypeDefinitionDO>> getApplicableJobTypes(
    @RequestParam("entityType") String entityType) {
    // ...
}
```

**是的，这个接口会查询表结构！**

### 查询的表
- 表名：`iot_job_type_definition`
- 位置：MySQL的`ch_ibms`数据库
- 查询逻辑：根据实体类型筛选适用的任务类型

### 查询示例

```sql
-- 当 entityType = "PRODUCT" 时
SELECT * FROM iot_job_type_definition
WHERE FIND_IN_SET('PRODUCT', applicable_entities) > 0
  AND status = 1
ORDER BY id;

-- 返回结果：
-- 1. 设备离线检查
-- 2. 设备健康检查
-- 3. 设备数据采集
-- 4. 设备状态同步
-- 5. 摄像头巡检
-- ... 等等
```

### 实体类型说明

| entityType | 中文名称 | 适用场景 |
|------------|---------|---------|
| PRODUCT | 产品 | 产品管理页面 |
| DEVICE | 设备 | 设备管理页面 |
| CAMPUS | 园区 | 园区管理页面 |
| BUILDING | 建筑 | 建筑管理页面 |
| FLOOR | 楼层 | 楼层管理页面 |
| AREA | 区域 | 区域管理页面 |

---

## 📝 导入的表结构

### MySQL表（共4张）

| 表名 | 说明 | 重要性 | 文件 |
|------|------|--------|------|
| `iot_product` | 产品表 | ⭐⭐⭐ | iot_module.sql |
| `iot_product_category` | 产品分类表 | ⭐⭐ | iot_module.sql |
| `iot_device` | 设备表 | ⭐⭐⭐ | iot_module.sql |
| **`iot_job_type_definition`** | **任务类型定义表** | ⭐⭐⭐⭐⭐ | iot_job_type_definition.sql |

### PostgreSQL表（共4张）

| 表名 | 说明 | 层级 | 文件 |
|------|------|------|------|
| `ibms_gis_campus` | 园区表 | L1 | gis_spatial_module.sql |
| `ibms_gis_building` | 建筑表 | L2 | gis_spatial_module.sql |
| `ibms_gis_floor` | 楼层表 | L3 | gis_spatial_module.sql |
| `ibms_gis_area` | 区域表 | L4 | gis_spatial_module.sql |

---

## ✅ 验证步骤

### 1. 验证MySQL表

```sql
-- 连接MySQL
mysql -u root -p ch_ibms

-- 查看表
SHOW TABLES LIKE 'iot_%';

-- 查看任务类型数量（应该是20条）
SELECT COUNT(*) as 任务类型数量 FROM iot_job_type_definition;

-- 查看所有任务类型
SELECT id, name, code, business_type FROM iot_job_type_definition;
```

### 2. 验证PostgreSQL表

```bash
# 连接PostgreSQL
psql -U postgres -d ibms_gis

# 查看表
\dt ibms_gis_*

# 查看园区数据
SELECT * FROM ibms_gis_campus;

# 退出
\q
```

### 3. 验证接口

打开浏览器，访问（登录后）：
```
GET /admin-api/iot/task-config/applicable?entityType=PRODUCT
```

应该返回包含多个任务类型的JSON数组。

---

## 🛠️ 备用方案（手动导入）

### 使用Navicat（MySQL）

1. 连接到MySQL服务器
2. 打开数据库 `ch_ibms`
3. 点击"查询" → "新建查询"
4. 打开文件：
   - `iot_module.sql`
   - `iot_job_type_definition.sql`
5. 点击"运行"

### 使用pgAdmin（PostgreSQL）

1. 连接到PostgreSQL服务器
2. 打开数据库 `ibms_gis`
3. 点击"Tools" → "Query Tool"
4. 打开文件：`gis_spatial_module.sql`
5. 点击"Execute"

---

## 🐛 问题排查

### 问题1：MySQL密码错误

```bash
# 检查MySQL连接
mysql -u root -p
# 输入密码后能登录则说明密码正确
```

### 问题2：PostgreSQL连接失败

```bash
# 检查PostgreSQL服务
sc query postgresql-x64-14

# 或使用服务管理器查看
services.msc → 找到PostgreSQL服务
```

### 问题3：表已存在

```sql
-- MySQL: 删除旧表重建
DROP TABLE IF EXISTS iot_job_type_definition;
-- 然后重新执行导入脚本

-- PostgreSQL: 删除旧表重建
DROP TABLE IF EXISTS ibms_gis_campus CASCADE;
-- 然后重新执行导入脚本
```

### 问题4：依然报500错误

1. **检查后端日志**
   - 查看控制台完整错误信息
   - 可能还有其他表缺失

2. **检查数据库连接配置**
   ```yaml
   # application-dev.yaml
   spring:
     datasource:
       dynamic:
         datasource:
           master:
             url: jdbc:mysql://127.0.0.1:3306/ch_ibms
           gis:
             url: jdbc:postgresql://127.0.0.1:5432/ibms_gis
   ```

3. **清除缓存重启**
   - 停止后端
   - 清理IDEA缓存（可选）
   - 重新启动

---

## 📚 相关文档

- [双数据源配置说明](./双数据源配置说明.md)
- [完整导入指南](./mysql/README_表结构导入完整指南.md)
- [定时任务架构文档](../docs/定时任务统一架构设计方案.md)

---

## 💡 关键总结

1. ✅ **问题根源**：缺少 `iot_job_type_definition` 表
2. ✅ **表位置**：MySQL的 `ch_ibms` 数据库
3. ✅ **接口作用**：根据实体类型返回适用的任务类型列表
4. ✅ **解决方案**：执行 `iot_job_type_definition.sql` 脚本
5. ✅ **双数据源**：IoT表在MySQL，空间表在PostgreSQL

---

**祝您使用愉快！如有问题请查看详细文档。** 🎉


-- =============================================
-- 报警主机操作记录菜单和权限配置
-- 创建时间: 2025-12-04
-- 说明: 为周界入侵模块添加操作记录功能
-- =============================================
-- 前置条件：
-- 1. 周界入侵目录（ID=5100）已存在
-- 2. 报警主机菜单（ID=5101-5106）已创建
-- 3. 操作记录使用ID范围：5107-5109
-- =============================================

-- 删除旧的操作记录菜单（如果存在）
DELETE FROM `system_menu` WHERE `id` >= 5107 AND `id` <= 5109;

-- ==================== 操作记录菜单 ====================

-- 5107: 操作记录（二级菜单，与报警主机平级）
-- 注意：always_show = b'0' 确保菜单可点击（即使有子按钮）
INSERT INTO `system_menu` VALUES (
    5107, '操作记录', 'iot:alarm-operation-log:query', 2, 2, 5100,
    'operation-log', 'ep:document', 'security/PerimeterIntrusion/AlarmOperationLog/index', 'AlarmOperationLog',
    0, b'1', b'1', b'0',
    '1', NOW(), '1', NOW(), b'0'
);

-- ==================== 操作记录按钮权限（三级菜单） ====================

-- 5108: 导出操作记录（可选功能）
INSERT INTO `system_menu` VALUES (
    5108, '导出操作记录', 'iot:alarm-operation-log:export', 3, 1, 5107,
    '', '', '', NULL,
    0, b'1', b'1', b'1',
    '1', NOW(), '1', NOW(), b'0'
);

-- 5109: 删除操作记录（可选功能，谨慎使用）
INSERT INTO `system_menu` VALUES (
    5109, '删除操作记录', 'iot:alarm-operation-log:delete', 3, 2, 5107,
    '', '', '', NULL,
    0, b'1', b'1', b'1',
    '1', NOW(), '1', NOW(), b'0'
);

-- =============================================
-- 验证菜单创建结果
-- =============================================
SELECT 
    '操作记录菜单配置完成！' AS message,
    CONCAT('共创建 ', COUNT(*), ' 个菜单项') AS detail
FROM `system_menu` 
WHERE `id` >= 5107 AND `id` <= 5109 AND `deleted` = 0;

-- =============================================
-- 菜单结构说明
-- =============================================
-- 1. 菜单ID说明：
--    5107: 操作记录菜单（二级菜单，与报警主机平级）
--    5108: 导出操作记录（按钮权限）
--    5109: 删除操作记录（按钮权限）

-- 2. 父菜单ID说明：
--    5100: 周界入侵（一级目录）
--    5101: 报警主机（二级菜单）
--    5107: 操作记录（二级菜单）

-- 3. 菜单类型说明：
--    type = 1: 目录
--    type = 2: 菜单
--    type = 3: 按钮

-- 4. 权限标识说明：
--    iot:alarm-operation-log:query  - 查询操作记录（菜单权限）
--    iot:alarm-operation-log:export - 导出操作记录
--    iot:alarm-operation-log:delete - 删除操作记录

-- 5. 路由配置说明：
--    path: operation-log
--    component: security/PerimeterIntrusion/AlarmOperationLog/index
--    component_name: AlarmOperationLog

-- =============================================
-- 使用步骤
-- =============================================
-- 1. 确保前置条件满足：
--    - 周界入侵目录（ID=5100）已存在
--    - 报警主机菜单（ID=5101-5106）已创建

-- 2. 执行本SQL脚本创建操作记录菜单

-- 3. 清理缓存（重要！）：
--    方式1: 重启应用
--    方式2: 清理Redis缓存（如果使用了Redis）

-- 4. 在"系统管理-角色管理"中分配权限：
--    - 为需要的角色勾选"操作记录"菜单
--    - 勾选相应的按钮权限（导出、删除）

-- 5. 刷新前端页面，在"周界入侵"菜单下可以看到"操作记录"

-- =============================================
-- 权限使用说明
-- =============================================
-- 在前端页面中使用权限控制：
-- 
-- 查看菜单：v-hasPermi="['iot:alarm-operation-log:query']"
-- 导出按钮：v-hasPermi="['iot:alarm-operation-log:export']"
-- 删除按钮：v-hasPermi="['iot:alarm-operation-log:delete']"

-- =============================================
-- 回滚SQL
-- =============================================
-- 如果需要删除操作记录菜单，执行以下SQL：
/*
DELETE FROM `system_menu` WHERE `id` >= 5107 AND `id` <= 5109;
*/

-- =============================================
-- 查询验证
-- =============================================
-- 查看周界入侵模块的所有菜单：
/*
SELECT 
    id, name, permission, type, sort, parent_id, path, component
FROM `system_menu` 
WHERE (parent_id = 5100 OR id = 5100) AND `deleted` = 0
ORDER BY parent_id, sort;
*/
